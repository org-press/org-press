/**
 * Terminal Demo Section
 *
 * Features:
 * - Terminal window with macOS-style chrome
 * - Typewriter effect for command and output
 * - Demonstrates org-press dev server
 */

function sleep(ms: number): Promise<void> {
  return new Promise(resolve => setTimeout(resolve, ms));
}

async function typewrite(
  element: HTMLElement,
  text: string,
  speed: number = 50,
  startDelay: number = 0
): Promise<void> {
  await sleep(startDelay);
  element.textContent = '';

  for (const char of text) {
    element.textContent += char;
    await sleep(speed + Math.random() * 20);
  }
}

export function createTerminalDemo(): HTMLElement {
  const container = document.createElement('section');
  container.className = 'landing-section terminal-demo-section';
  container.id = 'ssg';

  container.innerHTML = `
    <div class="section-content">
      <div class="section-visual">
        <div class="terminal-window">
          <div class="terminal-header">
            <span class="terminal-dot red"></span>
            <span class="terminal-dot yellow"></span>
            <span class="terminal-dot green"></span>
            <span class="terminal-title">Terminal</span>
          </div>
          <div class="terminal-body">
            <div class="terminal-line">
              <span class="terminal-prompt">$</span>
              <span class="terminal-command" data-text="orgp dev"></span>
              <span class="terminal-cursor">|</span>
            </div>
            <div class="terminal-output">
              <div class="output-line ready" data-text=""></div>
              <div class="output-line url" data-text=""></div>
              <div class="output-line info" data-text=""></div>
            </div>
          </div>
        </div>
      </div>
      <div class="section-text">
        <span class="section-label">Static Site Generator</span>
        <h2>Document Format for Web Development</h2>
        <p>
          Org-press is a static site generator built for literate programming.
          Hot module replacement, instant preview, and production builds
          with a single command.
        </p>
        <ul class="feature-list">
          <li>Lightning-fast Vite-powered dev server</li>
          <li>TypeScript, JSX, CSS out of the box</li>
          <li>Server-side execution at build time</li>
          <li>Automatic syntax highlighting</li>
        </ul>
      </div>
    </div>
  `;

  // Start typewriter animation when section becomes visible
  let hasAnimated = false;

  const observer = new IntersectionObserver(
    (entries) => {
      for (const entry of entries) {
        if (entry.isIntersecting && !hasAnimated) {
          hasAnimated = true;
          runTerminalAnimation(container);
          observer.disconnect();
        }
      }
    },
    { threshold: 0.3 }
  );

  // Observe after a short delay to ensure DOM is ready
  requestAnimationFrame(() => {
    observer.observe(container);
  });

  return container;
}

async function runTerminalAnimation(container: HTMLElement): Promise<void> {
  const commandEl = container.querySelector('.terminal-command') as HTMLElement;
  const cursorEl = container.querySelector('.terminal-cursor') as HTMLElement;
  const readyLine = container.querySelector('.output-line.ready') as HTMLElement;
  const urlLine = container.querySelector('.output-line.url') as HTMLElement;
  const infoLine = container.querySelector('.output-line.info') as HTMLElement;

  if (!commandEl || !cursorEl) return;

  // Type the command
  await typewrite(commandEl, 'orgp dev', 80);

  // Hide cursor briefly (simulating Enter press)
  cursorEl.style.opacity = '0';
  await sleep(200);

  // Show output with staggered reveal
  cursorEl.style.display = 'none';

  await sleep(300);

  if (readyLine) {
    readyLine.textContent = '';
    readyLine.classList.add('visible');
    await typewrite(readyLine, 'Ready in 127ms', 30);
  }

  await sleep(150);

  if (urlLine) {
    urlLine.classList.add('visible');
    urlLine.innerHTML = '<span class="dim">Local:</span>   <span class="url-link">http://localhost:3000/</span>';
  }

  await sleep(100);

  if (infoLine) {
    infoLine.classList.add('visible');
    infoLine.innerHTML = '<span class="dim">press</span> <span class="key">h + enter</span> <span class="dim">to show help</span>';
  }
}

export default createTerminalDemo();
