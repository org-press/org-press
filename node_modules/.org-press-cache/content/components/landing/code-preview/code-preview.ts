/**
 * Code Preview Section
 *
 * Features:
 * - Syntax-highlighted code block visual
 * - Interactive button that fires confetti
 * - Demonstrates "code that actually runs"
 */

// Simple confetti implementation (no external dependency)
function createConfetti(originX: number, originY: number) {
  const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7', '#dfe6e9', '#fd79a8'];
  const particleCount = 80;

  for (let i = 0; i < particleCount; i++) {
    const particle = document.createElement('div');
    particle.className = 'confetti-particle';

    // Random properties
    const color = colors[Math.floor(Math.random() * colors.length)];
    const size = 6 + Math.random() * 6;
    const angle = (Math.random() * 120 - 60) * (Math.PI / 180); // -60 to 60 degrees
    const velocity = 8 + Math.random() * 8;
    const spin = (Math.random() - 0.5) * 720;

    particle.style.cssText = `
      position: fixed;
      width: ${size}px;
      height: ${size * 0.6}px;
      background: ${color};
      left: ${originX}px;
      top: ${originY}px;
      pointer-events: none;
      z-index: 9999;
      border-radius: 2px;
    `;

    document.body.appendChild(particle);

    // Animate
    let x = 0;
    let y = 0;
    let vy = -velocity * Math.sin(Math.PI / 3 + angle * 0.5);
    let vx = velocity * Math.cos(Math.PI / 3) * (Math.random() > 0.5 ? 1 : -1) * (0.5 + Math.random());
    let rotation = 0;
    let opacity = 1;
    const gravity = 0.3;
    const startTime = performance.now();

    function animateParticle() {
      const elapsed = performance.now() - startTime;
      if (elapsed > 2000 || opacity <= 0) {
        particle.remove();
        return;
      }

      vy += gravity;
      x += vx;
      y += vy;
      rotation += spin / 60;
      opacity = Math.max(0, 1 - elapsed / 2000);

      particle.style.transform = `translate(${x}px, ${y}px) rotate(${rotation}deg)`;
      particle.style.opacity = String(opacity);

      requestAnimationFrame(animateParticle);
    }

    requestAnimationFrame(animateParticle);
  }
}

export function createCodePreview(): HTMLElement {
  const container = document.createElement('section');
  container.className = 'landing-section code-preview-section';
  container.id = 'code-blocks';

  container.innerHTML = `
    <div class="section-content">
      <div class="section-text">
        <span class="section-label">Executable Code</span>
        <h2>Codeblocks with Superpowers</h2>
        <p>
          Your code blocks aren't just syntax-highlighted text.
          They execute in the browser with full TypeScript, JSX, and CSS support.
          Click the button to see it in action.
        </p>
        <div class="demo-button-area">
          <button class="confetti-btn" type="button">
            Click Me!
          </button>
        </div>
      </div>
      <div class="section-visual">
        <div class="code-block-preview">
          <div class="code-header">
            <span class="code-lang">tsx</span>
          </div>
          <pre class="code-content"><code><span class="code-keyword">#+begin_src</span> <span class="code-type">tsx</span> <span class="code-attr">:use dom</span>
<span class="code-keyword">const</span> <span class="code-var">ConfettiBtn</span> = () => (
  <span class="code-tag">&lt;button</span> <span class="code-attr">onClick</span>={<span class="code-var">fireConfetti</span>}<span class="code-tag">&gt;</span>
    Click Me!
  <span class="code-tag">&lt;/button&gt;</span>
);

<span class="code-keyword">export function</span> <span class="code-var">render</span>() { return <span class="code-tag">&lt;ConfettiBtn /&gt;</span>; }
<span class="code-keyword">#+end_src</span></code></pre>
        </div>
      </div>
    </div>
  `;

  // Attach confetti handler
  const btn = container.querySelector('.confetti-btn') as HTMLButtonElement;
  if (btn) {
    btn.addEventListener('click', (e) => {
      const rect = btn.getBoundingClientRect();
      createConfetti(
        rect.left + rect.width / 2,
        rect.top + rect.height / 2
      );
    });
  }

  return container;
}

export default createCodePreview();
