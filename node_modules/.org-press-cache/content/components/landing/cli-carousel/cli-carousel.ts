/**
 * CLI Carousel Section
 *
 * Features:
 * - Vertical list of CLI commands
 * - Scroll-linked position (slot machine effect)
 * - Highlighted command changes as you scroll
 */

const CLI_COMMANDS = [
  { cmd: 'fmt', desc: 'Format org files and code blocks' },
  { cmd: 'lint', desc: 'Check for style and syntax issues' },
  { cmd: 'test', desc: 'Run tests from code blocks' },
  { cmd: 'type-check', desc: 'TypeScript type validation' },
  { cmd: 'build', desc: 'Build for production' },
];

export function createCliCarousel(): HTMLElement {
  const container = document.createElement('section');
  container.className = 'landing-section cli-carousel-section';
  container.id = 'cli';

  const commandItems = CLI_COMMANDS.map((item, i) => `
    <div class="cli-item${i === 0 ? ' active' : ''}" data-index="${i}">
      <span class="cli-cmd">${item.cmd}</span>
      <span class="cli-desc">${item.desc}</span>
    </div>
  `).join('');

  container.innerHTML = `
    <div class="section-content">
      <div class="section-text">
        <span class="section-label">Developer Tools</span>
        <h2>Super-Charge Literate Programming</h2>
        <p>
          A complete CLI toolkit for working with org files.
          Format, lint, test, and build your literate documents
          with powerful command-line tools.
        </p>
        <div class="cli-features">
          <div class="cli-feature">
            <strong>orgp fmt</strong> - Auto-format code blocks
          </div>
          <div class="cli-feature">
            <strong>orgp test</strong> - Run inline tests with Vitest
          </div>
          <div class="cli-feature">
            <strong>orgp build</strong> - Production-ready static sites
          </div>
        </div>
      </div>
      <div class="section-visual">
        <div class="cli-window">
          <div class="cli-header">
            <span class="cli-prompt">&gt; orgp</span>
          </div>
          <div class="cli-carousel-container">
            <div class="cli-carousel">
              ${commandItems}
            </div>
            <div class="cli-highlight"></div>
          </div>
        </div>
      </div>
    </div>
  `;

  // Scroll-linked carousel
  let currentIndex = 0;

  const updateCarousel = () => {
    const rect = container.getBoundingClientRect();
    const sectionProgress = Math.max(0, Math.min(1,
      (window.innerHeight / 2 - rect.top) / rect.height
    ));

    const newIndex = Math.min(
      CLI_COMMANDS.length - 1,
      Math.floor(sectionProgress * CLI_COMMANDS.length)
    );

    if (newIndex !== currentIndex) {
      currentIndex = newIndex;

      const items = container.querySelectorAll('.cli-item');
      items.forEach((item, i) => {
        item.classList.toggle('active', i === currentIndex);
      });

      const carousel = container.querySelector('.cli-carousel') as HTMLElement;
      if (carousel) {
        const offset = -currentIndex * 52; // 52px per item (height + margin)
        carousel.style.transform = `translateY(${offset}px)`;
      }
    }
  };

  // Use passive scroll listener
  let ticking = false;
  const onScroll = () => {
    if (!ticking) {
      requestAnimationFrame(() => {
        updateCarousel();
        ticking = false;
      });
      ticking = true;
    }
  };

  window.addEventListener('scroll', onScroll, { passive: true });

  // Initial update
  requestAnimationFrame(updateCarousel);

  return container;
}

export default createCliCarousel();
