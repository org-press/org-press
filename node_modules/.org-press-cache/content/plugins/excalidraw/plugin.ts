// Source display only (not executed)
export default "/**\n * Org-Press Excalidraw Block Plugin\n *\n * Provides interactive diagram support for org-mode using Excalidraw\n */\n\nimport type {\n  BlockPlugin,\n  CodeBlock,\n  TransformContext,\n  TransformResult,\n  ApiRequest,\n  ApiResponse,\n} from \"org-press\";\nimport {\n  createBlockId,\n  parseBlockParameters,\n  registerApiRoute,\n  isEndpointRegistered,\n  dangerousWriteContentBlock,\n} from \"org-press\";\nimport path from \"node:path\";\n\n// Track if save API is registered (to avoid duplicates during HMR)\nlet saveApiRegistered = false;\n\n/**\n * Register the save API endpoint for Excalidraw\n */\nfunction registerSaveApi(): void {\n  if (saveApiRegistered) return;\n\n  if (isEndpointRegistered(\"/api/save-excalidraw\", \"POST\")) {\n    saveApiRegistered = true;\n    return;\n  }\n\n  try {\n    registerApiRoute({\n      endpoint: \"/api/save-excalidraw\",\n      method: \"POST\",\n      handler: handleSaveExcalidraw,\n      previewOnly: true,\n      sourcePath: \"@org-press/block-excalidraw\",\n      blockName: \"save-api\",\n    });\n    saveApiRegistered = true;\n  } catch (error) {\n    saveApiRegistered = true;\n  }\n}\n\n/**\n * Handle save requests from the Excalidraw wrapper\n */\nasync function handleSaveExcalidraw(req: ApiRequest, res: ApiResponse): Promise<void> {\n  try {\n    const { filePath, blockId, data } = req.body as {\n      filePath?: string;\n      blockId?: string;\n      data?: unknown;\n    };\n\n    if (!filePath) {\n      res.status(400).json({ error: \"filePath is required\" });\n      return;\n    }\n\n    if (!blockId) {\n      res.status(400).json({ error: \"blockId is required\" });\n      return;\n    }\n\n    if (!data) {\n      res.status(400).json({ error: \"data is required\" });\n      return;\n    }\n\n    const content = JSON.stringify(data, null, 2);\n\n    const result = await dangerousWriteContentBlock({\n      file: filePath,\n      block: blockId,\n      content,\n    });\n\n    if (result.success) {\n      res.json({ success: true, message: \"Diagram saved successfully\" });\n    } else {\n      res.status(500).json({ error: result.error || \"Failed to save diagram\" });\n    }\n  } catch (error: unknown) {\n    const message = error instanceof Error ? error.message : String(error);\n    console.error(\"[excalidraw-save] Error:\", message);\n    res.status(500).json({ error: message });\n  }\n}\n\n/**\n * Check if the block content is JavaScript (has imports or exports)\n */\nfunction isJavaScriptBlock(content: string, language: string): boolean {\n  if (['javascript', 'js', 'typescript', 'ts'].includes(language.toLowerCase())) {\n    return true;\n  }\n  if (content.includes('import ') || content.includes('export ')) {\n    return true;\n  }\n  return false;\n}\n\n/**\n * Excalidraw block plugin for org-press\n *\n * Supports both JSON (inline data) and JavaScript (imports) modes\n *\n * Preview API compatible:\n * - :use excalidraw -> renders interactive diagram\n * - :use excalidraw | sourceOnly -> shows source code only\n * - :use excalidraw | withSourceCode -> shows both code and diagram\n */\nexport const excalidrawPlugin: BlockPlugin = {\n  name: 'excalidraw',\n  defaultExtension: 'js',\n\n  async transform(block: CodeBlock, context: TransformContext): Promise<TransformResult> {\n    registerSaveApi();\n\n    const stableId = createBlockId(context.orgFilePath, context.blockIndex);\n    const params = parseBlockParameters(block.meta || \"\");\n\n    const useValue = params.use || 'excalidraw';\n    const useParts = useValue.split('|').map((s: string) => s.trim());\n    const mode = useParts.length > 1 ? useParts[1] : 'preview';\n\n    if (mode === 'sourceOnly') {\n      return {\n        code: `// Excalidraw diagram source (display only)\\nexport default ${JSON.stringify(block.value)};`,\n      };\n    }\n\n    const height = params.height || '500px';\n    const blockId = params.name || stableId;\n\n    const relativeFilePath = path.isAbsolute(context.orgFilePath)\n      ? path.relative(process.cwd(), context.orgFilePath)\n      : context.orgFilePath;\n\n    const isJsMode = isJavaScriptBlock(block.value, block.language);\n\n    if (isJsMode) {\n      const dataModuleId = params.name\n        ? `virtual:org-press:block:excalidraw-data:${context.orgFilePath}:NAME:${params.name}`\n        : `virtual:org-press:block:excalidraw-data:${context.orgFilePath}:${context.blockIndex}`;\n\n      return {\n        code: `\nimport renderExcalidraw from '@org-press/block-excalidraw/wrapper';\n\nexport default function render(containerId) {\n  const container = document.getElementById(containerId);\n  if (!container) {\n    console.error('[Excalidraw] Container not found:', containerId);\n    return;\n  }\n\n  container.className = 'excalidraw-wrapper';\n  container.style.cssText = 'position: relative; height: ${height};';\n\n  import('${dataModuleId}').then((module) => {\n    try {\n      const data = module.default;\n      const mode = 'view';\n      const filePath = undefined;\n      const blockId = '${blockId}';\n\n      renderExcalidraw(container, data, mode, filePath, blockId);\n    } catch (err) {\n      console.error('[Excalidraw] Failed to render diagram:', err);\n      container.innerHTML = '<div style=\"color: red; padding: 1rem; border: 1px solid red;\">Error rendering Excalidraw diagram: ' + err.message + '</div>';\n    }\n  }).catch(err => {\n    console.error('[Excalidraw] Failed to load data module:', err);\n    container.innerHTML = '<div style=\"color: red; padding: 1rem; border: 1px solid red;\">Error loading Excalidraw data: ' + err.message + '</div>';\n  });\n}\n        `,\n      };\n    } else {\n      const excalidrawData = block.value;\n\n      return {\n        code: `\nimport renderExcalidraw from '@org-press/block-excalidraw/wrapper';\n\nexport default function render(containerId) {\n  const container = document.getElementById(containerId);\n  if (!container) {\n    console.error('[Excalidraw] Container not found:', containerId);\n    return;\n  }\n\n  container.className = 'excalidraw-wrapper';\n  container.style.cssText = 'position: relative; height: ${height};';\n\n  try {\n    const data = ${excalidrawData};\n    const mode = 'view';\n    const filePath = undefined;\n    const blockId = '${blockId}';\n\n    renderExcalidraw(container, data, mode, filePath, blockId);\n  } catch (err) {\n    console.error('[Excalidraw] Failed to render diagram:', err);\n    container.innerHTML = '<div style=\"color: red; padding: 1rem; border: 1px solid red;\">Error rendering Excalidraw diagram: ' + err.message + '</div>';\n  }\n}\n        `,\n      };\n    }\n  },\n};\n\n// Default export for convenience\nexport default excalidrawPlugin;\n";