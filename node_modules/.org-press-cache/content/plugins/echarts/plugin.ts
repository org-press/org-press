// Source display only (not executed)
export default "import type {\n  BlockPlugin,\n  CodeBlock,\n  TransformContext,\n  TransformResult,\n} from \"org-press\";\nimport { createBlockId, parseBlockParameters } from \"org-press\";\n\n/**\n * Check if the block content is JavaScript (has imports or exports)\n */\nfunction isJavaScriptBlock(content: string, language: string): boolean {\n  // Explicit JavaScript language\n  if (['javascript', 'js', 'typescript', 'ts'].includes(language.toLowerCase())) {\n    return true;\n  }\n  // JSON with import/export statements (user wants JS mode)\n  if (content.includes('import ') || content.includes('export ')) {\n    return true;\n  }\n  return false;\n}\n\n/**\n * Generate the render function code for ECharts\n */\nfunction generateRenderCode(options: {\n  containerId: string;\n  height: string;\n  theme: string;\n  renderer: string;\n  dataCode: string;\n  isModule: boolean;\n  moduleId?: string;\n}): string {\n  const { height, theme, renderer, dataCode, isModule, moduleId } = options;\n\n  const initCode = isModule\n    ? `import('${moduleId}').then((module) => {\n        try {\n          initChart(module.default);\n        } catch (err) {\n          showError(err);\n        }\n      }).catch(showError);`\n    : `try {\n        const chartOption = ${dataCode};\n        initChart(chartOption);\n      } catch (err) {\n        showError(err);\n      }`;\n\n  return `\nimport * as echarts from 'echarts';\n\n// Track chart instances for cleanup\nconst chartRegistry = new Map();\n\n// Export render function - exporter will call this with container ID\nexport default function render(containerId) {\n  const container = document.getElementById(containerId);\n  if (!container) {\n    console.error('[ECharts] Container not found:', containerId);\n    return;\n  }\n\n  // Style the container\n  container.className = 'echarts-wrapper';\n  container.style.cssText = 'position: relative; width: 100%; height: ${height};';\n\n  // Create inner container for chart\n  const chartContainer = document.createElement('div');\n  chartContainer.style.cssText = 'width: 100%; height: 100%;';\n  container.appendChild(chartContainer);\n\n  function showError(err) {\n    console.error('[ECharts] Failed to render chart:', err);\n    container.innerHTML = '<div style=\"color: red; padding: 1rem; border: 1px solid red;\">Error rendering chart: ' + (err.message || err) + '</div>';\n  }\n\n  function initChart(chartOption) {\n    // Dispose existing chart if any (for HMR)\n    if (chartRegistry.has(containerId)) {\n      chartRegistry.get(containerId).dispose();\n    }\n\n    // Initialize ECharts\n    const chart = echarts.init(chartContainer, '${theme}', {\n      renderer: '${renderer}',\n    });\n\n    // Set option\n    chart.setOption(chartOption);\n\n    // Handle resize\n    const resizeObserver = new ResizeObserver(() => {\n      chart.resize();\n    });\n    resizeObserver.observe(container);\n\n    // Also handle window resize for containers that don't trigger ResizeObserver\n    const handleResize = () => chart.resize();\n    window.addEventListener('resize', handleResize);\n\n    // Store for cleanup\n    chartRegistry.set(containerId, chart);\n\n    // Cleanup on navigation (for SPA)\n    const cleanup = () => {\n      resizeObserver.disconnect();\n      window.removeEventListener('resize', handleResize);\n      chart.dispose();\n      chartRegistry.delete(containerId);\n    };\n\n    // Watch for container removal (works with most SPA routers)\n    const observer = new MutationObserver((mutations) => {\n      for (const mutation of mutations) {\n        for (const removed of mutation.removedNodes) {\n          if (removed === container || (removed instanceof Element && removed.contains(container))) {\n            cleanup();\n            observer.disconnect();\n            return;\n          }\n        }\n      }\n    });\n\n    if (container.parentElement) {\n      observer.observe(container.parentElement, { childList: true, subtree: true });\n    }\n  }\n\n  ${initCode}\n}\n`;\n}\n\n/**\n * ECharts block plugin for org-press\n *\n * Supports both JSON (inline data) and JavaScript (imports) modes\n *\n * Preview API compatible:\n * - :use echarts -> renders interactive chart\n * - :use echarts | sourceOnly -> shows source code only\n * - :use echarts | withSourceCode -> shows both code and chart\n */\nexport const echartsPlugin: BlockPlugin = {\n  name: 'echarts',\n  defaultExtension: 'js',\n\n  /**\n   * Transform returns code that renders the ECharts chart\n   * - JSON mode: embeds data directly\n   * - JS mode: imports data from a separate virtual module (supports imports)\n   */\n  async transform(block: CodeBlock, context: TransformContext): Promise<TransformResult> {\n    // Create stable ID for this block using utility\n    const stableId = createBlockId(context.orgFilePath, context.blockIndex);\n\n    // Parse block parameters\n    const params = parseBlockParameters(block.meta || \"\");\n\n    // Check for mode from :use parameter (e.g., :use echarts | sourceOnly)\n    const useValue = params.use || 'echarts';\n    const useParts = useValue.split('|').map((s: string) => s.trim());\n    const mode = useParts.length > 1 ? useParts[1] : 'preview';\n\n    // Handle sourceOnly mode - just return the source code\n    if (mode === 'sourceOnly') {\n      return {\n        code: `// ECharts configuration source (display only)\\nexport default ${JSON.stringify(block.value)};`,\n      };\n    }\n\n    // Get parameters with defaults\n    const height = params.height || '400px';\n    const theme = params.theme || 'light';\n    const renderer = params.renderer || 'canvas';\n\n    // Check if this is JavaScript mode (has imports)\n    const isJsMode = isJavaScriptBlock(block.value, block.language);\n\n    if (isJsMode) {\n      // JavaScript mode: import data from a virtual module\n      // The virtual-blocks plugin will serve the user's code as a module\n      const dataModuleId = params.name\n        ? `virtual:org-press:block:echarts-data:${context.orgFilePath}:NAME:${params.name}`\n        : `virtual:org-press:block:echarts-data:${context.orgFilePath}:${context.blockIndex}`;\n\n      return {\n        code: generateRenderCode({\n          containerId: stableId,\n          height,\n          theme,\n          renderer,\n          dataCode: '',\n          isModule: true,\n          moduleId: dataModuleId,\n        }),\n      };\n    } else {\n      // JSON mode: embed data directly\n      return {\n        code: generateRenderCode({\n          containerId: stableId,\n          height,\n          theme,\n          renderer,\n          dataCode: block.value,\n          isModule: false,\n        }),\n      };\n    }\n  },\n};\n\n// Default export for convenience\nexport default echartsPlugin;\n";