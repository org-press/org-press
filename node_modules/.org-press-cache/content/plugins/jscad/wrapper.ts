// Source display only (not executed)
export default "// CommonJS imports - @jscad packages are CJS\nimport reglRenderer from \"@jscad/regl-renderer\";\nconst { prepareRender, drawCommands, cameras, controls, entitiesFromSolids } = reglRenderer;\n\nimport jscadModeling from \"@jscad/modeling\";\nconst { geometries } = jscadModeling;\n\n// Inline CSS styles\nconst wrapperStyles = `\n.jscad-wrapper {\n  position: relative;\n  width: 100%;\n  height: 400px;\n  margin: 1rem 0;\n  border-radius: 8px;\n  overflow: hidden;\n}\n`;\n\n// Inject styles once\nlet stylesInjected = false;\nfunction injectStyles() {\n  if (stylesInjected) return;\n  const style = document.createElement('style');\n  style.textContent = wrapperStyles;\n  document.head.appendChild(style);\n  stylesInjected = true;\n}\n\ninterface CameraState {\n  position: number[];\n  target: number[];\n}\n\nexport default function (\n  containerElement: HTMLElement,\n  solidsOrFunction: any[] | Function\n) {\n  // Inject CSS styles\n  injectStyles();\n\n  // Clear container to handle HMR properly\n  containerElement.innerHTML = \"\";\n\n  const perspectiveCamera = cameras.perspective;\n  const orbitControls = controls.orbit;\n\n  const width = containerElement.clientWidth;\n  const height = containerElement.clientHeight;\n\n  const state: any = {};\n\n  // Use stable storage key from data attribute (doesn't change with content)\n  const storageKeyBase =\n    containerElement.getAttribute(\"data-storage-key\") || containerElement.id;\n  const storageKey = storageKeyBase\n    ? `jscad-camera-${storageKeyBase}`\n    : `jscad-camera-${Date.now()}`;\n\n  // Try to load saved camera state\n  let savedCameraState: CameraState | null = null;\n  try {\n    const saved = localStorage.getItem(storageKey);\n    if (saved) {\n      savedCameraState = JSON.parse(saved);\n    }\n  } catch (e) {\n    console.warn(\"Failed to load saved camera state:\", e);\n  }\n\n  // Prepare the camera\n  state.camera = Object.assign({}, perspectiveCamera.defaults);\n\n  // Apply saved camera state if available\n  if (savedCameraState) {\n    state.camera.position = savedCameraState.position;\n    state.camera.target = savedCameraState.target;\n  }\n\n  // Store initial camera state for reset functionality\n  const initialCameraState: CameraState = {\n    position: [...state.camera.position],\n    target: [...state.camera.target],\n  };\n\n  perspectiveCamera.setProjection(state.camera, state.camera, {\n    width,\n    height,\n  });\n  perspectiveCamera.update(state.camera, state.camera);\n\n  // Prepare the controls\n  state.controls = orbitControls.defaults;\n\n  // Create UI controls panel\n  const controlsPanel = document.createElement(\"div\");\n  controlsPanel.setAttribute(\"data-jscad-controls\", \"true\");\n  controlsPanel.style.cssText = `\n    position: absolute;\n    top: 10px;\n    right: 10px;\n    z-index: 9999;\n    display: flex;\n    flex-direction: column;\n    gap: 8px;\n    padding: 10px;\n    background: rgba(255, 255, 255, 0.95);\n    border-radius: 4px;\n    box-shadow: 0 2px 8px rgba(0,0,0,0.3);\n    pointer-events: auto;\n  `;\n\n  // Fullscreen button\n  const fullscreenBtn = document.createElement(\"button\");\n  fullscreenBtn.setAttribute(\"data-jscad-fullscreen\", \"true\");\n  fullscreenBtn.textContent = \"⛶ Fullscreen\";\n  fullscreenBtn.style.cssText = `\n    padding: 6px 12px;\n    cursor: pointer;\n    border: 1px solid #ccc;\n    border-radius: 3px;\n    background: white;\n  `;\n  fullscreenBtn.onclick = () => {\n    if (containerElement.requestFullscreen) {\n      containerElement.requestFullscreen();\n    }\n  };\n  controlsPanel.appendChild(fullscreenBtn);\n\n  // Download STL button\n  const downloadBtn = document.createElement(\"button\");\n  downloadBtn.setAttribute(\"data-jscad-download\", \"true\");\n  downloadBtn.textContent = \"↓ Download STL\";\n  downloadBtn.style.cssText = `\n    padding: 6px 12px;\n    cursor: pointer;\n    border: 1px solid #ccc;\n    border-radius: 3px;\n    background: white;\n  `;\n  controlsPanel.appendChild(downloadBtn);\n\n  // Clear camera button\n  const clearCameraBtn = document.createElement(\"button\");\n  clearCameraBtn.setAttribute(\"data-jscad-clear-camera\", \"true\");\n  clearCameraBtn.textContent = \"↻ Reset Camera\";\n  clearCameraBtn.style.cssText = `\n    padding: 6px 12px;\n    cursor: pointer;\n    border: 1px solid #ccc;\n    border-radius: 3px;\n    background: white;\n    display: none;\n  `;\n  clearCameraBtn.onclick = () => {\n    resetCamera();\n  };\n  controlsPanel.appendChild(clearCameraBtn);\n\n  // Autosave checkbox\n  const autosaveLabel = document.createElement(\"label\");\n  autosaveLabel.style.cssText = `\n    display: flex;\n    align-items: center;\n    gap: 6px;\n    font-size: 14px;\n    cursor: pointer;\n  `;\n\n  const autosaveCheckbox = document.createElement(\"input\");\n  autosaveCheckbox.type = \"checkbox\";\n  autosaveCheckbox.checked = true;\n  autosaveCheckbox.setAttribute(\"data-jscad-autosave\", \"true\");\n  autosaveCheckbox.style.cursor = \"pointer\";\n\n  const autosaveText = document.createTextNode(\"Auto-save camera\");\n  autosaveLabel.appendChild(autosaveCheckbox);\n  autosaveLabel.appendChild(autosaveText);\n  controlsPanel.appendChild(autosaveLabel);\n\n  containerElement.appendChild(controlsPanel);\n\n  // Prepare the renderer\n  const setupOptions = {\n    glOptions: { container: containerElement },\n  };\n  const renderer = prepareRender(setupOptions);\n\n  const gridOptions = {\n    visuals: {\n      drawCmd: \"drawGrid\",\n      show: true,\n    },\n    size: [500, 500],\n    ticks: [25, 5],\n  };\n\n  const axisOptions = {\n    visuals: {\n      drawCmd: \"drawAxis\",\n      show: true,\n    },\n    size: 300,\n  };\n\n  // Support both array of solids and function that returns solids\n  const solids = Array.isArray(solidsOrFunction)\n    ? solidsOrFunction\n    : solidsOrFunction({ scale: 1 });\n\n  const entities = entitiesFromSolids({}, solids);\n\n  // Set up the download button handler\n  downloadBtn.onclick = () => {\n    downloadSTL(solids);\n  };\n\n  // Assemble the options for rendering\n  const renderOptions = {\n    camera: state.camera,\n    drawCommands: {\n      drawAxis: drawCommands.drawAxis,\n      drawGrid: drawCommands.drawGrid,\n      drawLines: drawCommands.drawLines,\n      drawMesh: drawCommands.drawMesh,\n    },\n    entities: [gridOptions, axisOptions, ...entities],\n  };\n\n  // Save camera position to localStorage\n  function saveCameraState() {\n    if (!autosaveCheckbox.checked) return;\n\n    const cameraState: CameraState = {\n      position: [...state.camera.position],\n      target: [...state.camera.target],\n    };\n    localStorage.setItem(storageKey, JSON.stringify(cameraState));\n  }\n\n  // Check if camera has moved from initial position\n  function isCameraAtInitialPosition(): boolean {\n    const posEqual =\n      state.camera.position[0] === initialCameraState.position[0] &&\n      state.camera.position[1] === initialCameraState.position[1] &&\n      state.camera.position[2] === initialCameraState.position[2];\n\n    const targetEqual =\n      state.camera.target[0] === initialCameraState.target[0] &&\n      state.camera.target[1] === initialCameraState.target[1] &&\n      state.camera.target[2] === initialCameraState.target[2];\n\n    return posEqual && targetEqual;\n  }\n\n  // Update clear button visibility based on camera position\n  function updateClearButtonVisibility() {\n    clearCameraBtn.style.display = isCameraAtInitialPosition() ? \"none\" : \"block\";\n  }\n\n  // Reset camera to initial position\n  function resetCamera() {\n    state.camera.position = [...initialCameraState.position];\n    state.camera.target = [...initialCameraState.target];\n    perspectiveCamera.update(state.camera);\n    updateView = true;\n    updateClearButtonVisibility();\n    saveCameraState();\n  }\n\n  // Download solids as STL\n  function downloadSTL(solids: any[]) {\n    try {\n      const stlString = solidsToSTL(solids);\n      const blob = new Blob([stlString], { type: \"text/plain\" });\n      const url = URL.createObjectURL(blob);\n\n      const a = document.createElement(\"a\");\n      a.href = url;\n      a.download = \"model.stl\";\n      document.body.appendChild(a);\n      a.click();\n      document.body.removeChild(a);\n      URL.revokeObjectURL(url);\n    } catch (e) {\n      console.error(\"Failed to download STL:\", e);\n      alert(\"Failed to download STL. Make sure the model is valid.\");\n    }\n  }\n\n  // Convert JSCAD solids to STL format\n  function solidsToSTL(solids: any[]): string {\n    let stl = \"solid model\\n\";\n\n    for (const solid of solids) {\n      const polygons = geometries.geom3.toPolygons(solid);\n\n      for (const polygon of polygons) {\n        const vertices = polygon.vertices;\n\n        // Calculate normal\n        const v1 = vertices[0];\n        const v2 = vertices[1];\n        const v3 = vertices[2];\n\n        const u = [v2[0] - v1[0], v2[1] - v1[1], v2[2] - v1[2]];\n        const v = [v3[0] - v1[0], v3[1] - v1[1], v3[2] - v1[2]];\n\n        const normal = [\n          u[1] * v[2] - u[2] * v[1],\n          u[2] * v[0] - u[0] * v[2],\n          u[0] * v[1] - u[1] * v[0],\n        ];\n\n        // Normalize\n        const len = Math.sqrt(\n          normal[0] * normal[0] + normal[1] * normal[1] + normal[2] * normal[2]\n        );\n        normal[0] /= len;\n        normal[1] /= len;\n        normal[2] /= len;\n\n        stl += `  facet normal ${normal[0]} ${normal[1]} ${normal[2]}\\n`;\n        stl += `    outer loop\\n`;\n\n        for (const vertex of vertices) {\n          stl += `      vertex ${vertex[0]} ${vertex[1]} ${vertex[2]}\\n`;\n        }\n\n        stl += `    endloop\\n`;\n        stl += `  endfacet\\n`;\n      }\n    }\n\n    stl += \"endsolid model\\n\";\n    return stl;\n  }\n\n  // Update clear button visibility based on initial camera state\n  updateClearButtonVisibility();\n\n  // The heart of rendering\n  let updateView = true;\n\n  const rotateSpeed = 0.002;\n  const panSpeed = 1;\n  const zoomSpeed = 0.08;\n  let rotateDelta = [0, 0];\n  let panDelta = [0, 0];\n  let zoomDelta = 0;\n  let pointerDown = false;\n  let lastX = 0;\n  let lastY = 0;\n\n  const doRotatePanZoom = () => {\n    if (rotateDelta[0] || rotateDelta[1]) {\n      const updated = orbitControls.rotate(\n        { controls: state.controls, camera: state.camera, speed: rotateSpeed },\n        rotateDelta\n      );\n      state.controls = { ...state.controls, ...updated.controls };\n      updateView = true;\n      rotateDelta = [0, 0];\n    }\n\n    if (panDelta[0] || panDelta[1]) {\n      const updated = orbitControls.pan(\n        { controls: state.controls, camera: state.camera, speed: panSpeed },\n        panDelta\n      );\n      state.controls = { ...state.controls, ...updated.controls };\n      panDelta = [0, 0];\n      state.camera.position = updated.camera.position;\n      state.camera.target = updated.camera.target;\n      updateView = true;\n    }\n\n    if (zoomDelta) {\n      const updated = orbitControls.zoom(\n        { controls: state.controls, camera: state.camera, speed: zoomSpeed },\n        zoomDelta\n      );\n      state.controls = { ...state.controls, ...updated.controls };\n      zoomDelta = 0;\n      updateView = true;\n    }\n  };\n\n  const updateAndRender = (timestamp: number) => {\n    doRotatePanZoom();\n\n    if (updateView) {\n      const updates = orbitControls.update({\n        controls: state.controls,\n        camera: state.camera,\n      });\n      state.controls = { ...state.controls, ...updates.controls };\n      updateView = state.controls.changed;\n\n      state.camera.position = updates.camera.position;\n      perspectiveCamera.update(state.camera);\n\n      renderer(renderOptions);\n\n      saveCameraState();\n      updateClearButtonVisibility();\n    }\n    window.requestAnimationFrame(updateAndRender);\n  };\n  window.requestAnimationFrame(updateAndRender);\n\n  // Event handlers for mouse/touch interaction\n  const moveHandler = (ev: PointerEvent) => {\n    if (!pointerDown) return;\n\n    const target = ev.target as HTMLElement;\n    if (target.closest('[data-jscad-controls]')) {\n      return;\n    }\n\n    const dx = lastX - ev.pageX;\n    const dy = ev.pageY - lastY;\n\n    const shiftKey =\n      ev.shiftKey === true || ((ev as any).touches && (ev as any).touches.length > 2);\n    if (shiftKey) {\n      panDelta[0] += dx;\n      panDelta[1] += dy;\n    } else {\n      rotateDelta[0] -= dx;\n      rotateDelta[1] -= dy;\n    }\n\n    lastX = ev.pageX;\n    lastY = ev.pageY;\n\n    ev.preventDefault();\n  };\n\n  const downHandler = (ev: PointerEvent) => {\n    const target = ev.target as HTMLElement;\n    if (target.closest('[data-jscad-controls]')) {\n      return;\n    }\n\n    pointerDown = true;\n    lastX = ev.pageX;\n    lastY = ev.pageY;\n    containerElement.setPointerCapture(ev.pointerId);\n  };\n\n  const upHandler = (ev: PointerEvent) => {\n    pointerDown = false;\n    const target = ev.target as HTMLElement;\n    if (!target.closest('[data-jscad-controls]')) {\n      containerElement.releasePointerCapture(ev.pointerId);\n    }\n  };\n\n  const wheelHandler = (ev: WheelEvent) => {\n    zoomDelta += ev.deltaY;\n    ev.preventDefault();\n  };\n\n  containerElement.onpointermove = moveHandler;\n  containerElement.onpointerdown = downHandler;\n  containerElement.onpointerup = upHandler;\n  containerElement.onwheel = wheelHandler;\n}\n";