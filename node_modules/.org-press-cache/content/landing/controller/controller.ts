/**
 * Landing Page Controller
 *
 * Responsibilities:
 * - Initialize 3D sphere grid background
 * - Handle scroll-based formation switching
 * - Compose all section components
 */

// Import styles (auto-injected into head)
import './styles.org?name=landing-styles';

// Import 3D background (desktop)
import { createSphereGridBackground, SphereGridController } from './three/sphere-grid.org?name=sphere-grid';

// Import 2D canvas (mobile)
import { createMobileCanvas } from './mobile-canvas.org?name=mobile-canvas';

// Import section components
import { createHero } from './sections/hero.org?name=hero';
import { createCodePreview } from './sections/code-preview.org?name=code-preview';
import { createTerminal } from './sections/terminal.org?name=terminal';
import { createCommunity } from './sections/community.org?name=community';
import { createCarousel } from './sections/carousel.org?name=carousel';
import { createAiChat } from './sections/ai-chat.org?name=ai-chat';
import { createLinks } from './sections/links.org?name=links';

/**
 * Create the complete landing page
 */
export function createLandingPage(): HTMLElement {
  // Create main container
  const container = document.createElement('div');
  container.className = 'landing-page';

  // Create 3D background container
  const bgContainer = document.createElement('div');
  bgContainer.id = 'sphere-grid-container';
  container.appendChild(bgContainer);

  // Create content layer
  const content = document.createElement('div');
  content.className = 'landing-content';
  container.appendChild(content);

  // Add all sections
  const hero = createHero();
  const codePreview = createCodePreview();
  const terminal = createTerminal();
  const community = createCommunity();
  const carousel = createCarousel();
  const aiChat = createAiChat();
  const links = createLinks();

  content.appendChild(hero);
  content.appendChild(codePreview);
  content.appendChild(terminal);
  content.appendChild(community);
  content.appendChild(carousel);
  content.appendChild(aiChat);
  content.appendChild(links);

  // Initialize 3D background after DOM is ready
  requestAnimationFrame(() => {
    initializeBackground(container, bgContainer, hero, codePreview, terminal, community, carousel, aiChat);
  });

  return container;
}

/**
 * Initialize the 3D sphere grid background and scroll handling
 */
function initializeBackground(
  container: HTMLElement,
  bgContainer: HTMLElement,
  hero: HTMLElement,
  codePreview: HTMLElement,
  terminal: HTMLElement,
  community: HTMLElement,
  carousel: HTMLElement,
  aiChat: HTMLElement
) {
  const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  if (prefersReducedMotion) {
    // Skip background animation for accessibility
    return;
  }

  const isMobile = window.innerWidth <= 1024; // Include tablets
  const prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;

  // Create appropriate background based on device
  let setFormation: (formation: string) => void;

  if (isMobile) {
    // Mobile: 2D canvas animation
    const mobileCanvas = createMobileCanvas(bgContainer);
    setFormation = mobileCanvas.setFormation;
  } else {
    // Desktop: full 3D WebGL animation
    const sphereGrid = createSphereGridBackground(bgContainer, {
      gridCols: 140,
      gridRows: 100,
      sphereRadius: 0.08,
      spacing: 0.4,
      backgroundColor: prefersDarkMode ? 0x0a0a0f : 0xf5f5f7,
      sphereColor: prefersDarkMode ? 0x999999 : 0x777777,
    });
    sphereGrid.setText('ORG-PRESS');
    setFormation = sphereGrid.setFormation;
  }

  // Scroll-based formation switching (shared for both mobile and desktop)
  function updateFormationOnScroll() {
    const heroRect = hero.getBoundingClientRect();
    const codeRect = codePreview.getBoundingClientRect();
    const ssgRect = terminal.getBoundingClientRect();
    const communityRect = community.getBoundingClientRect();
    const cliRect = carousel.getBoundingClientRect();
    const aiRect = aiChat.getBoundingClientRect();

    const viewportCenter = window.innerHeight / 2;

    if (heroRect.bottom > viewportCenter) {
      setFormation('grid');
    } else if (aiRect.top < viewportCenter) {
      setFormation('warp');
    } else if (cliRect.top < viewportCenter) {
      setFormation('prism');
    } else if (communityRect.top < viewportCenter) {
      setFormation('globe');
    } else if (ssgRect.top < viewportCenter) {
      setFormation('pipeline');
    } else if (codeRect.top < viewportCenter) {
      setFormation('cube');
    } else {
      const transitionProgress = 1 - (heroRect.bottom / viewportCenter);
      setFormation(transitionProgress > 0.5 ? 'cube' : 'grid');
    }
  }

  let scrollTicking = false;
  window.addEventListener('scroll', () => {
    if (!scrollTicking) {
      requestAnimationFrame(() => {
        updateFormationOnScroll();
        scrollTicking = false;
      });
      scrollTicking = true;
    }
  }, { passive: true });

  updateFormationOnScroll();
}

export default createLandingPage();
