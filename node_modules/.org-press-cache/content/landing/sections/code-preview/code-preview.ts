/**
 * Code Preview Section
 *
 * Features:
 * - Tabbed code examples (React vs DOM)
 * - Live counter button demo (matches the displayed code)
 * - Syntax-highlighted code preview
 */

export function createCodePreview(): HTMLElement {
  const section = document.createElement('section');
  section.className = 'landing-section code-preview-section';
  section.id = 'code-blocks';

  // Counter state
  let count = 0;
  const colors = ['#ff6b6b', '#4ecdc4', '#ffe66d', '#95e1d3'];

  section.innerHTML = `
    <div class="section-content">
      <div class="section-text">
        <span class="section-label">Executable Code</span>
        <h2>Codeblocks with Superpowers</h2>
        <p>
          Your code blocks aren't just syntax-highlighted text.
          They execute in the browser with full TypeScript, JSX, and CSS support.
          Click the button to see it in action.
        </p>
        <div class="demo-button-area">
          <button class="counter-btn" type="button" id="counter-trigger">
            Clicked 0 times
          </button>
        </div>
      </div>
      <div class="section-visual">
        <div class="code-block-preview code-tabs-container">
          <div class="code-tabs">
            <button class="code-tab active" data-tab="react">:use react</button>
            <button class="code-tab" data-tab="dom">:use dom</button>
          </div>
          <div class="code-tab-content active" data-content="react">
            <pre class="code-content"><code><span class="code-keyword">#+begin_src</span> <span class="code-type">tsx</span> <span class="code-attr">:use react</span>
<span class="code-keyword">import</span> { useState } <span class="code-keyword">from</span> <span class="code-string">'react'</span>;

<span class="code-keyword">export function</span> <span class="code-var">render</span>() {
  <span class="code-keyword">const</span> [count, setCount] = useState(<span class="code-number">0</span>);
  <span class="code-keyword">return</span> (
    <span class="code-tag">&lt;button</span> <span class="code-attr">onClick</span>={() => setCount(c => c + <span class="code-number">1</span>)}<span class="code-tag">&gt;</span>
      Clicked {count} times
    <span class="code-tag">&lt;/button&gt;</span>
  );
}
<span class="code-keyword">#+end_src</span></code></pre>
          </div>
          <div class="code-tab-content" data-content="dom">
            <pre class="code-content"><code><span class="code-keyword">#+begin_src</span> <span class="code-type">typescript</span> <span class="code-attr">:use dom</span>
<span class="code-keyword">let</span> count = <span class="code-number">0</span>;
<span class="code-keyword">const</span> btn = document.createElement(<span class="code-string">'button'</span>);
btn.textContent = <span class="code-string">'Clicked '</span> + count + <span class="code-string">' times'</span>;
btn.onclick = () => {
  count++;
  btn.textContent = <span class="code-string">'Clicked '</span> + count + <span class="code-string">' times'</span>;
};

<span class="code-keyword">export function</span> <span class="code-var">render</span>() { <span class="code-keyword">return</span> btn; }
<span class="code-keyword">#+end_src</span></code></pre>
          </div>
        </div>
      </div>
    </div>
  `;

  // Set up interactions
  requestAnimationFrame(() => {
    // Counter button - matches the displayed code examples
    const counterBtn = section.querySelector('#counter-trigger') as HTMLButtonElement;
    if (counterBtn) {
      counterBtn.addEventListener('click', () => {
        count++;
        counterBtn.textContent = `Clicked ${count} times`;
        counterBtn.style.background = colors[count % colors.length];
      });
    }

    // Code tabs switching
    const codeTabs = section.querySelectorAll('.code-tab');
    codeTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const tabId = tab.getAttribute('data-tab');
        const tabsContainer = tab.closest('.code-tabs-container');
        if (!tabsContainer || !tabId) return;

        // Update active tab
        tabsContainer.querySelectorAll('.code-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        // Update active content
        tabsContainer.querySelectorAll('.code-tab-content').forEach(c => c.classList.remove('active'));
        const content = tabsContainer.querySelector(`[data-content="${tabId}"]`);
        if (content) content.classList.add('active');
      });
    });
  });

  return section;
}

export default createCodePreview();
