<!DOCTYPE html>
<html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>Halftone Spheres | org-press</title><meta name="description" content="3D halftone effect using Three.js spheres"/><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script><script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/github.min.css" media="(prefers-color-scheme: light)"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/github-dark.min.css" media="(prefers-color-scheme: dark)"/><script>
          // Register org-mode language for highlight.js
          if (typeof hljs !== 'undefined') {
            hljs.registerLanguage('org', function(hljs) {
              return {
                name: 'Org',
                aliases: ['org', 'org-mode', 'orgmode'],
                case_insensitive: true,
                contains: [
                  // Headlines
                  {
                    className: 'section',
                    begin: /^\*+\s/,
                    end: /$/,
                    contains: [
                      { className: 'keyword', begin: /\b(TODO|DONE|WAITING|CANCELLED|NEXT|HOLD)\b/ }
                    ]
                  },
                  // Keywords (#+KEYWORD:)
                  {
                    className: 'meta',
                    begin: /^#\+[A-Za-z_]+:/,
                    end: /$/,
                    contains: [{ className: 'string', begin: /\s/, end: /$/ }]
                  },
                  // Begin/end blocks
                  { className: 'keyword', begin: /^#\+(begin|end)_[a-z]+/i, relevance: 10 },
                  // Property drawers
                  { className: 'attribute', begin: /^:\w+:/, end: /$/ },
                  // Links [[url][description]]
                  {
                    className: 'link',
                    begin: /\[\[/,
                    end: /\]\]/,
                    contains: [{ className: 'string', begin: /\]\[/, end: /(?=\]\])/ }]
                  },
                  // Comments (lines starting with #, but not #+)
                  { className: 'comment', begin: /^#[^+]/, end: /$/ },
                  // Timestamps
                  { className: 'number', begin: /<\d{4}-\d{2}-\d{2}/, end: />/ },
                  // Tags :tag1:tag2:
                  { className: 'tag', begin: /\s:[a-zA-Z0-9_@#%:]+:\s*$/ }
                ]
              };
            });
            // Run highlighting after DOM is ready
            document.addEventListener('DOMContentLoaded', function() {
              hljs.highlightAll();
            });
          }
        </script><script>
          (function() {
            // Set current path as data attribute for CSS styling
            document.documentElement.dataset.path = window.location.pathname;

            // Mobile menu toggle using event delegation
            document.addEventListener('click', function(e) {
              var button = e.target.closest('.mobile-menu-button');
              if (button) {
                e.stopPropagation();
                document.body.classList.toggle('mobile-menu-open');
                return;
              }
              // Close menu when clicking a link inside the menu
              var menuLink = e.target.closest('.mobile-menu a');
              if (menuLink) {
                document.body.classList.remove('mobile-menu-open');
                return;
              }
              // Close menu when clicking outside
              if (document.body.classList.contains('mobile-menu-open')) {
                var menu = document.querySelector('.mobile-menu');
                if (menu && !menu.contains(e.target)) {
                  document.body.classList.remove('mobile-menu-open');
                }
              }
            });

            // Highlight current page in navigation
            document.addEventListener('DOMContentLoaded', function() {
              var path = window.location.pathname;
              // Highlight sidebar links
              document.querySelectorAll('.sidebar-link').forEach(function(link) {
                if (link.getAttribute('href') === path) {
                  link.classList.add('active');
                  link.closest('.sidebar-item')?.classList.add('active');
                }
              });
              // Highlight top nav links
              document.querySelectorAll('.top-nav-link').forEach(function(link) {
                var href = link.getAttribute('href');
                var match = link.dataset.match;
                if (path === href || (match && path.startsWith(match))) {
                  link.classList.add('active');
                }
              });
            });
          })();
        </script><link rel="stylesheet" href="/assets/theme-DsForQV0.css"/><script type="module" src="/assets/entry-client-l0sNRNKZ.js"></script></head><body><div class="docs-layout"><header class="top-nav"><div class="top-nav-container"><a href="/index.html" class="top-nav-logo"><span class="logo-text">Org-Press</span></a><nav class="top-nav-links"><a href="/guide/index.html" class="top-nav-link " data-match="^\/(guide(\/|$)|getting-started|index\.html$)">Guide</a><a href="/config/index.html" class="top-nav-link " data-match="^\/config(\/|$)">Config</a><a href="/plugins/index.html" class="top-nav-link " data-match="^\/plugins(\/|$)">Plugins</a><a href="/api/index.html" class="top-nav-link " data-match="^\/api(\/|$)">API</a></nav><div class="top-nav-social"><a href="https://github.com/org-press/org-press/blob/main/docs/content/components/halftone-spheres.org?plain=1" class="top-nav-source-link" target="_blank" rel="noopener noreferrer" title="View page source on GitHub">:view-source</a><a href="https://github.com/org-press/org-press" class="top-nav-social-link" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg></a></div><button class="mobile-menu-button" aria-label="Toggle navigation menu" aria-expanded="false"><span class="hamburger-line"></span><span class="hamburger-line"></span><span class="hamburger-line"></span></button></div></header><div class="mobile-menu"><nav class="mobile-menu-nav"><div class="mobile-menu-section"><a href="/guide/index.html" class="mobile-menu-section-title ">Guide</a><ul class="mobile-menu-list"><li><a href="/guide/index.html" class="mobile-menu-link ">What is Org-Press?</a></li><li><a href="/guide/getting-started.html" class="mobile-menu-link ">Getting Started</a></li><li><a href="/guide/why-org-press.html" class="mobile-menu-link ">Why Org-Press?</a></li><li><a href="/guide/features.html" class="mobile-menu-link ">Features</a></li><li><a href="/guide/rendering-modes.html" class="mobile-menu-link ">Rendering Modes</a></li><li><a href="/guide/cli.html" class="mobile-menu-link ">CLI Reference</a></li><li><a href="/guide/using-plugins.html" class="mobile-menu-link ">Using Plugins</a></li><li><a href="/guide/block-imports.html" class="mobile-menu-link ">Block Imports</a></li><li><a href="/guide/static-assets.html" class="mobile-menu-link ">Static Assets</a></li><li><a href="/guide/building.html" class="mobile-menu-link ">Building for Production</a></li><li><a href="/guide/deploying.html" class="mobile-menu-link ">Deploying</a></li><li><a href="/guide/troubleshooting.html" class="mobile-menu-link ">Troubleshooting</a></li></ul></div><div class="mobile-menu-section"><a href="/config/index.html" class="mobile-menu-section-title ">Config</a><ul class="mobile-menu-list"><li><a href="/config/index.html" class="mobile-menu-link ">Overview</a></li><li><a href="/config/shared-options.html" class="mobile-menu-link ">Shared Options</a></li><li><a href="/config/build-options.html" class="mobile-menu-link ">Build Options</a></li><li><a href="/config/server-options.html" class="mobile-menu-link ">Server Options</a></li><li><a href="/config/plugin-options.html" class="mobile-menu-link ">Plugin Options</a></li></ul></div><div class="mobile-menu-section"><a href="/plugins/index.html" class="mobile-menu-section-title ">Plugins</a><ul class="mobile-menu-list"><li><a href="/plugins/index.html" class="mobile-menu-link ">Overview</a></li><li class="mobile-menu-group"><span class="mobile-menu-group-title">Official Plugins</span><ul class="mobile-menu-sublist"><li><a href="/plugins/react.html" class="mobile-menu-link ">React</a></li><li><a href="/plugins/echarts.html" class="mobile-menu-link ">ECharts</a></li><li><a href="/plugins/excalidraw.html" class="mobile-menu-link ">Excalidraw</a></li><li><a href="/plugins/jscad.html" class="mobile-menu-link ">JSCAD</a></li><li><a href="/plugins/test.html" class="mobile-menu-link ">Test</a></li></ul></li><li><a href="/plugins/creating-plugins.html" class="mobile-menu-link ">Creating Plugins</a></li></ul></div><div class="mobile-menu-section"><a href="/api/index.html" class="mobile-menu-section-title ">API</a><ul class="mobile-menu-list"><li><a href="/api/index.html" class="mobile-menu-link ">Overview</a></li><li><a href="/api/plugin-api.html" class="mobile-menu-link ">Plugin API</a></li><li><a href="/api/javascript-api.html" class="mobile-menu-link ">JavaScript API</a></li><li><a href="/api/hmr-api.html" class="mobile-menu-link ">HMR API</a></li><li><a href="/api/cli-plugins.html" class="mobile-menu-link ">CLI Plugins</a></li></ul></div></nav><div class="mobile-menu-footer"><a href="https://github.com/org-press/org-press" class="mobile-menu-link" target="_blank" rel="noopener noreferrer">GitHub</a></div></div><div class="alpha-banner"><span class="alpha-banner-icon">⚠️</span><span class="alpha-banner-text"><strong>Early Alpha</strong> — Org-press is experimental. Perfect for hackers and tinkerers, not ready for production. Documentation may be incomplete or inaccurate.</span></div><div class="docs-container"><aside class="sidebar"><div class="sidebar-content"><nav class="sidebar-nav" aria-label="Section navigation"><div class="sidebar-section"><h3 class="sidebar-section-title">Guide</h3><ul class="sidebar-list"><li class="sidebar-item "><a href="/guide/index.html" class="sidebar-link ">What is Org-Press?</a></li><li class="sidebar-item "><a href="/guide/getting-started.html" class="sidebar-link ">Getting Started</a></li><li class="sidebar-item "><a href="/guide/why-org-press.html" class="sidebar-link ">Why Org-Press?</a></li><li class="sidebar-item "><a href="/guide/features.html" class="sidebar-link ">Features</a></li><li class="sidebar-item "><a href="/guide/rendering-modes.html" class="sidebar-link ">Rendering Modes</a></li><li class="sidebar-item "><a href="/guide/cli.html" class="sidebar-link ">CLI Reference</a></li><li class="sidebar-item "><a href="/guide/using-plugins.html" class="sidebar-link ">Using Plugins</a></li><li class="sidebar-item "><a href="/guide/block-imports.html" class="sidebar-link ">Block Imports</a></li><li class="sidebar-item "><a href="/guide/static-assets.html" class="sidebar-link ">Static Assets</a></li><li class="sidebar-item "><a href="/guide/building.html" class="sidebar-link ">Building for Production</a></li><li class="sidebar-item "><a href="/guide/deploying.html" class="sidebar-link ">Deploying</a></li><li class="sidebar-item "><a href="/guide/troubleshooting.html" class="sidebar-link ">Troubleshooting</a></li></ul></div></nav></div></aside><main class="docs-content"><article class="docs-article"><div class="docs-body"><div><p>A reusable Three.js component that creates a halftone effect using 3D spheres.
Sphere sizes are based on pixel brightness - darker pixels create larger spheres.
</p><h1 id="cors-image-proxy">CORS Image Proxy</h1><p>External images (like GitHub avatars) often have CORS restrictions that prevent
loading them directly in the browser. This API endpoint proxies image requests
through the server to bypass CORS.
</p><pre class="src-block"><code class="hljs language-javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">async</span> (req, res) => {
  <span class="hljs-keyword">const</span> url = req.<span class="hljs-property">query</span>.<span class="hljs-property">url</span>;

  <span class="hljs-keyword">if</span> (!url) {
    res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">error</span>: <span class="hljs-string">'Missing url parameter'</span> });
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// Validate URL</span>
    <span class="hljs-keyword">const</span> parsedUrl = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(url);

    <span class="hljs-comment">// Only allow http/https protocols</span>
    <span class="hljs-keyword">if</span> (![<span class="hljs-string">'http:'</span>, <span class="hljs-string">'https:'</span>].<span class="hljs-title function_">includes</span>(parsedUrl.<span class="hljs-property">protocol</span>)) {
      res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">error</span>: <span class="hljs-string">'Invalid protocol'</span> });
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// Fetch the image</span>
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(url, {
      <span class="hljs-attr">headers</span>: {
        <span class="hljs-string">'User-Agent'</span>: <span class="hljs-string">'OrgPress-ImageProxy/1.0'</span>,
      },
    });

    <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) {
      res.<span class="hljs-title function_">status</span>(response.<span class="hljs-property">status</span>).<span class="hljs-title function_">json</span>({
        <span class="hljs-attr">error</span>: <span class="hljs-string">`Failed to fetch image: <span class="hljs-subst">${response.statusText}</span>`</span>
      });
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// Get content type</span>
    <span class="hljs-keyword">const</span> contentType = response.<span class="hljs-property">headers</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'content-type'</span>) || <span class="hljs-string">'application/octet-stream'</span>;

    <span class="hljs-comment">// Only allow image content types</span>
    <span class="hljs-keyword">if</span> (!contentType.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'image/'</span>)) {
      res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">error</span>: <span class="hljs-string">'URL does not point to an image'</span> });
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// Get the image data as buffer</span>
    <span class="hljs-keyword">const</span> arrayBuffer = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">arrayBuffer</span>();
    <span class="hljs-keyword">const</span> buffer = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">from</span>(arrayBuffer);

    <span class="hljs-comment">// Set headers and send</span>
    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Content-Type'</span>, contentType);
    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Content-Length'</span>, buffer.<span class="hljs-property">length</span>);
    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Cache-Control'</span>, <span class="hljs-string">'public, max-age=86400'</span>); <span class="hljs-comment">// Cache for 24h</span>
    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Access-Control-Allow-Origin'</span>, <span class="hljs-string">'*'</span>);
    res.<span class="hljs-title function_">end</span>(buffer);
  } <span class="hljs-keyword">catch</span> (error) {
    res.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">json</span>({
      <span class="hljs-attr">error</span>: error <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span> ? error.<span class="hljs-property">message</span> : <span class="hljs-string">'Failed to proxy image'</span>
    });
  }
};
</code></pre><h2 id="image-url-helper">Image URL Helper</h2><p>Helper function to wrap external URLs through the CORS proxy.
</p><pre class="src-block"><code class="hljs language-typescript"><span class="hljs-comment">/**
 * Check if a URL is external (not same origin)
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">isExternalUrl</span>(<span class="hljs-params"><span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">boolean</span> {
  <span class="hljs-keyword">if</span> (url.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'/'</span>) || url.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'./'</span>) || url.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'../'</span>)) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> parsed = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(url, <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">origin</span>);
    <span class="hljs-keyword">return</span> parsed.<span class="hljs-property">origin</span> !== <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">origin</span>;
  } <span class="hljs-keyword">catch</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
}

<span class="hljs-comment">/**
 * Wrap an external URL through the CORS proxy
 * Returns the original URL for local paths
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">proxyImageUrl</span>(<span class="hljs-params"><span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isExternalUrl</span>(url)) {
    <span class="hljs-keyword">return</span> url;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-string">`/api/image-proxy?url=<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(url)}</span>`</span>;
}

<span class="hljs-comment">/**
 * Process image with optional background removal
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">processImage</span>(<span class="hljs-params">
  <span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>,
  <span class="hljs-attr">options</span>: {
    whiteThreshold?: <span class="hljs-built_in">number</span>;
    grayscale?: <span class="hljs-built_in">boolean</span>;
    invert?: <span class="hljs-built_in">boolean</span>;
    contrast?: <span class="hljs-built_in">number</span>;
  } = {}
</span>): <span class="hljs-title class_">Promise</span>&#x3C;{ <span class="hljs-attr">imageData</span>: <span class="hljs-title class_">ImageData</span>; <span class="hljs-attr">canvas</span>: <span class="hljs-title class_">HTMLCanvasElement</span> }> {
  <span class="hljs-keyword">const</span> { whiteThreshold = <span class="hljs-number">240</span>, grayscale = <span class="hljs-literal">false</span>, invert = <span class="hljs-literal">false</span>, contrast = <span class="hljs-number">1</span> } = options;

  <span class="hljs-comment">// Use proxy for external URLs</span>
  <span class="hljs-keyword">const</span> proxyUrl = <span class="hljs-title function_">proxyImageUrl</span>(url);

  <span class="hljs-keyword">const</span> img = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>&#x3C;<span class="hljs-title class_">HTMLImageElement</span>>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =></span> {
    <span class="hljs-keyword">const</span> img = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();
    img.<span class="hljs-property">crossOrigin</span> = <span class="hljs-string">'anonymous'</span>;
    img.<span class="hljs-property">onload</span> = <span class="hljs-function">() =></span> <span class="hljs-title function_">resolve</span>(img);
    img.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =></span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Failed to load image: <span class="hljs-subst">${url}</span>`</span>));
    img.<span class="hljs-property">src</span> = proxyUrl;
  });

  <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'canvas'</span>);
  canvas.<span class="hljs-property">width</span> = img.<span class="hljs-property">width</span>;
  canvas.<span class="hljs-property">height</span> = img.<span class="hljs-property">height</span>;
  <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>)!;
  ctx.<span class="hljs-title function_">drawImage</span>(img, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

  <span class="hljs-keyword">const</span> imageData = ctx.<span class="hljs-title function_">getImageData</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, img.<span class="hljs-property">width</span>, img.<span class="hljs-property">height</span>);
  <span class="hljs-keyword">const</span> { data } = imageData;

  <span class="hljs-comment">// Process pixels</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &#x3C; data.<span class="hljs-property">length</span>; i += <span class="hljs-number">4</span>) {
    <span class="hljs-keyword">let</span> r = data[i];
    <span class="hljs-keyword">let</span> g = data[i + <span class="hljs-number">1</span>];
    <span class="hljs-keyword">let</span> b = data[i + <span class="hljs-number">2</span>];
    <span class="hljs-keyword">const</span> a = data[i + <span class="hljs-number">3</span>];

    <span class="hljs-comment">// Remove white background</span>
    <span class="hljs-keyword">if</span> (r >= whiteThreshold &#x26;&#x26; g >= whiteThreshold &#x26;&#x26; b >= whiteThreshold) {
      data[i + <span class="hljs-number">3</span>] = <span class="hljs-number">0</span>; <span class="hljs-comment">// Make transparent</span>
      <span class="hljs-keyword">continue</span>;
    }

    <span class="hljs-comment">// Apply contrast</span>
    <span class="hljs-keyword">if</span> (contrast !== <span class="hljs-number">1</span>) {
      r = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">255</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, ((r / <span class="hljs-number">255</span> - <span class="hljs-number">0.5</span>) * contrast + <span class="hljs-number">0.5</span>) * <span class="hljs-number">255</span>));
      g = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">255</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, ((g / <span class="hljs-number">255</span> - <span class="hljs-number">0.5</span>) * contrast + <span class="hljs-number">0.5</span>) * <span class="hljs-number">255</span>));
      b = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">255</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, ((b / <span class="hljs-number">255</span> - <span class="hljs-number">0.5</span>) * contrast + <span class="hljs-number">0.5</span>) * <span class="hljs-number">255</span>));
    }

    <span class="hljs-comment">// Grayscale</span>
    <span class="hljs-keyword">if</span> (grayscale) {
      <span class="hljs-keyword">const</span> gray = <span class="hljs-number">0.299</span> * r + <span class="hljs-number">0.587</span> * g + <span class="hljs-number">0.114</span> * b;
      r = g = b = gray;
    }

    <span class="hljs-comment">// Invert</span>
    <span class="hljs-keyword">if</span> (invert) {
      r = <span class="hljs-number">255</span> - r;
      g = <span class="hljs-number">255</span> - g;
      b = <span class="hljs-number">255</span> - b;
    }

    data[i] = r;
    data[i + <span class="hljs-number">1</span>] = g;
    data[i + <span class="hljs-number">2</span>] = b;
  }

  ctx.<span class="hljs-title function_">putImageData</span>(imageData, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
  <span class="hljs-keyword">return</span> { imageData, canvas };
}
</code></pre><h1 id="usage">Usage</h1><p>Import and use the <code class="inline-verbatim">createHalftoneSpheres</code> function:
</p><pre class="src-block"><code class="hljs language-typescript"><span class="hljs-keyword">import</span> { createHalftoneSpheres } <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/halftone-spheres.org?name=halftone-spheres'</span>;

<span class="hljs-comment">// Create the effect with an image URL</span>
<span class="hljs-keyword">const</span> { renderer, animate, dispose } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">createHalftoneSpheres</span>({
  <span class="hljs-attr">imageUrl</span>: <span class="hljs-string">'/path/to/image.png'</span>,
  <span class="hljs-attr">gridSize</span>: <span class="hljs-number">50</span>,        <span class="hljs-comment">// Number of sample points per axis</span>
  <span class="hljs-attr">sphereScale</span>: <span class="hljs-number">0.8</span>,    <span class="hljs-comment">// Max sphere size multiplier</span>
  <span class="hljs-attr">backgroundColor</span>: <span class="hljs-number">0x000000</span>,
  <span class="hljs-attr">sphereColor</span>: <span class="hljs-number">0xffffff</span>,
});

<span class="hljs-comment">// Mount to DOM</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'container'</span>).<span class="hljs-title function_">appendChild</span>(renderer.<span class="hljs-property">domElement</span>);

<span class="hljs-comment">// Start animation loop</span>
<span class="hljs-title function_">animate</span>();

<span class="hljs-comment">// Cleanup when done</span>
<span class="hljs-title function_">dispose</span>();
</code></pre><h1 id="implementation">Implementation</h1><pre class="src-block"><code class="hljs language-typescript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'three'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">OrbitControls</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'three/examples/jsm/controls/OrbitControls.js'</span>;
<span class="hljs-keyword">import</span> { proxyImageUrl } <span class="hljs-keyword">from</span> <span class="hljs-string">'./halftone-spheres.org?name=image-utils'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">HalftoneOptions</span> {
  <span class="hljs-attr">imageUrl</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">gridSize</span>?: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">sphereScale</span>?: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">backgroundColor</span>?: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">sphereColor</span>?: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">width</span>?: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">height</span>?: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">/** Animation duration in seconds for spheres to reach final position */</span>
  <span class="hljs-attr">animationDuration</span>?: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">/** Spread of random delays (0-1), higher = more staggered */</span>
  <span class="hljs-attr">animationSpread</span>?: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">HalftoneResult</span> {
  <span class="hljs-attr">renderer</span>: <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">WebGLRenderer</span>;
  <span class="hljs-attr">scene</span>: <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">Scene</span>;
  <span class="hljs-attr">camera</span>: <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">PerspectiveCamera</span>;
  <span class="hljs-attr">controls</span>: <span class="hljs-title class_">OrbitControls</span>;
  <span class="hljs-attr">animate</span>: <span class="hljs-function">() =></span> <span class="hljs-built_in">void</span>;
  <span class="hljs-attr">dispose</span>: <span class="hljs-function">() =></span> <span class="hljs-built_in">void</span>;
  <span class="hljs-comment">/** Restart the expansion animation */</span>
  <span class="hljs-attr">replay</span>: <span class="hljs-function">() =></span> <span class="hljs-built_in">void</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">SphereData</span> {
  <span class="hljs-attr">targetPosition</span>: <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">Vector3</span>;
  <span class="hljs-attr">scale</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">/** Random delay before this sphere starts moving (0-1) */</span>
  <span class="hljs-attr">delay</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">/** Random speed multiplier for variety */</span>
  <span class="hljs-attr">speed</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-comment">/**
 * Load an image and get its pixel data
 * Uses CORS proxy for external URLs automatically
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getImageData</span>(<span class="hljs-params"><span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">Promise</span>&#x3C;<span class="hljs-title class_">ImageData</span>> {
  <span class="hljs-comment">// Use proxy for external URLs to avoid CORS issues</span>
  <span class="hljs-keyword">const</span> proxyUrl = <span class="hljs-title function_">proxyImageUrl</span>(url);

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =></span> {
    <span class="hljs-keyword">const</span> img = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();
    img.<span class="hljs-property">crossOrigin</span> = <span class="hljs-string">'anonymous'</span>;
    img.<span class="hljs-property">onload</span> = <span class="hljs-function">() =></span> {
      <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'canvas'</span>);
      canvas.<span class="hljs-property">width</span> = img.<span class="hljs-property">width</span>;
      canvas.<span class="hljs-property">height</span> = img.<span class="hljs-property">height</span>;
      <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>)!;
      ctx.<span class="hljs-title function_">drawImage</span>(img, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
      <span class="hljs-title function_">resolve</span>(ctx.<span class="hljs-title function_">getImageData</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, img.<span class="hljs-property">width</span>, img.<span class="hljs-property">height</span>));
    };
    img.<span class="hljs-property">onerror</span> = reject;
    img.<span class="hljs-property">src</span> = proxyUrl;
  });
}

<span class="hljs-comment">/**
 * Get brightness (0-1) at a specific pixel
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getBrightness</span>(<span class="hljs-params"><span class="hljs-attr">data</span>: <span class="hljs-title class_">Uint8ClampedArray</span>, <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> {
  <span class="hljs-keyword">const</span> i = (y * width + x) * <span class="hljs-number">4</span>;
  <span class="hljs-keyword">const</span> r = data[i];
  <span class="hljs-keyword">const</span> g = data[i + <span class="hljs-number">1</span>];
  <span class="hljs-keyword">const</span> b = data[i + <span class="hljs-number">2</span>];
  <span class="hljs-keyword">const</span> a = data[i + <span class="hljs-number">3</span>];

  <span class="hljs-comment">// Skip transparent pixels</span>
  <span class="hljs-keyword">if</span> (a &#x3C; <span class="hljs-number">128</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;

  <span class="hljs-comment">// Calculate luminosity (human perception weighted)</span>
  <span class="hljs-keyword">return</span> (<span class="hljs-number">0.299</span> * r + <span class="hljs-number">0.587</span> * g + <span class="hljs-number">0.114</span> * b) / <span class="hljs-number">255</span>;
}

<span class="hljs-comment">/**
 * Easing function for smooth animation
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">easeOutCubic</span>(<span class="hljs-params"><span class="hljs-attr">t</span>: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span> - <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">1</span> - t, <span class="hljs-number">3</span>);
}

<span class="hljs-comment">/**
 * Create 3D halftone spheres from an image with expansion animation
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createHalftoneSpheres</span>(<span class="hljs-params"><span class="hljs-attr">options</span>: <span class="hljs-title class_">HalftoneOptions</span></span>): <span class="hljs-title class_">Promise</span>&#x3C;<span class="hljs-title class_">HalftoneResult</span>> {
  <span class="hljs-keyword">const</span> {
    imageUrl,
    gridSize = <span class="hljs-number">40</span>,
    sphereScale = <span class="hljs-number">0.5</span>,
    backgroundColor = <span class="hljs-number">0x111111</span>,
    sphereColor = <span class="hljs-number">0xffffff</span>,
    width = <span class="hljs-number">800</span>,
    height = <span class="hljs-number">600</span>,
    animationDuration = <span class="hljs-number">3</span>,
    animationSpread = <span class="hljs-number">0.8</span>,
  } = options;

  <span class="hljs-comment">// Load image data</span>
  <span class="hljs-keyword">const</span> imageData = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getImageData</span>(imageUrl);
  <span class="hljs-keyword">const</span> { <span class="hljs-attr">width</span>: imgWidth, <span class="hljs-attr">height</span>: imgHeight, data } = imageData;

  <span class="hljs-comment">// Setup Three.js</span>
  <span class="hljs-keyword">const</span> scene = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Scene</span>();
  scene.<span class="hljs-property">background</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Color</span>(backgroundColor);

  <span class="hljs-keyword">const</span> camera = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PerspectiveCamera</span>(<span class="hljs-number">50</span>, width / height, <span class="hljs-number">0.1</span>, <span class="hljs-number">1000</span>);
  camera.<span class="hljs-property">position</span>.<span class="hljs-property">z</span> = gridSize * <span class="hljs-number">1.2</span>;

  <span class="hljs-keyword">const</span> renderer = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">WebGLRenderer</span>({ <span class="hljs-attr">antialias</span>: <span class="hljs-literal">true</span> });
  renderer.<span class="hljs-title function_">setSize</span>(width, height);
  renderer.<span class="hljs-title function_">setPixelRatio</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">devicePixelRatio</span>, <span class="hljs-number">2</span>));

  <span class="hljs-comment">// Orbit controls for interactivity</span>
  <span class="hljs-keyword">const</span> controls = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrbitControls</span>(camera, renderer.<span class="hljs-property">domElement</span>);
  controls.<span class="hljs-property">enableDamping</span> = <span class="hljs-literal">true</span>;
  controls.<span class="hljs-property">dampingFactor</span> = <span class="hljs-number">0.05</span>;

  <span class="hljs-comment">// Create instanced mesh for performance</span>
  <span class="hljs-keyword">const</span> sphereGeometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">SphereGeometry</span>(<span class="hljs-number">0.5</span>, <span class="hljs-number">16</span>, <span class="hljs-number">16</span>);
  <span class="hljs-keyword">const</span> sphereMaterial = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshStandardMaterial</span>({
    <span class="hljs-attr">color</span>: sphereColor,
    <span class="hljs-attr">metalness</span>: <span class="hljs-number">0.3</span>,
    <span class="hljs-attr">roughness</span>: <span class="hljs-number">0.7</span>,
  });

  <span class="hljs-comment">// Calculate sphere data with animation properties</span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">spheres</span>: <span class="hljs-title class_">SphereData</span>[] = [];
  <span class="hljs-keyword">const</span> stepX = imgWidth / gridSize;
  <span class="hljs-keyword">const</span> stepY = imgHeight / gridSize;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> gy = <span class="hljs-number">0</span>; gy &#x3C; gridSize; gy++) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> gx = <span class="hljs-number">0</span>; gx &#x3C; gridSize; gx++) {
      <span class="hljs-comment">// Sample image at grid point</span>
      <span class="hljs-keyword">const</span> imgX = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(gx * stepX);
      <span class="hljs-keyword">const</span> imgY = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(gy * stepY);
      <span class="hljs-keyword">const</span> brightness = <span class="hljs-title function_">getBrightness</span>(data, imgX, imgY, imgWidth);

      <span class="hljs-comment">// Invert brightness: darker pixels = larger spheres</span>
      <span class="hljs-keyword">const</span> size = (<span class="hljs-number">1</span> - brightness) * sphereScale;

      <span class="hljs-keyword">if</span> (size > <span class="hljs-number">0.01</span>) {
        <span class="hljs-comment">// Center the grid</span>
        <span class="hljs-keyword">const</span> x = gx - gridSize / <span class="hljs-number">2</span>;
        <span class="hljs-keyword">const</span> y = (gridSize - gy) - gridSize / <span class="hljs-number">2</span>; <span class="hljs-comment">// Flip Y</span>

        spheres.<span class="hljs-title function_">push</span>({
          <span class="hljs-attr">targetPosition</span>: <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(x, y, <span class="hljs-number">0</span>),
          <span class="hljs-attr">scale</span>: size,
          <span class="hljs-comment">// Random delay creates the "flow" effect</span>
          <span class="hljs-attr">delay</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * animationSpread,
          <span class="hljs-comment">// Random speed adds variety (0.7 to 1.3)</span>
          <span class="hljs-attr">speed</span>: <span class="hljs-number">0.7</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.6</span>,
        });
      }
    }
  }

  <span class="hljs-comment">// Create instanced mesh</span>
  <span class="hljs-keyword">const</span> instancedMesh = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">InstancedMesh</span>(
    sphereGeometry,
    sphereMaterial,
    spheres.<span class="hljs-property">length</span>
  );
  scene.<span class="hljs-title function_">add</span>(instancedMesh);

  <span class="hljs-comment">// Lighting</span>
  <span class="hljs-keyword">const</span> ambientLight = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">AmbientLight</span>(<span class="hljs-number">0xffffff</span>, <span class="hljs-number">0.6</span>);
  scene.<span class="hljs-title function_">add</span>(ambientLight);

  <span class="hljs-keyword">const</span> directionalLight = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">DirectionalLight</span>(<span class="hljs-number">0xffffff</span>, <span class="hljs-number">0.8</span>);
  directionalLight.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">10</span>, <span class="hljs-number">10</span>, <span class="hljs-number">10</span>);
  scene.<span class="hljs-title function_">add</span>(directionalLight);

  <span class="hljs-keyword">const</span> backLight = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">DirectionalLight</span>(<span class="hljs-number">0xffffff</span>, <span class="hljs-number">0.3</span>);
  backLight.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(-<span class="hljs-number">10</span>, -<span class="hljs-number">10</span>, -<span class="hljs-number">10</span>);
  scene.<span class="hljs-title function_">add</span>(backLight);

  <span class="hljs-comment">// Animation state</span>
  <span class="hljs-keyword">let</span> <span class="hljs-attr">animationId</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-keyword">let</span> <span class="hljs-attr">startTime</span>: <span class="hljs-built_in">number</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">const</span> matrix = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Matrix4</span>();
  <span class="hljs-keyword">const</span> currentPos = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>();
  <span class="hljs-keyword">const</span> center = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

  <span class="hljs-comment">/**
   * Update sphere positions based on animation progress
   */</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">updateSpheres</span>(<span class="hljs-params"><span class="hljs-attr">elapsedSeconds</span>: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-keyword">let</span> allComplete = <span class="hljs-literal">true</span>;

    spheres.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">sphere, i</span>) =></span> {
      <span class="hljs-comment">// Calculate this sphere's progress (accounting for delay and speed)</span>
      <span class="hljs-keyword">const</span> adjustedTime = (elapsedSeconds - sphere.<span class="hljs-property">delay</span> * animationDuration) * sphere.<span class="hljs-property">speed</span>;
      <span class="hljs-keyword">const</span> progress = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">1</span>, adjustedTime / animationDuration));

      <span class="hljs-keyword">if</span> (progress &#x3C; <span class="hljs-number">1</span>) allComplete = <span class="hljs-literal">false</span>;

      <span class="hljs-comment">// Apply easing</span>
      <span class="hljs-keyword">const</span> easedProgress = <span class="hljs-title function_">easeOutCubic</span>(progress);

      <span class="hljs-comment">// Interpolate from center to target</span>
      currentPos.<span class="hljs-title function_">lerpVectors</span>(center, sphere.<span class="hljs-property">targetPosition</span>, easedProgress);

      <span class="hljs-comment">// Scale also animates in (starts small, grows to full size)</span>
      <span class="hljs-keyword">const</span> currentScale = sphere.<span class="hljs-property">scale</span> * easedProgress;

      <span class="hljs-comment">// Update matrix</span>
      matrix.<span class="hljs-title function_">makeScale</span>(currentScale, currentScale, currentScale);
      matrix.<span class="hljs-title function_">setPosition</span>(currentPos);
      instancedMesh.<span class="hljs-title function_">setMatrixAt</span>(i, matrix);
    });

    instancedMesh.<span class="hljs-property">instanceMatrix</span>.<span class="hljs-property">needsUpdate</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">return</span> allComplete;
  }

  <span class="hljs-comment">// Initialize all spheres at center</span>
  <span class="hljs-title function_">updateSpheres</span>(<span class="hljs-number">0</span>);

  <span class="hljs-comment">// Animation loop</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">animate</span> = (<span class="hljs-params"></span>) => {
    animationId = <span class="hljs-title function_">requestAnimationFrame</span>(animate);

    <span class="hljs-comment">// Track animation time</span>
    <span class="hljs-keyword">if</span> (startTime === <span class="hljs-literal">null</span>) startTime = performance.<span class="hljs-title function_">now</span>();
    <span class="hljs-keyword">const</span> elapsedSeconds = (performance.<span class="hljs-title function_">now</span>() - startTime) / <span class="hljs-number">1000</span>;

    <span class="hljs-comment">// Update sphere positions</span>
    <span class="hljs-title function_">updateSpheres</span>(elapsedSeconds);

    controls.<span class="hljs-title function_">update</span>();
    renderer.<span class="hljs-title function_">render</span>(scene, camera);
  };

  <span class="hljs-comment">// Replay function to restart animation</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">replay</span> = (<span class="hljs-params"></span>) => {
    startTime = <span class="hljs-literal">null</span>;
    <span class="hljs-comment">// Re-randomize delays for different flow pattern</span>
    spheres.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">sphere</span> =></span> {
      sphere.<span class="hljs-property">delay</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * animationSpread;
      sphere.<span class="hljs-property">speed</span> = <span class="hljs-number">0.7</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.6</span>;
    });
  };

  <span class="hljs-comment">// Cleanup function</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">dispose</span> = (<span class="hljs-params"></span>) => {
    <span class="hljs-title function_">cancelAnimationFrame</span>(animationId);
    controls.<span class="hljs-title function_">dispose</span>();
    renderer.<span class="hljs-title function_">dispose</span>();
    sphereGeometry.<span class="hljs-title function_">dispose</span>();
    sphereMaterial.<span class="hljs-title function_">dispose</span>();
  };

  <span class="hljs-keyword">return</span> { renderer, scene, camera, controls, animate, dispose, replay };
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> createHalftoneSpheres;
</code></pre><h1 id="demo">Demo</h1><pre class="src-block"><code class="hljs language-typescript"><span class="hljs-keyword">import</span> { createHalftoneSpheres } <span class="hljs-keyword">from</span> <span class="hljs-string">'./halftone-spheres.org?name=halftone-spheres'</span>;

<span class="hljs-comment">// Create wrapper with controls</span>
<span class="hljs-keyword">const</span> wrapper = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
wrapper.<span class="hljs-property">style</span>.<span class="hljs-property">position</span> = <span class="hljs-string">'relative'</span>;

<span class="hljs-comment">// Create container for Three.js</span>
<span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
container.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = <span class="hljs-string">'100%'</span>;
container.<span class="hljs-property">style</span>.<span class="hljs-property">height</span> = <span class="hljs-string">'400px'</span>;
container.<span class="hljs-property">style</span>.<span class="hljs-property">borderRadius</span> = <span class="hljs-string">'8px'</span>;
container.<span class="hljs-property">style</span>.<span class="hljs-property">overflow</span> = <span class="hljs-string">'hidden'</span>;

<span class="hljs-comment">// Create replay button</span>
<span class="hljs-keyword">const</span> replayBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'button'</span>);
replayBtn.<span class="hljs-property">textContent</span> = <span class="hljs-string">'↻ Replay'</span>;
replayBtn.<span class="hljs-property">style</span>.<span class="hljs-property">cssText</span> = <span class="hljs-string">`
  position: absolute;
  top: 10px;
  right: 10px;
  padding: 8px 16px;
  background: rgba(0, 217, 255, 0.2);
  border: 1px solid #00d9ff;
  color: #00d9ff;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  z-index: 10;
`</span>;
replayBtn.<span class="hljs-property">onmouseenter</span> = <span class="hljs-function">() =></span> replayBtn.<span class="hljs-property">style</span>.<span class="hljs-property">background</span> = <span class="hljs-string">'rgba(0, 217, 255, 0.4)'</span>;
replayBtn.<span class="hljs-property">onmouseleave</span> = <span class="hljs-function">() =></span> replayBtn.<span class="hljs-property">style</span>.<span class="hljs-property">background</span> = <span class="hljs-string">'rgba(0, 217, 255, 0.2)'</span>;

wrapper.<span class="hljs-title function_">appendChild</span>(container);
wrapper.<span class="hljs-title function_">appendChild</span>(replayBtn);

<span class="hljs-comment">// Demo with a sample image (replace with your image)</span>
<span class="hljs-keyword">const</span> imageUrl = <span class="hljs-string">'https://avatars.githubusercontent.com/u/651290?v=4&#x26;s=200'</span>;

<span class="hljs-title function_">createHalftoneSpheres</span>({
  imageUrl,
  <span class="hljs-attr">gridSize</span>: <span class="hljs-number">50</span>,
  <span class="hljs-attr">sphereScale</span>: <span class="hljs-number">0.6</span>,
  <span class="hljs-attr">backgroundColor</span>: <span class="hljs-number">0x1a1a2e</span>,
  <span class="hljs-attr">sphereColor</span>: <span class="hljs-number">0x00d9ff</span>,
  <span class="hljs-attr">width</span>: container.<span class="hljs-property">clientWidth</span> || <span class="hljs-number">800</span>,
  <span class="hljs-attr">height</span>: <span class="hljs-number">400</span>,
  <span class="hljs-attr">animationDuration</span>: <span class="hljs-number">2.5</span>,
  <span class="hljs-attr">animationSpread</span>: <span class="hljs-number">0.7</span>,
}).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">{ renderer, animate, replay }</span>) =></span> {
  container.<span class="hljs-title function_">appendChild</span>(renderer.<span class="hljs-property">domElement</span>);
  replayBtn.<span class="hljs-property">onclick</span> = replay;
  <span class="hljs-title function_">animate</span>();
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> wrapper;
</code></pre><h1 id="variations">Variations</h1><h2 id="background-mode-scroll-driven">Background Mode (Scroll-Driven)</h2><p>A variant designed for use as a page background with scroll-driven camera
and smooth image transitions. Features:
</p><ul><li>All spheres are always used (none disappear)
</li><li>Z-axis elevation based on brightness creates relief/depth effect
</li><li>Very slow settling animation (configurable up to 5 minutes)
</li><li>Image preprocessing to clean backgrounds
</li></ul><pre class="src-block"><code class="hljs language-typescript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'three'</span>;
<span class="hljs-keyword">import</span> { processImage, proxyImageUrl } <span class="hljs-keyword">from</span> <span class="hljs-string">'./halftone-spheres.org?name=image-utils'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CameraKeyframe</span> {
  <span class="hljs-comment">/** Scroll progress (0-1) when this keyframe is active */</span>
  <span class="hljs-attr">at</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">/** Camera position */</span>
  <span class="hljs-attr">position</span>: { <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">z</span>: <span class="hljs-built_in">number</span> };
  <span class="hljs-comment">/** Camera look-at target */</span>
  <span class="hljs-attr">lookAt</span>?: { <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">z</span>: <span class="hljs-built_in">number</span> };
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">FlowWaypoint</span> {
  <span class="hljs-comment">/** Position offset from center */</span>
  <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">/** Time to reach this point (0-1 of flow cycle) */</span>
  <span class="hljs-attr">at</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BackgroundHalftoneOptions</span> {
  <span class="hljs-comment">/** Initial image URL */</span>
  <span class="hljs-attr">imageUrl</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-comment">/** Grid size (default 80 for more dots) */</span>
  <span class="hljs-attr">gridSize</span>?: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">/** Base sphere scale (default 0.4) */</span>
  <span class="hljs-attr">sphereScale</span>?: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">/** Background color */</span>
  <span class="hljs-attr">backgroundColor</span>?: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">/** Sphere color */</span>
  <span class="hljs-attr">sphereColor</span>?: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">/** Camera keyframes for scroll animation */</span>
  <span class="hljs-attr">cameraKeyframes</span>?: <span class="hljs-title class_">CameraKeyframe</span>[];
  <span class="hljs-comment">/** Duration for quick image visibility (seconds, default 3) */</span>
  <span class="hljs-attr">quickRevealDuration</span>?: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">/** Duration for full settling animation (seconds, default 300 = 5 minutes) */</span>
  <span class="hljs-attr">settlingDuration</span>?: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">/** Z-depth multiplier for relief effect (default 8) */</span>
  <span class="hljs-attr">depthScale</span>?: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">/** Image scale relative to grid (0.5 = 50% of grid, default 0.5) */</span>
  <span class="hljs-attr">imageScale</span>?: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">/** Flow path waypoints - composition drifts through these positions */</span>
  <span class="hljs-attr">flowPath</span>?: <span class="hljs-title class_">FlowWaypoint</span>[];
  <span class="hljs-comment">/** Duration of one flow cycle in seconds (default 60) */</span>
  <span class="hljs-attr">flowDuration</span>?: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">/** Image preprocessing options */</span>
  <span class="hljs-attr">imageProcessing</span>?: {
    <span class="hljs-attr">removeWhiteBackground</span>?: <span class="hljs-built_in">boolean</span>;
    <span class="hljs-attr">whiteThreshold</span>?: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">grayscale</span>?: <span class="hljs-built_in">boolean</span>;
    <span class="hljs-attr">invert</span>?: <span class="hljs-built_in">boolean</span>;
    <span class="hljs-attr">contrast</span>?: <span class="hljs-built_in">number</span>;
  };
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">TypeCaseConfig</span> {
  <span class="hljs-comment">/** Grid columns (default 6) */</span>
  <span class="hljs-attr">cols</span>?: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">/** Grid rows (default 8) */</span>
  <span class="hljs-attr">rows</span>?: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">/** Size of each cell in grid units (default auto-calculated) */</span>
  <span class="hljs-attr">cellSize</span>?: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">/** Letters to display - can include featured word */</span>
  <span class="hljs-attr">letters</span>?: <span class="hljs-built_in">string</span>[];
  <span class="hljs-comment">/** Featured word to highlight (e.g., "ORG-PRESS") */</span>
  <span class="hljs-attr">featuredWord</span>?: <span class="hljs-built_in">string</span>;
  <span class="hljs-comment">/** Font family (default "Georgia, serif") */</span>
  <span class="hljs-attr">fontFamily</span>?: <span class="hljs-built_in">string</span>;
  <span class="hljs-comment">/** Gap between cells as fraction of cell size (default 0.15) */</span>
  <span class="hljs-attr">cellGap</span>?: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">/** Perspective tilt in radians (default 0) */</span>
  <span class="hljs-attr">perspectiveTilt</span>?: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">/** Letter elevation multiplier (default 1) */</span>
  <span class="hljs-attr">letterElevation</span>?: <span class="hljs-built_in">number</span>;
}

<span class="hljs-comment">/** Forward declaration - full type defined in editor section */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">HalftoneIllustration</span> {
  <span class="hljs-attr">version</span>: <span class="hljs-number">1</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">type</span>: <span class="hljs-string">'image'</span> | <span class="hljs-string">'typecase'</span> | <span class="hljs-string">'custom'</span>;
  <span class="hljs-attr">source</span>?: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">object</span>;
  <span class="hljs-attr">points</span>: <span class="hljs-title class_">Array</span>&#x3C;{ <span class="hljs-attr">nx</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">ny</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">nz</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">scale</span>: <span class="hljs-built_in">number</span> }>;
  <span class="hljs-attr">transform</span>: { <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">z</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">scale</span>: <span class="hljs-built_in">number</span> };
  <span class="hljs-attr">camera</span>: { <span class="hljs-attr">position</span>: { <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">z</span>: <span class="hljs-built_in">number</span> }; <span class="hljs-attr">lookAt</span>: { <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">z</span>: <span class="hljs-built_in">number</span> }; <span class="hljs-attr">fov</span>: <span class="hljs-built_in">number</span> };
  <span class="hljs-attr">created</span>?: <span class="hljs-built_in">string</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">GlobeConfig</span> {
  <span class="hljs-comment">/** Colors for random sphere glows (hex numbers) */</span>
  <span class="hljs-attr">colors</span>?: <span class="hljs-built_in">number</span>[];
  <span class="hljs-comment">/** Radius of the globe */</span>
  <span class="hljs-attr">radius</span>?: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">/** Number of spheres to show (uses fewer, bigger spheres) */</span>
  <span class="hljs-attr">sphereCount</span>?: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SolarSystemConfig</span> {
  <span class="hljs-comment">/** Colors for orbiting spheres */</span>
  <span class="hljs-attr">orbitColors</span>?: <span class="hljs-built_in">number</span>[];
  <span class="hljs-comment">/** Center sphere color */</span>
  <span class="hljs-attr">centerColor</span>?: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">/** Center sphere glow intensity */</span>
  <span class="hljs-attr">glowIntensity</span>?: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BackgroundHalftoneResult</span> {
  <span class="hljs-attr">canvas</span>: <span class="hljs-title class_">HTMLCanvasElement</span>;
  <span class="hljs-attr">start</span>: <span class="hljs-function">() =></span> <span class="hljs-built_in">void</span>;
  <span class="hljs-attr">stop</span>: <span class="hljs-function">() =></span> <span class="hljs-built_in">void</span>;
  <span class="hljs-attr">setScrollProgress</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">progress</span>: <span class="hljs-built_in">number</span></span>) =></span> <span class="hljs-built_in">void</span>;
  <span class="hljs-attr">transitionToImage</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">imageUrl</span>: <span class="hljs-built_in">string</span></span>) =></span> <span class="hljs-title class_">Promise</span>&#x3C;<span class="hljs-built_in">void</span>>;
  <span class="hljs-attr">transitionToTypeCase</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">config</span>?: <span class="hljs-title class_">TypeCaseConfig</span></span>) =></span> <span class="hljs-title class_">Promise</span>&#x3C;<span class="hljs-built_in">void</span>>;
  <span class="hljs-attr">transitionToIllustration</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">illustration</span>: <span class="hljs-title class_">HalftoneIllustration</span></span>) =></span> <span class="hljs-built_in">void</span>;
  <span class="hljs-comment">/** Arrange spheres as a rotating globe with colored glows */</span>
  <span class="hljs-attr">transitionToGlobe</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">config</span>?: <span class="hljs-title class_">GlobeConfig</span></span>) =></span> <span class="hljs-built_in">void</span>;
  <span class="hljs-comment">/** Arrange spheres as a solar system with orbiting spheres */</span>
  <span class="hljs-attr">transitionToSolarSystem</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">config</span>?: <span class="hljs-title class_">SolarSystemConfig</span></span>) =></span> <span class="hljs-built_in">void</span>;
  <span class="hljs-comment">/** Collapse all spheres to center as a single floating sphere */</span>
  <span class="hljs-attr">collapseToCenter</span>: <span class="hljs-function">() =></span> <span class="hljs-built_in">void</span>;
  <span class="hljs-comment">/** Restore spheres to their expanded formation */</span>
  <span class="hljs-attr">restore</span>: <span class="hljs-function">() =></span> <span class="hljs-built_in">void</span>;
  <span class="hljs-comment">/** Check if currently collapsed */</span>
  <span class="hljs-attr">isCollapsed</span>: <span class="hljs-function">() =></span> <span class="hljs-built_in">boolean</span>;
  <span class="hljs-attr">dispose</span>: <span class="hljs-function">() =></span> <span class="hljs-built_in">void</span>;
  <span class="hljs-attr">resize</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span></span>) =></span> <span class="hljs-built_in">void</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">SphereState</span> {
  <span class="hljs-comment">/** Grid position (fixed) */</span>
  <span class="hljs-attr">gridX</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">gridY</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">/** Current animated position */</span>
  <span class="hljs-attr">currentPosition</span>: <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">Vector3</span>;
  <span class="hljs-comment">/** Target position from current image */</span>
  <span class="hljs-attr">targetPosition</span>: <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">Vector3</span>;
  <span class="hljs-comment">/** Current scale (animated) */</span>
  <span class="hljs-attr">currentScale</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">/** Target scale from current image */</span>
  <span class="hljs-attr">targetScale</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">/** Random delay for staggered animation (0-1) */</span>
  <span class="hljs-attr">delay</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">/** Random speed multiplier */</span>
  <span class="hljs-attr">speed</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">/** Whether this sphere is "active" (has image data) */</span>
  <span class="hljs-attr">active</span>: <span class="hljs-built_in">boolean</span>;
}

<span class="hljs-comment">/**
 * Load and process image, returning target data for ALL grid positions
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">imageScale</span> - Scale of image relative to grid (0.5 = 50% of grid size)
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadImageData</span>(<span class="hljs-params">
  <span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>,
  <span class="hljs-attr">gridSize</span>: <span class="hljs-built_in">number</span>,
  <span class="hljs-attr">sphereScale</span>: <span class="hljs-built_in">number</span>,
  <span class="hljs-attr">depthScale</span>: <span class="hljs-built_in">number</span>,
  <span class="hljs-attr">imageScale</span>: <span class="hljs-built_in">number</span>,
  <span class="hljs-attr">processing</span>?: <span class="hljs-title class_">BackgroundHalftoneOptions</span>[<span class="hljs-string">'imageProcessing'</span>]
</span>): <span class="hljs-title class_">Promise</span>&#x3C;<span class="hljs-title class_">Map</span>&#x3C;<span class="hljs-built_in">string</span>, { <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">z</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">scale</span>: <span class="hljs-built_in">number</span> }>> {
  <span class="hljs-comment">// Process image if options provided</span>
  <span class="hljs-keyword">let</span> <span class="hljs-attr">imageData</span>: <span class="hljs-title class_">ImageData</span>;

  <span class="hljs-keyword">if</span> (processing?.<span class="hljs-property">removeWhiteBackground</span>) {
    <span class="hljs-keyword">const</span> processed = <span class="hljs-keyword">await</span> <span class="hljs-title function_">processImage</span>(url, {
      <span class="hljs-attr">whiteThreshold</span>: processing.<span class="hljs-property">whiteThreshold</span> ?? <span class="hljs-number">240</span>,
      <span class="hljs-attr">grayscale</span>: processing.<span class="hljs-property">grayscale</span>,
      <span class="hljs-attr">invert</span>: processing.<span class="hljs-property">invert</span>,
      <span class="hljs-attr">contrast</span>: processing.<span class="hljs-property">contrast</span>,
    });
    imageData = processed.<span class="hljs-property">imageData</span>;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// Load directly (use proxy for external URLs)</span>
    <span class="hljs-keyword">const</span> proxyUrl = <span class="hljs-title function_">proxyImageUrl</span>(url);
    <span class="hljs-keyword">const</span> img = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>&#x3C;<span class="hljs-title class_">HTMLImageElement</span>>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =></span> {
      <span class="hljs-keyword">const</span> img = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();
      img.<span class="hljs-property">crossOrigin</span> = <span class="hljs-string">'anonymous'</span>;
      img.<span class="hljs-property">onload</span> = <span class="hljs-function">() =></span> <span class="hljs-title function_">resolve</span>(img);
      img.<span class="hljs-property">onerror</span> = reject;
      img.<span class="hljs-property">src</span> = proxyUrl;
    });
    <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'canvas'</span>);
    canvas.<span class="hljs-property">width</span> = img.<span class="hljs-property">width</span>;
    canvas.<span class="hljs-property">height</span> = img.<span class="hljs-property">height</span>;
    <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>)!;
    ctx.<span class="hljs-title function_">drawImage</span>(img, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    imageData = ctx.<span class="hljs-title function_">getImageData</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, img.<span class="hljs-property">width</span>, img.<span class="hljs-property">height</span>);
  }

  <span class="hljs-keyword">const</span> { width, height, data } = imageData;
  <span class="hljs-keyword">const</span> targets = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&#x3C;<span class="hljs-built_in">string</span>, { <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">z</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">scale</span>: <span class="hljs-built_in">number</span> }>();
  <span class="hljs-keyword">const</span> stepX = width / gridSize;
  <span class="hljs-keyword">const</span> stepY = height / gridSize;

  <span class="hljs-comment">// Calculate scaled grid bounds (image is smaller and centered)</span>
  <span class="hljs-keyword">const</span> scaledGridSize = gridSize * imageScale;
  <span class="hljs-keyword">const</span> offset = (gridSize - scaledGridSize) / <span class="hljs-number">2</span>;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> gy = <span class="hljs-number">0</span>; gy &#x3C; gridSize; gy++) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> gx = <span class="hljs-number">0</span>; gx &#x3C; gridSize; gx++) {
      <span class="hljs-keyword">const</span> imgX = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(gx * stepX);
      <span class="hljs-keyword">const</span> imgY = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(gy * stepY);
      <span class="hljs-keyword">const</span> i = (imgY * width + imgX) * <span class="hljs-number">4</span>;

      <span class="hljs-keyword">const</span> r = data[i];
      <span class="hljs-keyword">const</span> g = data[i + <span class="hljs-number">1</span>];
      <span class="hljs-keyword">const</span> b = data[i + <span class="hljs-number">2</span>];
      <span class="hljs-keyword">const</span> a = data[i + <span class="hljs-number">3</span>];

      <span class="hljs-comment">// Grid position scaled and centered</span>
      <span class="hljs-keyword">const</span> x = (gx - gridSize / <span class="hljs-number">2</span>) * imageScale;
      <span class="hljs-keyword">const</span> y = ((gridSize - gy) - gridSize / <span class="hljs-number">2</span>) * imageScale;

      <span class="hljs-comment">// Calculate brightness and scale</span>
      <span class="hljs-keyword">const</span> brightness = (<span class="hljs-number">0.299</span> * r + <span class="hljs-number">0.587</span> * g + <span class="hljs-number">0.114</span> * b) / <span class="hljs-number">255</span>;
      <span class="hljs-keyword">const</span> isVisible = a > <span class="hljs-number">30</span>;

      <span class="hljs-comment">// Z-axis based on brightness (darker = closer to camera)</span>
      <span class="hljs-keyword">const</span> z = isVisible ? (<span class="hljs-number">1</span> - brightness) * depthScale : <span class="hljs-number">0</span>;

      <span class="hljs-comment">// Scale based on darkness (darker = larger sphere), also scaled down</span>
      <span class="hljs-keyword">const</span> scale = isVisible ? (<span class="hljs-number">1</span> - brightness) * sphereScale * imageScale : <span class="hljs-number">0</span>;

      <span class="hljs-keyword">const</span> key = <span class="hljs-string">`<span class="hljs-subst">${gx}</span>,<span class="hljs-subst">${gy}</span>`</span>;
      targets.<span class="hljs-title function_">set</span>(key, { x, y, z, scale });
    }
  }

  <span class="hljs-keyword">return</span> targets;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">easeInOutCubic</span>(<span class="hljs-params"><span class="hljs-attr">t</span>: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> {
  <span class="hljs-keyword">return</span> t &#x3C; <span class="hljs-number">0.5</span> ? <span class="hljs-number">4</span> * t * t * t : <span class="hljs-number">1</span> - <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(-<span class="hljs-number">2</span> * t + <span class="hljs-number">2</span>, <span class="hljs-number">3</span>) / <span class="hljs-number">2</span>;
}

<span class="hljs-comment">/**
 * Render a letter to canvas and return bitmap for voxelization
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">renderLetterBitmap</span>(<span class="hljs-params">
  <span class="hljs-attr">letter</span>: <span class="hljs-built_in">string</span>,
  <span class="hljs-attr">size</span>: <span class="hljs-built_in">number</span>,
  <span class="hljs-attr">fontFamily</span>: <span class="hljs-built_in">string</span>
</span>): <span class="hljs-built_in">boolean</span>[][] {
  <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'canvas'</span>);
  canvas.<span class="hljs-property">width</span> = size;
  canvas.<span class="hljs-property">height</span> = size;
  <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>)!;

  <span class="hljs-comment">// Clear</span>
  ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'#000000'</span>;
  ctx.<span class="hljs-title function_">fillRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, size, size);

  <span class="hljs-comment">// Draw letter</span>
  ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'#ffffff'</span>;
  ctx.<span class="hljs-property">font</span> = <span class="hljs-string">`bold <span class="hljs-subst">${size * <span class="hljs-number">0.75</span>}</span>px <span class="hljs-subst">${fontFamily}</span>`</span>;
  ctx.<span class="hljs-property">textAlign</span> = <span class="hljs-string">'center'</span>;
  ctx.<span class="hljs-property">textBaseline</span> = <span class="hljs-string">'middle'</span>;
  ctx.<span class="hljs-title function_">fillText</span>(letter, size / <span class="hljs-number">2</span>, size / <span class="hljs-number">2</span>);

  <span class="hljs-comment">// Get pixel data and convert to bitmap</span>
  <span class="hljs-keyword">const</span> imageData = ctx.<span class="hljs-title function_">getImageData</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, size, size);
  <span class="hljs-keyword">const</span> <span class="hljs-attr">bitmap</span>: <span class="hljs-built_in">boolean</span>[][] = [];

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> y = <span class="hljs-number">0</span>; y &#x3C; size; y++) {
    bitmap[y] = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> x = <span class="hljs-number">0</span>; x &#x3C; size; x++) {
      <span class="hljs-keyword">const</span> i = (y * size + x) * <span class="hljs-number">4</span>;
      <span class="hljs-keyword">const</span> brightness = imageData.<span class="hljs-property">data</span>[i]; <span class="hljs-comment">// Just red channel</span>
      bitmap[y][x] = brightness > <span class="hljs-number">128</span>;
    }
  }

  <span class="hljs-keyword">return</span> bitmap;
}

<span class="hljs-comment">/**
 * Generate true 3D type case layout
 * Creates compartment walls and 3D letter blocks that can rise up
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">generateTypeCaseData</span>(<span class="hljs-params">
  <span class="hljs-attr">gridSize</span>: <span class="hljs-built_in">number</span>,
  <span class="hljs-attr">sphereScale</span>: <span class="hljs-built_in">number</span>,
  <span class="hljs-attr">depthScale</span>: <span class="hljs-built_in">number</span>,
  <span class="hljs-attr">config</span>: <span class="hljs-title class_">TypeCaseConfig</span> = {}
</span>): <span class="hljs-title class_">Map</span>&#x3C;<span class="hljs-built_in">string</span>, { <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">z</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">scale</span>: <span class="hljs-built_in">number</span> }> {
  <span class="hljs-keyword">const</span> {
    cols = <span class="hljs-number">6</span>,
    rows = <span class="hljs-number">8</span>,
    <span class="hljs-attr">letters</span>: customLetters,
    featuredWord = <span class="hljs-string">'ORG-PRESS'</span>,
    fontFamily = <span class="hljs-string">'Georgia, Times, serif'</span>,
    cellGap = <span class="hljs-number">0.15</span>,
    letterElevation = <span class="hljs-number">1</span>,
  } = config;

  <span class="hljs-keyword">const</span> targets = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&#x3C;<span class="hljs-built_in">string</span>, { <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">z</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">scale</span>: <span class="hljs-built_in">number</span> }>();

  <span class="hljs-comment">// Calculate dimensions</span>
  <span class="hljs-comment">// The type case should fit nicely in the view</span>
  <span class="hljs-keyword">const</span> caseWidth = gridSize * <span class="hljs-number">0.4</span>;  <span class="hljs-comment">// 40% of grid width</span>
  <span class="hljs-keyword">const</span> caseHeight = gridSize * <span class="hljs-number">0.5</span>; <span class="hljs-comment">// 50% of grid height</span>
  <span class="hljs-keyword">const</span> caseDepth = depthScale * <span class="hljs-number">1.5</span>; <span class="hljs-comment">// How deep the compartments are</span>

  <span class="hljs-keyword">const</span> cellWidth = caseWidth / cols;
  <span class="hljs-keyword">const</span> cellHeight = caseHeight / rows;
  <span class="hljs-keyword">const</span> wallThickness = cellWidth * cellGap;
  <span class="hljs-keyword">const</span> letterResolution = <span class="hljs-number">12</span>; <span class="hljs-comment">// Dots per letter dimension</span>
  <span class="hljs-keyword">const</span> letterDepth = <span class="hljs-number">4</span>; <span class="hljs-comment">// How many layers deep the letter block is</span>

  <span class="hljs-comment">// Generate letter arrangement</span>
  <span class="hljs-keyword">const</span> defaultLetters = <span class="hljs-string">'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x26;'</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">''</span>);
  <span class="hljs-keyword">const</span> <span class="hljs-attr">cellLetters</span>: (<span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>)[][] = [];
  <span class="hljs-keyword">const</span> featuredChars = featuredWord.<span class="hljs-title function_">split</span>(<span class="hljs-string">''</span>);

  <span class="hljs-comment">// Place featured word in middle rows</span>
  <span class="hljs-keyword">const</span> featuredStartRow = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(rows / <span class="hljs-number">2</span>) - <span class="hljs-number">1</span>;
  <span class="hljs-keyword">let</span> featuredIndex = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">let</span> letterIndex = <span class="hljs-number">0</span>;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> row = <span class="hljs-number">0</span>; row &#x3C; rows; row++) {
    cellLetters[row] = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> col = <span class="hljs-number">0</span>; col &#x3C; cols; col++) {
      <span class="hljs-comment">// Featured word placement - spread across two middle rows</span>
      <span class="hljs-keyword">if</span> (row === featuredStartRow || row === featuredStartRow + <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">if</span> (featuredIndex &#x3C; featuredChars.<span class="hljs-property">length</span>) {
          cellLetters[row][col] = featuredChars[featuredIndex++];
        } <span class="hljs-keyword">else</span> {
          cellLetters[row][col] = <span class="hljs-literal">null</span>;
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// Random letters with some empty spaces</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() > <span class="hljs-number">0.15</span>) {
          <span class="hljs-keyword">const</span> available = customLetters?.<span class="hljs-property">length</span> ? customLetters : defaultLetters;
          cellLetters[row][col] = available[letterIndex % available.<span class="hljs-property">length</span>];
          letterIndex++;
        } <span class="hljs-keyword">else</span> {
          cellLetters[row][col] = <span class="hljs-literal">null</span>;
        }
      }
    }
  }

  <span class="hljs-comment">// Helper to add a sphere target</span>
  <span class="hljs-keyword">let</span> sphereIndex = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">addSphere</span> = (<span class="hljs-params"><span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">z</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">scale</span>: <span class="hljs-built_in">number</span></span>) => {
    <span class="hljs-comment">// Map to grid coordinates</span>
    <span class="hljs-keyword">const</span> gx = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((x + gridSize / <span class="hljs-number">2</span>) + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.5</span>);
    <span class="hljs-keyword">const</span> gy = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((gridSize / <span class="hljs-number">2</span> - y) + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.5</span>);
    <span class="hljs-keyword">const</span> key = <span class="hljs-string">`<span class="hljs-subst">${gx}</span>,<span class="hljs-subst">${gy}</span>,<span class="hljs-subst">${sphereIndex++}</span>`</span>;
    targets.<span class="hljs-title function_">set</span>(key, { x, y, z, scale });
  };

  <span class="hljs-comment">// Center offset for the case</span>
  <span class="hljs-keyword">const</span> offsetX = -caseWidth / <span class="hljs-number">2</span>;
  <span class="hljs-keyword">const</span> offsetY = caseHeight / <span class="hljs-number">2</span>;

  <span class="hljs-comment">// Build compartment walls (3D box edges)</span>
  <span class="hljs-keyword">const</span> wallDotSpacing = wallThickness * <span class="hljs-number">1.5</span>;
  <span class="hljs-keyword">const</span> wallDotScale = sphereScale * <span class="hljs-number">0.3</span>;

  <span class="hljs-comment">// Vertical walls (between columns)</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> col = <span class="hljs-number">0</span>; col &#x3C;= cols; col++) {
    <span class="hljs-keyword">const</span> x = offsetX + col * cellWidth;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> row = <span class="hljs-number">0</span>; row &#x3C; rows; row++) {
      <span class="hljs-keyword">const</span> yTop = offsetY - row * cellHeight;
      <span class="hljs-keyword">const</span> yBottom = offsetY - (row + <span class="hljs-number">1</span>) * cellHeight;

      <span class="hljs-comment">// Dots along the vertical edge, going down into Z</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> wy = yBottom; wy &#x3C;= yTop; wy += wallDotSpacing) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> wz = -caseDepth; wz &#x3C;= <span class="hljs-number">0</span>; wz += wallDotSpacing) {
          <span class="hljs-title function_">addSphere</span>(x, wy, wz, wallDotScale);
        }
      }
    }
  }

  <span class="hljs-comment">// Horizontal walls (between rows)</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> row = <span class="hljs-number">0</span>; row &#x3C;= rows; row++) {
    <span class="hljs-keyword">const</span> y = offsetY - row * cellHeight;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> col = <span class="hljs-number">0</span>; col &#x3C; cols; col++) {
      <span class="hljs-keyword">const</span> xLeft = offsetX + col * cellWidth;
      <span class="hljs-keyword">const</span> xRight = offsetX + (col + <span class="hljs-number">1</span>) * cellWidth;

      <span class="hljs-comment">// Dots along the horizontal edge, going down into Z</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> wx = xLeft; wx &#x3C;= xRight; wx += wallDotSpacing) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> wz = -caseDepth; wz &#x3C;= <span class="hljs-number">0</span>; wz += wallDotSpacing) {
          <span class="hljs-title function_">addSphere</span>(wx, y, wz, wallDotScale);
        }
      }
    }
  }

  <span class="hljs-comment">// Bottom of compartments (floor)</span>
  <span class="hljs-keyword">const</span> floorDotSpacing = cellWidth / <span class="hljs-number">4</span>;
  <span class="hljs-keyword">const</span> floorDotScale = sphereScale * <span class="hljs-number">0.15</span>;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> row = <span class="hljs-number">0</span>; row &#x3C; rows; row++) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> col = <span class="hljs-number">0</span>; col &#x3C; cols; col++) {
      <span class="hljs-keyword">const</span> cellCenterX = offsetX + (col + <span class="hljs-number">0.5</span>) * cellWidth;
      <span class="hljs-keyword">const</span> cellCenterY = offsetY - (row + <span class="hljs-number">0.5</span>) * cellHeight;

      <span class="hljs-comment">// Sparse dots on the floor</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> fx = -cellWidth / <span class="hljs-number">2</span> + wallThickness; fx &#x3C; cellWidth / <span class="hljs-number">2</span> - wallThickness; fx += floorDotSpacing) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> fy = -cellHeight / <span class="hljs-number">2</span> + wallThickness; fy &#x3C; cellHeight / <span class="hljs-number">2</span> - wallThickness; fy += floorDotSpacing) {
          <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() > <span class="hljs-number">0.5</span>) { <span class="hljs-comment">// Sparse</span>
            <span class="hljs-title function_">addSphere</span>(cellCenterX + fx, cellCenterY + fy, -caseDepth, floorDotScale);
          }
        }
      }
    }
  }

  <span class="hljs-comment">// Build 3D letter blocks</span>
  <span class="hljs-keyword">const</span> letterDotScale = sphereScale * <span class="hljs-number">0.5</span>;
  <span class="hljs-keyword">const</span> letterBlockHeight = depthScale * letterElevation; <span class="hljs-comment">// How high letters rise</span>

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> row = <span class="hljs-number">0</span>; row &#x3C; rows; row++) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> col = <span class="hljs-number">0</span>; col &#x3C; cols; col++) {
      <span class="hljs-keyword">const</span> letter = cellLetters[row][col];
      <span class="hljs-keyword">if</span> (!letter) <span class="hljs-keyword">continue</span>;

      <span class="hljs-comment">// Get letter bitmap</span>
      <span class="hljs-keyword">const</span> bitmap = <span class="hljs-title function_">renderLetterBitmap</span>(letter, letterResolution, fontFamily);

      <span class="hljs-comment">// Cell center position</span>
      <span class="hljs-keyword">const</span> cellCenterX = offsetX + (col + <span class="hljs-number">0.5</span>) * cellWidth;
      <span class="hljs-keyword">const</span> cellCenterY = offsetY - (row + <span class="hljs-number">0.5</span>) * cellHeight;

      <span class="hljs-comment">// Letter block dimensions (slightly smaller than cell)</span>
      <span class="hljs-keyword">const</span> letterWidth = cellWidth * <span class="hljs-number">0.7</span>;
      <span class="hljs-keyword">const</span> letterHeight = cellHeight * <span class="hljs-number">0.7</span>;
      <span class="hljs-keyword">const</span> dotSpacingX = letterWidth / letterResolution;
      <span class="hljs-keyword">const</span> dotSpacingY = letterHeight / letterResolution;
      <span class="hljs-keyword">const</span> dotSpacingZ = letterBlockHeight / letterDepth;

      <span class="hljs-comment">// Create 3D voxelized letter</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> ly = <span class="hljs-number">0</span>; ly &#x3C; letterResolution; ly++) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> lx = <span class="hljs-number">0</span>; lx &#x3C; letterResolution; lx++) {
          <span class="hljs-keyword">if</span> (!bitmap[ly][lx]) <span class="hljs-keyword">continue</span>; <span class="hljs-comment">// Skip empty pixels</span>

          <span class="hljs-comment">// Position within the cell</span>
          <span class="hljs-keyword">const</span> x = cellCenterX + (lx - letterResolution / <span class="hljs-number">2</span>) * dotSpacingX;
          <span class="hljs-keyword">const</span> y = cellCenterY + (letterResolution / <span class="hljs-number">2</span> - ly) * dotSpacingY;

          <span class="hljs-comment">// Create vertical stack of dots for the letter block</span>
          <span class="hljs-comment">// Letters rise from inside the case (negative Z) to above (positive Z)</span>
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> lz = <span class="hljs-number">0</span>; lz &#x3C; letterDepth; lz++) {
            <span class="hljs-keyword">const</span> z = -caseDepth * <span class="hljs-number">0.3</span> + lz * dotSpacingZ + letterBlockHeight;
            <span class="hljs-comment">// Slightly vary scale for top surface vs sides</span>
            <span class="hljs-keyword">const</span> scale = lz === letterDepth - <span class="hljs-number">1</span> ? letterDotScale : letterDotScale * <span class="hljs-number">0.8</span>;
            <span class="hljs-title function_">addSphere</span>(x, y, z, scale);
          }
        }
      }
    }
  }

  <span class="hljs-comment">// Now we need to map these 3D positions back to the grid indices</span>
  <span class="hljs-comment">// Since we have more spheres than grid positions, we'll use the grid as a pool</span>
  <span class="hljs-comment">// and assign spheres to grid positions based on proximity</span>

  <span class="hljs-comment">// Convert to grid-indexed map</span>
  <span class="hljs-keyword">const</span> gridTargets = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&#x3C;<span class="hljs-built_in">string</span>, { <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">z</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">scale</span>: <span class="hljs-built_in">number</span> }>();
  <span class="hljs-keyword">const</span> sphereList = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(targets.<span class="hljs-title function_">values</span>());

  <span class="hljs-comment">// Assign spheres to grid positions</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> gy = <span class="hljs-number">0</span>; gy &#x3C; gridSize; gy++) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> gx = <span class="hljs-number">0</span>; gx &#x3C; gridSize; gx++) {
      <span class="hljs-keyword">const</span> key = <span class="hljs-string">`<span class="hljs-subst">${gx}</span>,<span class="hljs-subst">${gy}</span>`</span>;

      <span class="hljs-keyword">if</span> (sphereList.<span class="hljs-property">length</span> > <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// Pop a sphere from our list</span>
        <span class="hljs-keyword">const</span> sphere = sphereList.<span class="hljs-title function_">pop</span>()!;
        gridTargets.<span class="hljs-title function_">set</span>(key, sphere);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// No more spheres, make this one invisible</span>
        gridTargets.<span class="hljs-title function_">set</span>(key, {
          <span class="hljs-attr">x</span>: (gx - gridSize / <span class="hljs-number">2</span>) * <span class="hljs-number">0.5</span>,
          <span class="hljs-attr">y</span>: ((gridSize - gy) - gridSize / <span class="hljs-number">2</span>) * <span class="hljs-number">0.5</span>,
          <span class="hljs-attr">z</span>: -depthScale * <span class="hljs-number">2</span>,
          <span class="hljs-attr">scale</span>: <span class="hljs-number">0</span>,
        });
      }
    }
  }

  <span class="hljs-keyword">return</span> gridTargets;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">easeOutExpo</span>(<span class="hljs-params"><span class="hljs-attr">t</span>: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> {
  <span class="hljs-keyword">return</span> t === <span class="hljs-number">1</span> ? <span class="hljs-number">1</span> : <span class="hljs-number">1</span> - <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">2</span>, -<span class="hljs-number">10</span> * t);
}

<span class="hljs-comment">/**
 * Interpolate between camera keyframes
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">interpolateCamera</span>(<span class="hljs-params">
  <span class="hljs-attr">keyframes</span>: <span class="hljs-title class_">CameraKeyframe</span>[],
  <span class="hljs-attr">progress</span>: <span class="hljs-built_in">number</span>,
  <span class="hljs-attr">camera</span>: THREE.<span class="hljs-title class_">PerspectiveCamera</span>
</span>) {
  <span class="hljs-keyword">if</span> (keyframes.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
  <span class="hljs-keyword">if</span> (keyframes.<span class="hljs-property">length</span> === <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">const</span> kf = keyframes[<span class="hljs-number">0</span>];
    camera.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(kf.<span class="hljs-property">position</span>.<span class="hljs-property">x</span>, kf.<span class="hljs-property">position</span>.<span class="hljs-property">y</span>, kf.<span class="hljs-property">position</span>.<span class="hljs-property">z</span>);
    <span class="hljs-keyword">if</span> (kf.<span class="hljs-property">lookAt</span>) camera.<span class="hljs-title function_">lookAt</span>(kf.<span class="hljs-property">lookAt</span>.<span class="hljs-property">x</span>, kf.<span class="hljs-property">lookAt</span>.<span class="hljs-property">y</span>, kf.<span class="hljs-property">lookAt</span>.<span class="hljs-property">z</span>);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">let</span> prevKf = keyframes[<span class="hljs-number">0</span>];
  <span class="hljs-keyword">let</span> nextKf = keyframes[keyframes.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>];

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &#x3C; keyframes.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>; i++) {
    <span class="hljs-keyword">if</span> (progress >= keyframes[i].<span class="hljs-property">at</span> &#x26;&#x26; progress &#x3C;= keyframes[i + <span class="hljs-number">1</span>].<span class="hljs-property">at</span>) {
      prevKf = keyframes[i];
      nextKf = keyframes[i + <span class="hljs-number">1</span>];
      <span class="hljs-keyword">break</span>;
    }
  }

  <span class="hljs-keyword">const</span> range = nextKf.<span class="hljs-property">at</span> - prevKf.<span class="hljs-property">at</span>;
  <span class="hljs-keyword">const</span> localProgress = range > <span class="hljs-number">0</span> ? (progress - prevKf.<span class="hljs-property">at</span>) / range : <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> t = <span class="hljs-title function_">easeInOutCubic</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">1</span>, localProgress)));

  camera.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(
    <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">MathUtils</span>.<span class="hljs-title function_">lerp</span>(prevKf.<span class="hljs-property">position</span>.<span class="hljs-property">x</span>, nextKf.<span class="hljs-property">position</span>.<span class="hljs-property">x</span>, t),
    <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">MathUtils</span>.<span class="hljs-title function_">lerp</span>(prevKf.<span class="hljs-property">position</span>.<span class="hljs-property">y</span>, nextKf.<span class="hljs-property">position</span>.<span class="hljs-property">y</span>, t),
    <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">MathUtils</span>.<span class="hljs-title function_">lerp</span>(prevKf.<span class="hljs-property">position</span>.<span class="hljs-property">z</span>, nextKf.<span class="hljs-property">position</span>.<span class="hljs-property">z</span>, t)
  );

  <span class="hljs-keyword">const</span> prevLookAt = prevKf.<span class="hljs-property">lookAt</span> || { <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">z</span>: <span class="hljs-number">0</span> };
  <span class="hljs-keyword">const</span> nextLookAt = nextKf.<span class="hljs-property">lookAt</span> || { <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">z</span>: <span class="hljs-number">0</span> };
  camera.<span class="hljs-title function_">lookAt</span>(
    <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">MathUtils</span>.<span class="hljs-title function_">lerp</span>(prevLookAt.<span class="hljs-property">x</span>, nextLookAt.<span class="hljs-property">x</span>, t),
    <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">MathUtils</span>.<span class="hljs-title function_">lerp</span>(prevLookAt.<span class="hljs-property">y</span>, nextLookAt.<span class="hljs-property">y</span>, t),
    <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">MathUtils</span>.<span class="hljs-title function_">lerp</span>(prevLookAt.<span class="hljs-property">z</span>, nextLookAt.<span class="hljs-property">z</span>, t)
  );
}

<span class="hljs-comment">/**
 * Interpolate flow position based on time
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getFlowOffset</span>(<span class="hljs-params">
  <span class="hljs-attr">flowPath</span>: <span class="hljs-title class_">FlowWaypoint</span>[],
  <span class="hljs-attr">flowProgress</span>: <span class="hljs-built_in">number</span>
</span>): { <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span> } {
  <span class="hljs-keyword">if</span> (flowPath.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> { <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> };
  <span class="hljs-keyword">if</span> (flowPath.<span class="hljs-property">length</span> === <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> { <span class="hljs-attr">x</span>: flowPath[<span class="hljs-number">0</span>].<span class="hljs-property">x</span>, <span class="hljs-attr">y</span>: flowPath[<span class="hljs-number">0</span>].<span class="hljs-property">y</span> };

  <span class="hljs-comment">// Find surrounding waypoints</span>
  <span class="hljs-keyword">let</span> prevWp = flowPath[<span class="hljs-number">0</span>];
  <span class="hljs-keyword">let</span> nextWp = flowPath[flowPath.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>];

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &#x3C; flowPath.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>; i++) {
    <span class="hljs-keyword">if</span> (flowProgress >= flowPath[i].<span class="hljs-property">at</span> &#x26;&#x26; flowProgress &#x3C;= flowPath[i + <span class="hljs-number">1</span>].<span class="hljs-property">at</span>) {
      prevWp = flowPath[i];
      nextWp = flowPath[i + <span class="hljs-number">1</span>];
      <span class="hljs-keyword">break</span>;
    }
  }

  <span class="hljs-keyword">const</span> range = nextWp.<span class="hljs-property">at</span> - prevWp.<span class="hljs-property">at</span>;
  <span class="hljs-keyword">const</span> localProgress = range > <span class="hljs-number">0</span> ? (flowProgress - prevWp.<span class="hljs-property">at</span>) / range : <span class="hljs-number">0</span>;
  <span class="hljs-comment">// Smooth easing for flow</span>
  <span class="hljs-keyword">const</span> t = <span class="hljs-title function_">easeInOutCubic</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">1</span>, localProgress)));

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">x</span>: prevWp.<span class="hljs-property">x</span> + (nextWp.<span class="hljs-property">x</span> - prevWp.<span class="hljs-property">x</span>) * t,
    <span class="hljs-attr">y</span>: prevWp.<span class="hljs-property">y</span> + (nextWp.<span class="hljs-property">y</span> - prevWp.<span class="hljs-property">y</span>) * t,
  };
}

<span class="hljs-comment">/**
 * Create background halftone with relief effect and slow settling
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createBackgroundHalftone</span>(<span class="hljs-params">
  <span class="hljs-attr">options</span>: <span class="hljs-title class_">BackgroundHalftoneOptions</span>
</span>): <span class="hljs-title class_">Promise</span>&#x3C;<span class="hljs-title class_">BackgroundHalftoneResult</span>> {
  <span class="hljs-keyword">const</span> {
    imageUrl,
    gridSize = <span class="hljs-number">80</span>,
    sphereScale = <span class="hljs-number">0.4</span>,
    backgroundColor = <span class="hljs-number">0x111111</span>,
    sphereColor = <span class="hljs-number">0xffffff</span>,
    cameraKeyframes = [
      { <span class="hljs-attr">at</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">position</span>: { <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">z</span>: <span class="hljs-number">70</span> }, <span class="hljs-attr">lookAt</span>: { <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">z</span>: <span class="hljs-number">0</span> } },
      { <span class="hljs-attr">at</span>: <span class="hljs-number">0.5</span>, <span class="hljs-attr">position</span>: { <span class="hljs-attr">x</span>: <span class="hljs-number">25</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">z</span>: <span class="hljs-number">60</span> }, <span class="hljs-attr">lookAt</span>: { <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">z</span>: <span class="hljs-number">0</span> } },
      { <span class="hljs-attr">at</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">position</span>: { <span class="hljs-attr">x</span>: -<span class="hljs-number">15</span>, <span class="hljs-attr">y</span>: -<span class="hljs-number">5</span>, <span class="hljs-attr">z</span>: <span class="hljs-number">50</span> }, <span class="hljs-attr">lookAt</span>: { <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">z</span>: <span class="hljs-number">0</span> } },
    ],
    quickRevealDuration = <span class="hljs-number">3</span>,
    settlingDuration = <span class="hljs-number">300</span>, <span class="hljs-comment">// 5 minutes</span>
    depthScale = <span class="hljs-number">8</span>,
    imageScale = <span class="hljs-number">0.5</span>, <span class="hljs-comment">// Image takes 50% of grid by default</span>
    flowPath = [
      <span class="hljs-comment">// Default flow: top-left → bottom-right → center → loop</span>
      { <span class="hljs-attr">x</span>: -<span class="hljs-number">15</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">at</span>: <span class="hljs-number">0</span> },
      { <span class="hljs-attr">x</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">y</span>: -<span class="hljs-number">8</span>, <span class="hljs-attr">at</span>: <span class="hljs-number">0.33</span> },
      { <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">at</span>: <span class="hljs-number">0.66</span> },
      { <span class="hljs-attr">x</span>: -<span class="hljs-number">15</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">at</span>: <span class="hljs-number">1</span> }, <span class="hljs-comment">// Loop back</span>
    ],
    flowDuration = <span class="hljs-number">90</span>, <span class="hljs-comment">// 90 seconds per cycle</span>
    imageProcessing = { <span class="hljs-attr">removeWhiteBackground</span>: <span class="hljs-literal">true</span> },
  } = options;

  <span class="hljs-comment">// Setup Three.js</span>
  <span class="hljs-keyword">const</span> scene = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Scene</span>();
  scene.<span class="hljs-property">background</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Color</span>(backgroundColor);
  <span class="hljs-keyword">const</span> camera = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PerspectiveCamera</span>(<span class="hljs-number">50</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">1000</span>);
  <span class="hljs-keyword">const</span> renderer = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">WebGLRenderer</span>({ <span class="hljs-attr">antialias</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">alpha</span>: <span class="hljs-literal">true</span> });
  renderer.<span class="hljs-title function_">setPixelRatio</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">devicePixelRatio</span>, <span class="hljs-number">2</span>));

  <span class="hljs-comment">// Flat white spheres (no lighting)</span>
  <span class="hljs-keyword">const</span> sphereGeometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">SphereGeometry</span>(<span class="hljs-number">0.5</span>, <span class="hljs-number">8</span>, <span class="hljs-number">8</span>);
  <span class="hljs-keyword">const</span> sphereMaterial = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshBasicMaterial</span>({ <span class="hljs-attr">color</span>: sphereColor });

  <span class="hljs-keyword">const</span> totalSpheres = gridSize * gridSize;
  <span class="hljs-keyword">const</span> instancedMesh = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">InstancedMesh</span>(sphereGeometry, sphereMaterial, totalSpheres);
  scene.<span class="hljs-title function_">add</span>(instancedMesh);

  <span class="hljs-comment">// Initialize ALL spheres at center with zero scale</span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">sphereStates</span>: <span class="hljs-title class_">SphereState</span>[] = [];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> gy = <span class="hljs-number">0</span>; gy &#x3C; gridSize; gy++) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> gx = <span class="hljs-number">0</span>; gx &#x3C; gridSize; gx++) {
      sphereStates.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">gridX</span>: gx,
        <span class="hljs-attr">gridY</span>: gy,
        <span class="hljs-attr">currentPosition</span>: <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>),
        <span class="hljs-attr">targetPosition</span>: <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>),
        <span class="hljs-attr">currentScale</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">targetScale</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">delay</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>(),
        <span class="hljs-attr">speed</span>: <span class="hljs-number">0.7</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.6</span>,
        <span class="hljs-attr">active</span>: <span class="hljs-literal">false</span>,
      });
    }
  }

  <span class="hljs-comment">// Load initial image data</span>
  <span class="hljs-keyword">const</span> initialData = <span class="hljs-keyword">await</span> <span class="hljs-title function_">loadImageData</span>(imageUrl, gridSize, sphereScale, depthScale, imageScale, imageProcessing);

  <span class="hljs-comment">// Set initial targets for all spheres</span>
  sphereStates.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">state, i</span>) =></span> {
    <span class="hljs-keyword">const</span> key = <span class="hljs-string">`<span class="hljs-subst">${state.gridX}</span>,<span class="hljs-subst">${state.gridY}</span>`</span>;
    <span class="hljs-keyword">const</span> data = initialData.<span class="hljs-title function_">get</span>(key);
    <span class="hljs-keyword">if</span> (data &#x26;&#x26; data.<span class="hljs-property">scale</span> > <span class="hljs-number">0.01</span>) {
      state.<span class="hljs-property">targetPosition</span>.<span class="hljs-title function_">set</span>(data.<span class="hljs-property">x</span>, data.<span class="hljs-property">y</span>, data.<span class="hljs-property">z</span>);
      state.<span class="hljs-property">targetScale</span> = data.<span class="hljs-property">scale</span>;
      state.<span class="hljs-property">active</span> = <span class="hljs-literal">true</span>;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// Inactive spheres go to their grid position but with 0 scale</span>
      <span class="hljs-keyword">const</span> x = state.<span class="hljs-property">gridX</span> - gridSize / <span class="hljs-number">2</span>;
      <span class="hljs-keyword">const</span> y = (gridSize - state.<span class="hljs-property">gridY</span>) - gridSize / <span class="hljs-number">2</span>;
      state.<span class="hljs-property">targetPosition</span>.<span class="hljs-title function_">set</span>(x, y, <span class="hljs-number">0</span>);
      state.<span class="hljs-property">targetScale</span> = <span class="hljs-number">0</span>;
      state.<span class="hljs-property">active</span> = <span class="hljs-literal">false</span>;
    }
  });

  <span class="hljs-comment">// Animation state</span>
  <span class="hljs-keyword">let</span> <span class="hljs-attr">animationId</span>: <span class="hljs-built_in">number</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">let</span> <span class="hljs-attr">startTime</span>: <span class="hljs-built_in">number</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">let</span> <span class="hljs-attr">transitionStartTime</span>: <span class="hljs-built_in">number</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">let</span> currentScrollProgress = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> matrix = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Matrix4</span>();

  <span class="hljs-comment">// Store previous state for transitions</span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">prevPositions</span>: <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">Vector3</span>[] = sphereStates.<span class="hljs-title function_">map</span>(<span class="hljs-function">() =></span> <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>());
  <span class="hljs-keyword">const</span> <span class="hljs-attr">prevScales</span>: <span class="hljs-built_in">number</span>[] = sphereStates.<span class="hljs-title function_">map</span>(<span class="hljs-function">() =></span> <span class="hljs-number">0</span>);

  <span class="hljs-comment">// Collapse/restore state</span>
  <span class="hljs-keyword">let</span> collapsed = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">const</span> <span class="hljs-attr">expandedTargets</span>: <span class="hljs-title class_">Array</span>&#x3C;{ <span class="hljs-attr">position</span>: <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">Vector3</span>; <span class="hljs-attr">scale</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">active</span>: <span class="hljs-built_in">boolean</span> }> =
    sphereStates.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">s</span> =></span> ({
      <span class="hljs-attr">position</span>: s.<span class="hljs-property">targetPosition</span>.<span class="hljs-title function_">clone</span>(),
      <span class="hljs-attr">scale</span>: s.<span class="hljs-property">targetScale</span>,
      <span class="hljs-attr">active</span>: s.<span class="hljs-property">active</span>,
    }));

  <span class="hljs-comment">// Mouse tracking for perspective tilt</span>
  <span class="hljs-keyword">let</span> mouseX = <span class="hljs-number">0</span>; <span class="hljs-comment">// -1 to 1 (left to right)</span>
  <span class="hljs-keyword">let</span> mouseY = <span class="hljs-number">0</span>; <span class="hljs-comment">// -1 to 1 (top to bottom)</span>
  <span class="hljs-keyword">let</span> targetMouseX = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">let</span> targetMouseY = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> tiltSmoothing = <span class="hljs-number">0.06</span>; <span class="hljs-comment">// Smoothing factor (lower = smoother)</span>

  <span class="hljs-comment">// Track mouse movement</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleMouseMove</span> = (<span class="hljs-params"><span class="hljs-attr">e</span>: <span class="hljs-title class_">MouseEvent</span></span>) => {
    <span class="hljs-comment">// Normalize to -1 to 1 range</span>
    targetMouseX = (e.<span class="hljs-property">clientX</span> / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>) * <span class="hljs-number">2</span> - <span class="hljs-number">1</span>;
    targetMouseY = (e.<span class="hljs-property">clientY</span> / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>) * <span class="hljs-number">2</span> - <span class="hljs-number">1</span>;
  };
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mousemove'</span>, handleMouseMove, { <span class="hljs-attr">passive</span>: <span class="hljs-literal">true</span> });

  <span class="hljs-comment">// Fluid motion parameters for collapsed state (per-sphere)</span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">fluidParams</span>: <span class="hljs-title class_">Array</span>&#x3C;{
    <span class="hljs-attr">orbitRadius</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">orbitSpeed</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">orbitPhase</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">verticalSpeed</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">verticalPhase</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">pulseSpeed</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">pulsePhase</span>: <span class="hljs-built_in">number</span>;
  }> = sphereStates.<span class="hljs-title function_">map</span>(<span class="hljs-function">() =></span> ({
    <span class="hljs-attr">orbitRadius</span>: <span class="hljs-number">0.5</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">1.5</span>,      <span class="hljs-comment">// How far from center it orbits</span>
    <span class="hljs-attr">orbitSpeed</span>: <span class="hljs-number">0.3</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.4</span>,       <span class="hljs-comment">// Orbit speed</span>
    <span class="hljs-attr">orbitPhase</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>,     <span class="hljs-comment">// Starting angle</span>
    <span class="hljs-attr">verticalSpeed</span>: <span class="hljs-number">0.2</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.3</span>,    <span class="hljs-comment">// Vertical bob speed</span>
    <span class="hljs-attr">verticalPhase</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>,  <span class="hljs-comment">// Vertical phase</span>
    <span class="hljs-attr">pulseSpeed</span>: <span class="hljs-number">0.5</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.5</span>,       <span class="hljs-comment">// Scale pulse speed</span>
    <span class="hljs-attr">pulsePhase</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>,     <span class="hljs-comment">// Scale pulse phase</span>
  }));

  <span class="hljs-comment">// Formation mode: 'normal' | 'globe' | 'solarSystem'</span>
  <span class="hljs-keyword">let</span> <span class="hljs-attr">formationMode</span>: <span class="hljs-string">'normal'</span> | <span class="hljs-string">'globe'</span> | <span class="hljs-string">'solarSystem'</span> = <span class="hljs-string">'normal'</span>;
  <span class="hljs-keyword">let</span> <span class="hljs-attr">formationStartTime</span>: <span class="hljs-built_in">number</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-comment">// Per-sphere colors for special formations</span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">sphereColors</span>: <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">Color</span>[] = sphereStates.<span class="hljs-title function_">map</span>(<span class="hljs-function">() =></span> <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Color</span>(sphereColor));
  <span class="hljs-keyword">const</span> defaultColor = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Color</span>(sphereColor);
  <span class="hljs-keyword">let</span> useInstanceColors = <span class="hljs-literal">false</span>;

  <span class="hljs-comment">// Globe formation parameters</span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">globeParams</span>: <span class="hljs-title class_">Array</span>&#x3C;{
    <span class="hljs-attr">theta</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// longitude</span>
    <span class="hljs-attr">phi</span>: <span class="hljs-built_in">number</span>;   <span class="hljs-comment">// latitude</span>
    <span class="hljs-attr">rotationSpeed</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">glowPhase</span>: <span class="hljs-built_in">number</span>;
  }> = sphereStates.<span class="hljs-title function_">map</span>(<span class="hljs-function">() =></span> ({
    <span class="hljs-attr">theta</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>,
    <span class="hljs-attr">phi</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">acos</span>(<span class="hljs-number">2</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">1</span>),
    <span class="hljs-attr">rotationSpeed</span>: <span class="hljs-number">0.15</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.1</span>,
    <span class="hljs-attr">glowPhase</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>,
  }));

  <span class="hljs-comment">// Solar system formation parameters</span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">solarParams</span>: <span class="hljs-title class_">Array</span>&#x3C;{
    <span class="hljs-attr">orbitRadius</span>: <span class="hljs-built_in">number</span>;  <span class="hljs-comment">// Distance from center</span>
    <span class="hljs-attr">orbitAngle</span>: <span class="hljs-built_in">number</span>;   <span class="hljs-comment">// Current angle in orbit</span>
    <span class="hljs-attr">orbitSpeed</span>: <span class="hljs-built_in">number</span>;   <span class="hljs-comment">// Speed of orbit</span>
    <span class="hljs-attr">orbitTilt</span>: <span class="hljs-built_in">number</span>;    <span class="hljs-comment">// Tilt of orbit plane</span>
    <span class="hljs-attr">glowPhase</span>: <span class="hljs-built_in">number</span>;    <span class="hljs-comment">// For pulsing</span>
    <span class="hljs-attr">isCenter</span>: <span class="hljs-built_in">boolean</span>;    <span class="hljs-comment">// Is this the center sphere?</span>
  }> = sphereStates.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">_, i</span>) =></span> ({
    <span class="hljs-attr">orbitRadius</span>: <span class="hljs-number">5</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">15</span>,
    <span class="hljs-attr">orbitAngle</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>,
    <span class="hljs-attr">orbitSpeed</span>: <span class="hljs-number">0.1</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.15</span>,
    <span class="hljs-attr">orbitTilt</span>: (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">0.5</span>) * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">0.3</span>,
    <span class="hljs-attr">glowPhase</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>,
    <span class="hljs-attr">isCenter</span>: i === <span class="hljs-number">0</span>, <span class="hljs-comment">// First sphere is center</span>
  }));

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">updateSpheres</span>(<span class="hljs-params"><span class="hljs-attr">timestamp</span>: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-keyword">if</span> (startTime === <span class="hljs-literal">null</span>) startTime = timestamp;
    <span class="hljs-keyword">const</span> elapsed = (timestamp - startTime) / <span class="hljs-number">1000</span>;

    <span class="hljs-comment">// Calculate flow offset (continuous looping movement)</span>
    <span class="hljs-keyword">const</span> flowProgress = (elapsed % flowDuration) / flowDuration;
    <span class="hljs-keyword">const</span> flowOffset = <span class="hljs-title function_">getFlowOffset</span>(flowPath, flowProgress);

    <span class="hljs-comment">// Handle image transition</span>
    <span class="hljs-keyword">if</span> (transitionStartTime !== <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">const</span> transitionElapsed = (timestamp - transitionStartTime) / <span class="hljs-number">1000</span>;
      <span class="hljs-keyword">const</span> transitionDuration = <span class="hljs-number">2</span>; <span class="hljs-comment">// 2 second transition</span>
      <span class="hljs-keyword">const</span> tProgress = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">1</span>, transitionElapsed / transitionDuration);
      <span class="hljs-keyword">const</span> tEased = <span class="hljs-title function_">easeInOutCubic</span>(tProgress);

      sphereStates.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">state, i</span>) =></span> {
        state.<span class="hljs-property">currentPosition</span>.<span class="hljs-title function_">lerpVectors</span>(prevPositions[i], state.<span class="hljs-property">targetPosition</span>, tEased);
        state.<span class="hljs-property">currentScale</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">MathUtils</span>.<span class="hljs-title function_">lerp</span>(prevScales[i], state.<span class="hljs-property">targetScale</span>, tEased);
      });

      <span class="hljs-keyword">if</span> (tProgress >= <span class="hljs-number">1</span>) {
        transitionStartTime = <span class="hljs-literal">null</span>;
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// Normal animation: quick reveal then slow settling</span>
      sphereStates.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">state, i</span>) =></span> {
        <span class="hljs-comment">// Staggered start based on delay</span>
        <span class="hljs-keyword">const</span> adjustedTime = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, elapsed - state.<span class="hljs-property">delay</span> * quickRevealDuration);

        <span class="hljs-comment">// Quick reveal phase (first few seconds - image becomes visible)</span>
        <span class="hljs-keyword">const</span> quickProgress = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">1</span>, adjustedTime / quickRevealDuration);
        <span class="hljs-keyword">const</span> quickEased = <span class="hljs-title function_">easeOutExpo</span>(quickProgress);

        <span class="hljs-comment">// Slow settling phase (continues for minutes - subtle drift to final position)</span>
        <span class="hljs-keyword">const</span> settlingProgress = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">1</span>, adjustedTime / settlingDuration);
        <span class="hljs-keyword">const</span> settlingEased = <span class="hljs-title function_">easeOutExpo</span>(settlingProgress);

        <span class="hljs-comment">// Combine: quick reveal gets ~90% there, settling gets the last 10%</span>
        <span class="hljs-keyword">const</span> totalProgress = quickEased * <span class="hljs-number">0.9</span> + settlingEased * <span class="hljs-number">0.1</span>;

        <span class="hljs-comment">// Position interpolation from center</span>
        <span class="hljs-keyword">const</span> centerX = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">const</span> centerY = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">const</span> centerZ = -<span class="hljs-number">20</span>; <span class="hljs-comment">// Start behind the "plane"</span>

        state.<span class="hljs-property">currentPosition</span>.<span class="hljs-title function_">set</span>(
          <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">MathUtils</span>.<span class="hljs-title function_">lerp</span>(centerX, state.<span class="hljs-property">targetPosition</span>.<span class="hljs-property">x</span>, totalProgress),
          <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">MathUtils</span>.<span class="hljs-title function_">lerp</span>(centerY, state.<span class="hljs-property">targetPosition</span>.<span class="hljs-property">y</span>, totalProgress),
          <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">MathUtils</span>.<span class="hljs-title function_">lerp</span>(centerZ, state.<span class="hljs-property">targetPosition</span>.<span class="hljs-property">z</span>, totalProgress)
        );

        <span class="hljs-comment">// Scale animation</span>
        state.<span class="hljs-property">currentScale</span> = state.<span class="hljs-property">targetScale</span> * quickEased;
      });
    }

    <span class="hljs-comment">// Update instanced mesh with flow offset applied</span>
    sphereStates.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">state, i</span>) =></span> {
      <span class="hljs-keyword">let</span> scale = state.<span class="hljs-property">currentScale</span>;
      <span class="hljs-keyword">let</span> posX = state.<span class="hljs-property">currentPosition</span>.<span class="hljs-property">x</span> + flowOffset.<span class="hljs-property">x</span>;
      <span class="hljs-keyword">let</span> posY = state.<span class="hljs-property">currentPosition</span>.<span class="hljs-property">y</span> + flowOffset.<span class="hljs-property">y</span>;
      <span class="hljs-keyword">let</span> posZ = state.<span class="hljs-property">currentPosition</span>.<span class="hljs-property">z</span>;

      <span class="hljs-comment">// Apply fluid motion when collapsed</span>
      <span class="hljs-keyword">if</span> (collapsed &#x26;&#x26; transitionStartTime === <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">const</span> fp = fluidParams[i];

        <span class="hljs-comment">// Gentle orbital motion around center</span>
        <span class="hljs-keyword">const</span> orbitAngle = fp.<span class="hljs-property">orbitPhase</span> + elapsed * fp.<span class="hljs-property">orbitSpeed</span>;
        <span class="hljs-keyword">const</span> orbitX = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(orbitAngle) * fp.<span class="hljs-property">orbitRadius</span>;
        <span class="hljs-keyword">const</span> orbitY = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(orbitAngle) * fp.<span class="hljs-property">orbitRadius</span> * <span class="hljs-number">0.6</span>; <span class="hljs-comment">// Elliptical</span>

        <span class="hljs-comment">// Vertical floating bob</span>
        <span class="hljs-keyword">const</span> verticalBob = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(fp.<span class="hljs-property">verticalPhase</span> + elapsed * fp.<span class="hljs-property">verticalSpeed</span>) * <span class="hljs-number">0.8</span>;

        <span class="hljs-comment">// Subtle depth oscillation</span>
        <span class="hljs-keyword">const</span> depthBob = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(fp.<span class="hljs-property">orbitPhase</span> + elapsed * fp.<span class="hljs-property">orbitSpeed</span> * <span class="hljs-number">0.5</span>) * <span class="hljs-number">0.5</span>;

        <span class="hljs-comment">// Apply fluid offsets</span>
        posX += orbitX;
        posY += orbitY + verticalBob;
        posZ += depthBob;

        <span class="hljs-comment">// Gentle scale pulsing (breathing effect)</span>
        <span class="hljs-keyword">const</span> pulse = <span class="hljs-number">1</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(fp.<span class="hljs-property">pulsePhase</span> + elapsed * fp.<span class="hljs-property">pulseSpeed</span>) * <span class="hljs-number">0.15</span>;
        scale *= pulse;
      }

      <span class="hljs-comment">// Globe formation: spheres on a rotating sphere surface</span>
      <span class="hljs-keyword">if</span> (formationMode === <span class="hljs-string">'globe'</span> &#x26;&#x26; transitionStartTime === <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">const</span> gp = globeParams[i];
        <span class="hljs-keyword">const</span> globeRadius = <span class="hljs-number">12</span>;

        <span class="hljs-comment">// Rotate theta over time (longitude rotation)</span>
        <span class="hljs-keyword">const</span> theta = gp.<span class="hljs-property">theta</span> + elapsed * gp.<span class="hljs-property">rotationSpeed</span>;
        <span class="hljs-keyword">const</span> phi = gp.<span class="hljs-property">phi</span>;

        <span class="hljs-comment">// Spherical to Cartesian</span>
        posX = globeRadius * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(phi) * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(theta);
        posY = globeRadius * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(phi);
        posZ = globeRadius * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(phi) * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(theta) + <span class="hljs-number">8</span>; <span class="hljs-comment">// Offset forward</span>

        <span class="hljs-comment">// Random glow pulsing with color</span>
        <span class="hljs-keyword">const</span> glowPulse = <span class="hljs-number">0.5</span> + <span class="hljs-number">0.5</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(gp.<span class="hljs-property">glowPhase</span> + elapsed * <span class="hljs-number">0.8</span>);
        scale = <span class="hljs-number">0.6</span> + glowPulse * <span class="hljs-number">0.3</span>;
      }

      <span class="hljs-comment">// Solar system formation: center sphere with orbiting smaller spheres</span>
      <span class="hljs-keyword">if</span> (formationMode === <span class="hljs-string">'solarSystem'</span> &#x26;&#x26; transitionStartTime === <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">const</span> sp = solarParams[i];

        <span class="hljs-keyword">if</span> (sp.<span class="hljs-property">isCenter</span>) {
          <span class="hljs-comment">// Large glowing center sphere</span>
          posX = <span class="hljs-number">0</span>;
          posY = <span class="hljs-number">0</span>;
          posZ = <span class="hljs-number">8</span>;
          <span class="hljs-comment">// Pulsing glow effect for center</span>
          <span class="hljs-keyword">const</span> centerPulse = <span class="hljs-number">1</span> + <span class="hljs-number">0.15</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(elapsed * <span class="hljs-number">0.5</span>);
          scale = <span class="hljs-number">3</span> * centerPulse;
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-comment">// Orbiting spheres</span>
          <span class="hljs-keyword">const</span> angle = sp.<span class="hljs-property">orbitAngle</span> + elapsed * sp.<span class="hljs-property">orbitSpeed</span>;
          <span class="hljs-keyword">const</span> tiltedY = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(angle) * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(sp.<span class="hljs-property">orbitTilt</span>);
          <span class="hljs-keyword">const</span> tiltedZ = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(angle) * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(sp.<span class="hljs-property">orbitTilt</span>);

          posX = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(angle) * sp.<span class="hljs-property">orbitRadius</span>;
          posY = tiltedY * sp.<span class="hljs-property">orbitRadius</span> * <span class="hljs-number">0.3</span>;
          posZ = tiltedZ * sp.<span class="hljs-property">orbitRadius</span> * <span class="hljs-number">0.5</span> + <span class="hljs-number">8</span>;

          <span class="hljs-comment">// Orbiting spheres are smaller with gentle pulse</span>
          <span class="hljs-keyword">const</span> orbitPulse = <span class="hljs-number">0.8</span> + <span class="hljs-number">0.2</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(sp.<span class="hljs-property">glowPhase</span> + elapsed * <span class="hljs-number">0.6</span>);
          scale = <span class="hljs-number">0.4</span> * orbitPulse;
        }
      }

      <span class="hljs-keyword">if</span> (scale &#x3C; <span class="hljs-number">0.001</span>) {
        matrix.<span class="hljs-title function_">makeScale</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
      } <span class="hljs-keyword">else</span> {
        matrix.<span class="hljs-title function_">makeScale</span>(scale, scale, scale);
        matrix.<span class="hljs-title function_">setPosition</span>(posX, posY, posZ);
      }
      instancedMesh.<span class="hljs-title function_">setMatrixAt</span>(i, matrix);

      <span class="hljs-comment">// Update instance colors if enabled</span>
      <span class="hljs-keyword">if</span> (useInstanceColors) {
        instancedMesh.<span class="hljs-title function_">setColorAt</span>(i, sphereColors[i]);
      }
    });
    instancedMesh.<span class="hljs-property">instanceMatrix</span>.<span class="hljs-property">needsUpdate</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">if</span> (useInstanceColors &#x26;&#x26; instancedMesh.<span class="hljs-property">instanceColor</span>) {
      instancedMesh.<span class="hljs-property">instanceColor</span>.<span class="hljs-property">needsUpdate</span> = <span class="hljs-literal">true</span>;
    }
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params"><span class="hljs-attr">timestamp</span>: <span class="hljs-built_in">number</span></span>) {
    animationId = <span class="hljs-title function_">requestAnimationFrame</span>(render);
    <span class="hljs-title function_">updateSpheres</span>(timestamp);

    <span class="hljs-comment">// Smooth mouse tracking</span>
    mouseX += (targetMouseX - mouseX) * tiltSmoothing;
    mouseY += (targetMouseY - mouseY) * tiltSmoothing;

    <span class="hljs-comment">// Interpolate camera from keyframes</span>
    <span class="hljs-title function_">interpolateCamera</span>(cameraKeyframes, currentScrollProgress, camera);

    <span class="hljs-comment">// Apply Y-axis rotation based on mouse position</span>
    <span class="hljs-comment">// Like turning your head left/right to look around</span>
    <span class="hljs-keyword">const</span> rotateY = -mouseX * <span class="hljs-number">0.12</span>; <span class="hljs-comment">// Radians, subtle rotation</span>
    <span class="hljs-keyword">const</span> rotateX = mouseY * <span class="hljs-number">0.06</span>;  <span class="hljs-comment">// Slight vertical look</span>

    <span class="hljs-comment">// Rotate camera around world Y axis (look left/right)</span>
    camera.<span class="hljs-title function_">rotateOnWorldAxis</span>(<span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>), rotateY);
    <span class="hljs-comment">// Slight X rotation for vertical mouse movement</span>
    camera.<span class="hljs-title function_">rotateX</span>(rotateX);

    renderer.<span class="hljs-title function_">render</span>(scene, camera);
  }

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">start</span> = (<span class="hljs-params"></span>) => {
    <span class="hljs-keyword">if</span> (animationId === <span class="hljs-literal">null</span>) {
      animationId = <span class="hljs-title function_">requestAnimationFrame</span>(render);
    }
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">stop</span> = (<span class="hljs-params"></span>) => {
    <span class="hljs-keyword">if</span> (animationId !== <span class="hljs-literal">null</span>) {
      <span class="hljs-title function_">cancelAnimationFrame</span>(animationId);
      animationId = <span class="hljs-literal">null</span>;
    }
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">setScrollProgress</span> = (<span class="hljs-params"><span class="hljs-attr">progress</span>: <span class="hljs-built_in">number</span></span>) => {
    currentScrollProgress = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">1</span>, progress));
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">transitionToImage</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"><span class="hljs-attr">newImageUrl</span>: <span class="hljs-built_in">string</span></span>) => {
    <span class="hljs-comment">// Store current state</span>
    sphereStates.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">state, i</span>) =></span> {
      prevPositions[i].<span class="hljs-title function_">copy</span>(state.<span class="hljs-property">currentPosition</span>);
      prevScales[i] = state.<span class="hljs-property">currentScale</span>;
    });

    <span class="hljs-comment">// Load new image data</span>
    <span class="hljs-keyword">const</span> newData = <span class="hljs-keyword">await</span> <span class="hljs-title function_">loadImageData</span>(newImageUrl, gridSize, sphereScale, depthScale, imageScale, imageProcessing);

    <span class="hljs-comment">// Update ALL sphere targets</span>
    sphereStates.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">state, i</span>) =></span> {
      <span class="hljs-keyword">const</span> key = <span class="hljs-string">`<span class="hljs-subst">${state.gridX}</span>,<span class="hljs-subst">${state.gridY}</span>`</span>;
      <span class="hljs-keyword">const</span> data = newData.<span class="hljs-title function_">get</span>(key);
      <span class="hljs-keyword">if</span> (data &#x26;&#x26; data.<span class="hljs-property">scale</span> > <span class="hljs-number">0.01</span>) {
        state.<span class="hljs-property">targetPosition</span>.<span class="hljs-title function_">set</span>(data.<span class="hljs-property">x</span>, data.<span class="hljs-property">y</span>, data.<span class="hljs-property">z</span>);
        state.<span class="hljs-property">targetScale</span> = data.<span class="hljs-property">scale</span>;
        state.<span class="hljs-property">active</span> = <span class="hljs-literal">true</span>;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// Keep position but fade out</span>
        state.<span class="hljs-property">targetScale</span> = <span class="hljs-number">0</span>;
        state.<span class="hljs-property">active</span> = <span class="hljs-literal">false</span>;
      }
      <span class="hljs-comment">// Also update expanded targets for collapse/restore</span>
      expandedTargets[i].<span class="hljs-property">position</span>.<span class="hljs-title function_">copy</span>(state.<span class="hljs-property">targetPosition</span>);
      expandedTargets[i].<span class="hljs-property">scale</span> = state.<span class="hljs-property">targetScale</span>;
      expandedTargets[i].<span class="hljs-property">active</span> = state.<span class="hljs-property">active</span>;
    });

    collapsed = <span class="hljs-literal">false</span>; <span class="hljs-comment">// New content means we're expanded</span>
    transitionStartTime = performance.<span class="hljs-title function_">now</span>();
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">transitionToTypeCase</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"><span class="hljs-attr">config</span>: <span class="hljs-title class_">TypeCaseConfig</span> = {}</span>) => {
    <span class="hljs-comment">// Store current state</span>
    sphereStates.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">state, i</span>) =></span> {
      prevPositions[i].<span class="hljs-title function_">copy</span>(state.<span class="hljs-property">currentPosition</span>);
      prevScales[i] = state.<span class="hljs-property">currentScale</span>;
    });

    <span class="hljs-comment">// Generate type case data</span>
    <span class="hljs-keyword">const</span> typeCaseData = <span class="hljs-title function_">generateTypeCaseData</span>(gridSize, sphereScale, depthScale, config);

    <span class="hljs-comment">// Update ALL sphere targets</span>
    sphereStates.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">state, i</span>) =></span> {
      <span class="hljs-keyword">const</span> key = <span class="hljs-string">`<span class="hljs-subst">${state.gridX}</span>,<span class="hljs-subst">${state.gridY}</span>`</span>;
      <span class="hljs-keyword">const</span> data = typeCaseData.<span class="hljs-title function_">get</span>(key);
      <span class="hljs-keyword">if</span> (data &#x26;&#x26; data.<span class="hljs-property">scale</span> > <span class="hljs-number">0.01</span>) {
        state.<span class="hljs-property">targetPosition</span>.<span class="hljs-title function_">set</span>(data.<span class="hljs-property">x</span>, data.<span class="hljs-property">y</span>, data.<span class="hljs-property">z</span>);
        state.<span class="hljs-property">targetScale</span> = data.<span class="hljs-property">scale</span>;
        state.<span class="hljs-property">active</span> = <span class="hljs-literal">true</span>;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// Sphere becomes inactive</span>
        state.<span class="hljs-property">targetScale</span> = <span class="hljs-number">0</span>;
        state.<span class="hljs-property">active</span> = <span class="hljs-literal">false</span>;
      }
      <span class="hljs-comment">// Also update expanded targets for collapse/restore</span>
      expandedTargets[i].<span class="hljs-property">position</span>.<span class="hljs-title function_">copy</span>(state.<span class="hljs-property">targetPosition</span>);
      expandedTargets[i].<span class="hljs-property">scale</span> = state.<span class="hljs-property">targetScale</span>;
      expandedTargets[i].<span class="hljs-property">active</span> = state.<span class="hljs-property">active</span>;
    });

    collapsed = <span class="hljs-literal">false</span>; <span class="hljs-comment">// New content means we're expanded</span>
    transitionStartTime = performance.<span class="hljs-title function_">now</span>();
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">transitionToIllustration</span> = (<span class="hljs-params"><span class="hljs-attr">illustration</span>: <span class="hljs-title class_">HalftoneIllustration</span></span>) => {
    <span class="hljs-comment">// Store current state</span>
    sphereStates.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">state, i</span>) =></span> {
      prevPositions[i].<span class="hljs-title function_">copy</span>(state.<span class="hljs-property">currentPosition</span>);
      prevScales[i] = state.<span class="hljs-property">currentScale</span>;
    });

    <span class="hljs-comment">// Render illustration points at current grid size</span>
    <span class="hljs-keyword">const</span> { points, transform } = illustration;
    <span class="hljs-keyword">const</span> halfGrid = gridSize / <span class="hljs-number">2</span>;
    <span class="hljs-keyword">const</span> <span class="hljs-attr">renderedPoints</span>: <span class="hljs-title class_">Array</span>&#x3C;{ <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">z</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">scale</span>: <span class="hljs-built_in">number</span> }> = [];

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> point <span class="hljs-keyword">of</span> points) {
      <span class="hljs-keyword">const</span> x = (point.<span class="hljs-property">nx</span> - <span class="hljs-number">0.5</span>) * gridSize * transform.<span class="hljs-property">scale</span> * imageScale + transform.<span class="hljs-property">x</span>;
      <span class="hljs-keyword">const</span> y = (<span class="hljs-number">0.5</span> - point.<span class="hljs-property">ny</span>) * gridSize * transform.<span class="hljs-property">scale</span> * imageScale + transform.<span class="hljs-property">y</span>;
      <span class="hljs-keyword">const</span> z = point.<span class="hljs-property">nz</span> * depthScale + transform.<span class="hljs-property">z</span>;
      <span class="hljs-keyword">const</span> scale = point.<span class="hljs-property">scale</span> * transform.<span class="hljs-property">scale</span> * sphereScale * imageScale;
      renderedPoints.<span class="hljs-title function_">push</span>({ x, y, z, scale });
    }

    <span class="hljs-comment">// Map rendered points to grid positions</span>
    <span class="hljs-keyword">const</span> illustrationData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&#x3C;<span class="hljs-built_in">string</span>, { <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">z</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">scale</span>: <span class="hljs-built_in">number</span> }>();

    renderedPoints.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">point, i</span>) =></span> {
      <span class="hljs-keyword">const</span> gx = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(point.<span class="hljs-property">x</span> + halfGrid);
      <span class="hljs-keyword">const</span> gy = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(halfGrid - point.<span class="hljs-property">y</span>);
      <span class="hljs-keyword">const</span> key = <span class="hljs-string">`<span class="hljs-subst">${gx}</span>,<span class="hljs-subst">${gy}</span>`</span>;

      <span class="hljs-keyword">const</span> existing = illustrationData.<span class="hljs-title function_">get</span>(key);
      <span class="hljs-keyword">if</span> (!existing || point.<span class="hljs-property">scale</span> > existing.<span class="hljs-property">scale</span>) {
        illustrationData.<span class="hljs-title function_">set</span>(key, point);
      }
    });

    <span class="hljs-comment">// Update ALL sphere targets</span>
    sphereStates.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">state, i</span>) =></span> {
      <span class="hljs-keyword">const</span> key = <span class="hljs-string">`<span class="hljs-subst">${state.gridX}</span>,<span class="hljs-subst">${state.gridY}</span>`</span>;
      <span class="hljs-keyword">const</span> data = illustrationData.<span class="hljs-title function_">get</span>(key);
      <span class="hljs-keyword">if</span> (data &#x26;&#x26; data.<span class="hljs-property">scale</span> > <span class="hljs-number">0.01</span>) {
        state.<span class="hljs-property">targetPosition</span>.<span class="hljs-title function_">set</span>(data.<span class="hljs-property">x</span>, data.<span class="hljs-property">y</span>, data.<span class="hljs-property">z</span>);
        state.<span class="hljs-property">targetScale</span> = data.<span class="hljs-property">scale</span>;
        state.<span class="hljs-property">active</span> = <span class="hljs-literal">true</span>;
      } <span class="hljs-keyword">else</span> {
        state.<span class="hljs-property">targetScale</span> = <span class="hljs-number">0</span>;
        state.<span class="hljs-property">active</span> = <span class="hljs-literal">false</span>;
      }
      <span class="hljs-comment">// Also update expanded targets for collapse/restore</span>
      expandedTargets[i].<span class="hljs-property">position</span>.<span class="hljs-title function_">copy</span>(state.<span class="hljs-property">targetPosition</span>);
      expandedTargets[i].<span class="hljs-property">scale</span> = state.<span class="hljs-property">targetScale</span>;
      expandedTargets[i].<span class="hljs-property">active</span> = state.<span class="hljs-property">active</span>;
    });

    collapsed = <span class="hljs-literal">false</span>; <span class="hljs-comment">// New content means we're expanded</span>
    transitionStartTime = performance.<span class="hljs-title function_">now</span>();
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">collapseToCenter</span> = (<span class="hljs-params"></span>) => {
    <span class="hljs-keyword">if</span> (collapsed) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// Store current expanded state before collapsing</span>
    sphereStates.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">state, i</span>) =></span> {
      expandedTargets[i].<span class="hljs-property">position</span>.<span class="hljs-title function_">copy</span>(state.<span class="hljs-property">targetPosition</span>);
      expandedTargets[i].<span class="hljs-property">scale</span> = state.<span class="hljs-property">targetScale</span>;
      expandedTargets[i].<span class="hljs-property">active</span> = state.<span class="hljs-property">active</span>;
      <span class="hljs-comment">// Store current animated position for smooth transition</span>
      prevPositions[i].<span class="hljs-title function_">copy</span>(state.<span class="hljs-property">currentPosition</span>);
      prevScales[i] = state.<span class="hljs-property">currentScale</span>;
    });

    <span class="hljs-comment">// Collapse to a visible floating sphere cluster</span>
    <span class="hljs-comment">// Keep it centered but compact - visible as a glowing orb</span>
    <span class="hljs-keyword">const</span> centerX = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">const</span> centerY = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">const</span> centerZ = <span class="hljs-number">8</span>; <span class="hljs-comment">// Slightly forward</span>

    <span class="hljs-comment">// Create a visible sphere cluster</span>
    <span class="hljs-keyword">const</span> clusterRadius = <span class="hljs-number">4</span>; <span class="hljs-comment">// Visible cluster size</span>

    sphereStates.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">state, i</span>) =></span> {
      <span class="hljs-comment">// Spherical distribution for a nice floating orb effect</span>
      <span class="hljs-keyword">const</span> theta = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>;
      <span class="hljs-keyword">const</span> phi = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">acos</span>(<span class="hljs-number">2</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">1</span>);
      <span class="hljs-keyword">const</span> r = clusterRadius * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cbrt</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>()); <span class="hljs-comment">// Cubic root for even distribution</span>

      <span class="hljs-keyword">const</span> offsetX = r * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(phi) * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(theta);
      <span class="hljs-keyword">const</span> offsetY = r * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(phi) * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(theta);
      <span class="hljs-keyword">const</span> offsetZ = r * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(phi);

      state.<span class="hljs-property">targetPosition</span>.<span class="hljs-title function_">set</span>(centerX + offsetX, centerY + offsetY, centerZ + offsetZ);
      <span class="hljs-comment">// Visible scale - creates a glowing orb effect</span>
      state.<span class="hljs-property">targetScale</span> = <span class="hljs-number">0.35</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.15</span>;
      state.<span class="hljs-property">active</span> = <span class="hljs-literal">true</span>;
    });

    collapsed = <span class="hljs-literal">true</span>;
    transitionStartTime = performance.<span class="hljs-title function_">now</span>();
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">restore</span> = (<span class="hljs-params"></span>) => {
    <span class="hljs-keyword">if</span> (!collapsed) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// Store current collapsed state for smooth transition</span>
    sphereStates.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">state, i</span>) =></span> {
      prevPositions[i].<span class="hljs-title function_">copy</span>(state.<span class="hljs-property">currentPosition</span>);
      prevScales[i] = state.<span class="hljs-property">currentScale</span>;
    });

    <span class="hljs-comment">// Restore expanded targets</span>
    sphereStates.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">state, i</span>) =></span> {
      state.<span class="hljs-property">targetPosition</span>.<span class="hljs-title function_">copy</span>(expandedTargets[i].<span class="hljs-property">position</span>);
      state.<span class="hljs-property">targetScale</span> = expandedTargets[i].<span class="hljs-property">scale</span>;
      state.<span class="hljs-property">active</span> = expandedTargets[i].<span class="hljs-property">active</span>;
    });

    collapsed = <span class="hljs-literal">false</span>;
    transitionStartTime = performance.<span class="hljs-title function_">now</span>();
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">isCollapsed</span> = (<span class="hljs-params"></span>) => collapsed;

  <span class="hljs-comment">// Default globe colors (vibrant rainbow)</span>
  <span class="hljs-keyword">const</span> defaultGlobeColors = [
    <span class="hljs-number">0xff6b6b</span>, <span class="hljs-comment">// coral red</span>
    <span class="hljs-number">0x4ecdc4</span>, <span class="hljs-comment">// teal</span>
    <span class="hljs-number">0xffe66d</span>, <span class="hljs-comment">// yellow</span>
    <span class="hljs-number">0x95e1d3</span>, <span class="hljs-comment">// mint</span>
    <span class="hljs-number">0xf38181</span>, <span class="hljs-comment">// salmon</span>
    <span class="hljs-number">0xaa96da</span>, <span class="hljs-comment">// lavender</span>
    <span class="hljs-number">0xfcbad3</span>, <span class="hljs-comment">// pink</span>
    <span class="hljs-number">0xa8d8ea</span>, <span class="hljs-comment">// sky blue</span>
  ];

  <span class="hljs-comment">// Default solar system colors (warm golden center, cool orbits)</span>
  <span class="hljs-keyword">const</span> defaultOrbitColors = [
    <span class="hljs-number">0x60a5fa</span>, <span class="hljs-comment">// blue</span>
    <span class="hljs-number">0xa78bfa</span>, <span class="hljs-comment">// purple</span>
    <span class="hljs-number">0xf472b6</span>, <span class="hljs-comment">// pink</span>
    <span class="hljs-number">0x34d399</span>, <span class="hljs-comment">// green</span>
    <span class="hljs-number">0xfbbf24</span>, <span class="hljs-comment">// amber</span>
    <span class="hljs-number">0xf87171</span>, <span class="hljs-comment">// red</span>
  ];

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">transitionToGlobe</span> = (<span class="hljs-params"><span class="hljs-attr">config</span>: <span class="hljs-title class_">GlobeConfig</span> = {}</span>) => {
    <span class="hljs-keyword">const</span> {
      colors = defaultGlobeColors,
      radius = <span class="hljs-number">12</span>,
      sphereCount = <span class="hljs-number">80</span>,
    } = config;

    <span class="hljs-comment">// Store current state for smooth transition</span>
    sphereStates.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">state, i</span>) =></span> {
      prevPositions[i].<span class="hljs-title function_">copy</span>(state.<span class="hljs-property">currentPosition</span>);
      prevScales[i] = state.<span class="hljs-property">currentScale</span>;
    });

    <span class="hljs-comment">// Enable instance colors</span>
    useInstanceColors = <span class="hljs-literal">true</span>;

    <span class="hljs-comment">// Randomly select which spheres to show (fewer, bigger spheres)</span>
    <span class="hljs-keyword">const</span> activeIndices = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>&#x3C;<span class="hljs-built_in">number</span>>();
    <span class="hljs-keyword">while</span> (activeIndices.<span class="hljs-property">size</span> &#x3C; <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(sphereCount, sphereStates.<span class="hljs-property">length</span>)) {
      activeIndices.<span class="hljs-title function_">add</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * sphereStates.<span class="hljs-property">length</span>));
    }

    <span class="hljs-comment">// Set up globe positions and colors</span>
    sphereStates.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">state, i</span>) =></span> {
      <span class="hljs-keyword">if</span> (activeIndices.<span class="hljs-title function_">has</span>(i)) {
        <span class="hljs-comment">// Assign sphere to globe surface</span>
        <span class="hljs-keyword">const</span> theta = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>;
        <span class="hljs-keyword">const</span> phi = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">acos</span>(<span class="hljs-number">2</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">1</span>);

        <span class="hljs-comment">// Update globe params for animation</span>
        globeParams[i].<span class="hljs-property">theta</span> = theta;
        globeParams[i].<span class="hljs-property">phi</span> = phi;
        globeParams[i].<span class="hljs-property">rotationSpeed</span> = <span class="hljs-number">0.12</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.08</span>;
        globeParams[i].<span class="hljs-property">glowPhase</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>;

        <span class="hljs-comment">// Set initial target position on globe</span>
        state.<span class="hljs-property">targetPosition</span>.<span class="hljs-title function_">set</span>(
          radius * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(phi) * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(theta),
          radius * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(phi),
          radius * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(phi) * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(theta) + <span class="hljs-number">8</span>
        );
        state.<span class="hljs-property">targetScale</span> = <span class="hljs-number">0.8</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.4</span>; <span class="hljs-comment">// Bigger spheres</span>
        state.<span class="hljs-property">active</span> = <span class="hljs-literal">true</span>;

        <span class="hljs-comment">// Assign random color from palette</span>
        sphereColors[i].<span class="hljs-title function_">setHex</span>(colors[<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * colors.<span class="hljs-property">length</span>)]);
      } <span class="hljs-keyword">else</span> {
        state.<span class="hljs-property">targetScale</span> = <span class="hljs-number">0</span>;
        state.<span class="hljs-property">active</span> = <span class="hljs-literal">false</span>;
      }
    });

    formationMode = <span class="hljs-string">'globe'</span>;
    collapsed = <span class="hljs-literal">false</span>;
    transitionStartTime = performance.<span class="hljs-title function_">now</span>();
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">transitionToSolarSystem</span> = (<span class="hljs-params"><span class="hljs-attr">config</span>: <span class="hljs-title class_">SolarSystemConfig</span> = {}</span>) => {
    <span class="hljs-keyword">const</span> {
      orbitColors = defaultOrbitColors,
      centerColor = <span class="hljs-number">0xffd700</span>, <span class="hljs-comment">// Golden</span>
      glowIntensity = <span class="hljs-number">1.5</span>,
    } = config;

    <span class="hljs-comment">// Store current state for smooth transition</span>
    sphereStates.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">state, i</span>) =></span> {
      prevPositions[i].<span class="hljs-title function_">copy</span>(state.<span class="hljs-property">currentPosition</span>);
      prevScales[i] = state.<span class="hljs-property">currentScale</span>;
    });

    <span class="hljs-comment">// Enable instance colors</span>
    useInstanceColors = <span class="hljs-literal">true</span>;

    <span class="hljs-comment">// Set up solar system: one large center, rest orbiting</span>
    sphereStates.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">state, i</span>) =></span> {
      <span class="hljs-keyword">if</span> (i === <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// Center sphere - large and golden</span>
        solarParams[i].<span class="hljs-property">isCenter</span> = <span class="hljs-literal">true</span>;
        state.<span class="hljs-property">targetPosition</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">8</span>);
        state.<span class="hljs-property">targetScale</span> = <span class="hljs-number">3</span>;
        state.<span class="hljs-property">active</span> = <span class="hljs-literal">true</span>;
        sphereColors[i].<span class="hljs-title function_">setHex</span>(centerColor);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (i &#x3C; <span class="hljs-number">60</span>) {
        <span class="hljs-comment">// Orbiting spheres (use first ~60 spheres)</span>
        solarParams[i].<span class="hljs-property">isCenter</span> = <span class="hljs-literal">false</span>;
        solarParams[i].<span class="hljs-property">orbitRadius</span> = <span class="hljs-number">6</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">14</span>;
        solarParams[i].<span class="hljs-property">orbitAngle</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>;
        solarParams[i].<span class="hljs-property">orbitSpeed</span> = <span class="hljs-number">0.08</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.12</span>;
        solarParams[i].<span class="hljs-property">orbitTilt</span> = (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">0.5</span>) * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">0.4</span>;
        solarParams[i].<span class="hljs-property">glowPhase</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>;

        <span class="hljs-keyword">const</span> angle = solarParams[i].<span class="hljs-property">orbitAngle</span>;
        <span class="hljs-keyword">const</span> r = solarParams[i].<span class="hljs-property">orbitRadius</span>;
        state.<span class="hljs-property">targetPosition</span>.<span class="hljs-title function_">set</span>(
          <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(angle) * r,
          <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(angle) * r * <span class="hljs-number">0.3</span>,
          <span class="hljs-number">8</span>
        );
        state.<span class="hljs-property">targetScale</span> = <span class="hljs-number">0.4</span>;
        state.<span class="hljs-property">active</span> = <span class="hljs-literal">true</span>;

        <span class="hljs-comment">// Assign random orbit color</span>
        sphereColors[i].<span class="hljs-title function_">setHex</span>(orbitColors[<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * orbitColors.<span class="hljs-property">length</span>)]);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// Hide remaining spheres</span>
        state.<span class="hljs-property">targetScale</span> = <span class="hljs-number">0</span>;
        state.<span class="hljs-property">active</span> = <span class="hljs-literal">false</span>;
      }
    });

    formationMode = <span class="hljs-string">'solarSystem'</span>;
    collapsed = <span class="hljs-literal">false</span>;
    transitionStartTime = performance.<span class="hljs-title function_">now</span>();
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">resize</span> = (<span class="hljs-params"><span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span></span>) => {
    camera.<span class="hljs-property">aspect</span> = width / height;
    camera.<span class="hljs-title function_">updateProjectionMatrix</span>();
    renderer.<span class="hljs-title function_">setSize</span>(width, height);
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">dispose</span> = (<span class="hljs-params"></span>) => {
    <span class="hljs-title function_">stop</span>();
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'mousemove'</span>, handleMouseMove);
    renderer.<span class="hljs-title function_">dispose</span>();
    sphereGeometry.<span class="hljs-title function_">dispose</span>();
    sphereMaterial.<span class="hljs-title function_">dispose</span>();
  };

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">canvas</span>: renderer.<span class="hljs-property">domElement</span>,
    start,
    stop,
    setScrollProgress,
    transitionToImage,
    transitionToTypeCase,
    transitionToIllustration,
    transitionToGlobe,
    transitionToSolarSystem,
    collapseToCenter,
    restore,
    isCollapsed,
    dispose,
    resize,
  };
}
</code></pre><h2 id="illustration-editor">Illustration Editor</h2><p>An interactive editor for creating, adjusting, and saving halftone illustrations.
Saved illustrations are resolution-independent and can be rendered at any grid size.
</p><pre class="src-block"><code class="hljs language-typescript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'three'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">OrbitControls</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'three/examples/jsm/controls/OrbitControls.js'</span>;
<span class="hljs-keyword">import</span> { proxyImageUrl } <span class="hljs-keyword">from</span> <span class="hljs-string">'./halftone-spheres.org?name=image-utils'</span>;

<span class="hljs-comment">/**
 * Resolution-independent halftone illustration format
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">HalftoneIllustration</span> {
  <span class="hljs-attr">version</span>: <span class="hljs-number">1</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">type</span>: <span class="hljs-string">'image'</span> | <span class="hljs-string">'typecase'</span> | <span class="hljs-string">'custom'</span>;
  <span class="hljs-comment">/** Original source (URL or config) for reference */</span>
  <span class="hljs-attr">source</span>?: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">object</span>;
  <span class="hljs-comment">/** Normalized point data (0-1 range) */</span>
  <span class="hljs-attr">points</span>: <span class="hljs-title class_">Array</span>&#x3C;{
    <span class="hljs-comment">/** Normalized X position (0-1) */</span>
    <span class="hljs-attr">nx</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-comment">/** Normalized Y position (0-1) */</span>
    <span class="hljs-attr">ny</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-comment">/** Normalized Z depth (0-1, 0=back, 1=front) */</span>
    <span class="hljs-attr">nz</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-comment">/** Normalized scale (0-1) */</span>
    <span class="hljs-attr">scale</span>: <span class="hljs-built_in">number</span>;
  }>;
  <span class="hljs-comment">/** Illustration transform */</span>
  <span class="hljs-attr">transform</span>: {
    <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">z</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">scale</span>: <span class="hljs-built_in">number</span>;
  };
  <span class="hljs-comment">/** Camera settings */</span>
  <span class="hljs-attr">camera</span>: {
    <span class="hljs-attr">position</span>: { <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">z</span>: <span class="hljs-built_in">number</span> };
    <span class="hljs-attr">lookAt</span>: { <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">z</span>: <span class="hljs-built_in">number</span> };
    <span class="hljs-attr">fov</span>: <span class="hljs-built_in">number</span>;
  };
  <span class="hljs-comment">/** Creation metadata */</span>
  <span class="hljs-attr">created</span>?: <span class="hljs-built_in">string</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">EditorOptions</span> {
  <span class="hljs-attr">width</span>?: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">height</span>?: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">backgroundColor</span>?: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">sphereColor</span>?: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">/** Initial grid size for preview (can change) */</span>
  <span class="hljs-attr">gridSize</span>?: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">EditorResult</span> {
  <span class="hljs-attr">container</span>: <span class="hljs-title class_">HTMLElement</span>;
  <span class="hljs-comment">/** Load illustration from URL */</span>
  <span class="hljs-attr">loadFromUrl</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span></span>) =></span> <span class="hljs-title class_">Promise</span>&#x3C;<span class="hljs-built_in">void</span>>;
  <span class="hljs-comment">/** Load from saved illustration */</span>
  <span class="hljs-attr">loadIllustration</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">illustration</span>: <span class="hljs-title class_">HalftoneIllustration</span></span>) =></span> <span class="hljs-built_in">void</span>;
  <span class="hljs-comment">/** Export current state */</span>
  <span class="hljs-attr">exportIllustration</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span></span>) =></span> <span class="hljs-title class_">HalftoneIllustration</span>;
  <span class="hljs-comment">/** Update grid resolution (re-renders) */</span>
  <span class="hljs-attr">setGridSize</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">size</span>: <span class="hljs-built_in">number</span></span>) =></span> <span class="hljs-built_in">void</span>;
  <span class="hljs-comment">/** Dispose resources */</span>
  <span class="hljs-attr">dispose</span>: <span class="hljs-function">() =></span> <span class="hljs-built_in">void</span>;
}

<span class="hljs-comment">/**
 * Load an image from URL
 * Uses CORS proxy for external URLs automatically
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadImage</span>(<span class="hljs-params"><span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">Promise</span>&#x3C;<span class="hljs-title class_">HTMLImageElement</span>> {
  <span class="hljs-comment">// Use proxy for external URLs to avoid CORS issues</span>
  <span class="hljs-keyword">const</span> proxyUrl = <span class="hljs-title function_">proxyImageUrl</span>(url);

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>&#x3C;<span class="hljs-title class_">HTMLImageElement</span>>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =></span> {
    <span class="hljs-keyword">const</span> img = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();
    img.<span class="hljs-property">crossOrigin</span> = <span class="hljs-string">'anonymous'</span>;
    img.<span class="hljs-property">onload</span> = <span class="hljs-function">() =></span> <span class="hljs-title function_">resolve</span>(img);
    img.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =></span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Failed to load image: <span class="hljs-subst">${url}</span>`</span>));
    img.<span class="hljs-property">src</span> = proxyUrl;
  });
}

<span class="hljs-comment">/**
 * Process image to normalized point data
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">imageToNormalizedPoints</span>(<span class="hljs-params">
  <span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>,
  <span class="hljs-attr">sampleSize</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">100</span>
</span>): <span class="hljs-title class_">Promise</span>&#x3C;<span class="hljs-title class_">HalftoneIllustration</span>[<span class="hljs-string">'points'</span>]> {
  <span class="hljs-comment">// Load image</span>
  <span class="hljs-keyword">const</span> img = <span class="hljs-keyword">await</span> <span class="hljs-title function_">loadImage</span>(url);

  <span class="hljs-comment">// Draw to canvas</span>
  <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'canvas'</span>);
  canvas.<span class="hljs-property">width</span> = sampleSize;
  canvas.<span class="hljs-property">height</span> = sampleSize;
  <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>)!;

  <span class="hljs-comment">// Draw image centered and scaled to fit</span>
  <span class="hljs-keyword">const</span> scale = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(sampleSize / img.<span class="hljs-property">width</span>, sampleSize / img.<span class="hljs-property">height</span>);
  <span class="hljs-keyword">const</span> w = img.<span class="hljs-property">width</span> * scale;
  <span class="hljs-keyword">const</span> h = img.<span class="hljs-property">height</span> * scale;
  <span class="hljs-keyword">const</span> x = (sampleSize - w) / <span class="hljs-number">2</span>;
  <span class="hljs-keyword">const</span> y = (sampleSize - h) / <span class="hljs-number">2</span>;

  ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'#ffffff'</span>;
  ctx.<span class="hljs-title function_">fillRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, sampleSize, sampleSize);
  ctx.<span class="hljs-title function_">drawImage</span>(img, x, y, w, h);

  <span class="hljs-comment">// Sample pixels</span>
  <span class="hljs-keyword">const</span> imageData = ctx.<span class="hljs-title function_">getImageData</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, sampleSize, sampleSize);
  <span class="hljs-keyword">const</span> { data } = imageData;
  <span class="hljs-keyword">const</span> <span class="hljs-attr">points</span>: <span class="hljs-title class_">HalftoneIllustration</span>[<span class="hljs-string">'points'</span>] = [];

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> py = <span class="hljs-number">0</span>; py &#x3C; sampleSize; py++) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> px = <span class="hljs-number">0</span>; px &#x3C; sampleSize; px++) {
      <span class="hljs-keyword">const</span> i = (py * sampleSize + px) * <span class="hljs-number">4</span>;
      <span class="hljs-keyword">const</span> r = data[i];
      <span class="hljs-keyword">const</span> g = data[i + <span class="hljs-number">1</span>];
      <span class="hljs-keyword">const</span> b = data[i + <span class="hljs-number">2</span>];
      <span class="hljs-keyword">const</span> a = data[i + <span class="hljs-number">3</span>];

      <span class="hljs-comment">// Skip transparent</span>
      <span class="hljs-keyword">if</span> (a &#x3C; <span class="hljs-number">30</span>) <span class="hljs-keyword">continue</span>;

      <span class="hljs-comment">// Calculate brightness (inverted - dark = visible)</span>
      <span class="hljs-keyword">const</span> brightness = <span class="hljs-number">1</span> - (<span class="hljs-number">0.299</span> * r + <span class="hljs-number">0.587</span> * g + <span class="hljs-number">0.114</span> * b) / <span class="hljs-number">255</span>;

      <span class="hljs-comment">// Skip very light areas</span>
      <span class="hljs-keyword">if</span> (brightness &#x3C; <span class="hljs-number">0.05</span>) <span class="hljs-keyword">continue</span>;

      points.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">nx</span>: px / sampleSize,
        <span class="hljs-attr">ny</span>: py / sampleSize,
        <span class="hljs-attr">nz</span>: brightness, <span class="hljs-comment">// Depth based on darkness</span>
        <span class="hljs-attr">scale</span>: brightness,
      });
    }
  }

  <span class="hljs-keyword">return</span> points;
}

<span class="hljs-comment">/**
 * Render normalized points at a specific grid size
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">renderPoints</span>(<span class="hljs-params">
  <span class="hljs-attr">points</span>: <span class="hljs-title class_">HalftoneIllustration</span>[<span class="hljs-string">'points'</span>],
  <span class="hljs-attr">transform</span>: <span class="hljs-title class_">HalftoneIllustration</span>[<span class="hljs-string">'transform'</span>],
  <span class="hljs-attr">gridSize</span>: <span class="hljs-built_in">number</span>,
  <span class="hljs-attr">depthScale</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">10</span>
</span>): <span class="hljs-title class_">Array</span>&#x3C;{ <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">z</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">scale</span>: <span class="hljs-built_in">number</span> }> {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">result</span>: <span class="hljs-title class_">Array</span>&#x3C;{ <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">z</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">scale</span>: <span class="hljs-built_in">number</span> }> = [];

  <span class="hljs-keyword">const</span> halfGrid = gridSize / <span class="hljs-number">2</span>;
  <span class="hljs-keyword">const</span> { <span class="hljs-attr">x</span>: tx, <span class="hljs-attr">y</span>: ty, <span class="hljs-attr">z</span>: tz, <span class="hljs-attr">scale</span>: tScale } = transform;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> point <span class="hljs-keyword">of</span> points) {
    <span class="hljs-comment">// Convert normalized coords to grid coords</span>
    <span class="hljs-keyword">const</span> x = (point.<span class="hljs-property">nx</span> - <span class="hljs-number">0.5</span>) * gridSize * tScale + tx;
    <span class="hljs-keyword">const</span> y = (<span class="hljs-number">0.5</span> - point.<span class="hljs-property">ny</span>) * gridSize * tScale + ty; <span class="hljs-comment">// Flip Y</span>
    <span class="hljs-keyword">const</span> z = point.<span class="hljs-property">nz</span> * depthScale + tz;
    <span class="hljs-keyword">const</span> scale = point.<span class="hljs-property">scale</span> * tScale * <span class="hljs-number">0.5</span>;

    result.<span class="hljs-title function_">push</span>({ x, y, z, scale });
  }

  <span class="hljs-keyword">return</span> result;
}

<span class="hljs-comment">/**
 * Create the halftone illustration editor
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createHalftoneEditor</span>(<span class="hljs-params"><span class="hljs-attr">options</span>: <span class="hljs-title class_">EditorOptions</span> = {}</span>): <span class="hljs-title class_">EditorResult</span> {
  <span class="hljs-keyword">const</span> {
    width = <span class="hljs-number">800</span>,
    height = <span class="hljs-number">600</span>,
    backgroundColor = <span class="hljs-number">0x0a0a0f</span>,
    sphereColor = <span class="hljs-number">0xffffff</span>,
    <span class="hljs-attr">gridSize</span>: initialGridSize = <span class="hljs-number">80</span>,
  } = options;

  <span class="hljs-comment">// State</span>
  <span class="hljs-keyword">let</span> <span class="hljs-attr">currentPoints</span>: <span class="hljs-title class_">HalftoneIllustration</span>[<span class="hljs-string">'points'</span>] = [];
  <span class="hljs-keyword">let</span> <span class="hljs-attr">currentSource</span>: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">object</span> | <span class="hljs-literal">undefined</span>;
  <span class="hljs-keyword">let</span> <span class="hljs-attr">currentType</span>: <span class="hljs-title class_">HalftoneIllustration</span>[<span class="hljs-string">'type'</span>] = <span class="hljs-string">'image'</span>;
  <span class="hljs-keyword">let</span> gridSize = initialGridSize;

  <span class="hljs-keyword">let</span> transform = {
    <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">z</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">scale</span>: <span class="hljs-number">1</span>,
  };

  <span class="hljs-comment">// Create container</span>
  <span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
  container.<span class="hljs-property">style</span>.<span class="hljs-property">cssText</span> = <span class="hljs-string">`
    display: flex;
    flex-direction: column;
    gap: 1rem;
    padding: 1rem;
    background: #1a1a2e;
    border-radius: 8px;
  `</span>;

  <span class="hljs-comment">// Controls panel</span>
  <span class="hljs-keyword">const</span> controls = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
  controls.<span class="hljs-property">style</span>.<span class="hljs-property">cssText</span> = <span class="hljs-string">`
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-items: center;
  `</span>;

  <span class="hljs-comment">// URL input</span>
  <span class="hljs-keyword">const</span> urlInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'input'</span>);
  urlInput.<span class="hljs-property">type</span> = <span class="hljs-string">'text'</span>;
  urlInput.<span class="hljs-property">placeholder</span> = <span class="hljs-string">'Image URL...'</span>;
  urlInput.<span class="hljs-property">style</span>.<span class="hljs-property">cssText</span> = <span class="hljs-string">`
    flex: 1;
    min-width: 200px;
    padding: 0.5rem;
    background: #2a2a4e;
    border: 1px solid #3a3a6e;
    border-radius: 4px;
    color: white;
  `</span>;

  <span class="hljs-comment">// Load button</span>
  <span class="hljs-keyword">const</span> loadBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'button'</span>);
  loadBtn.<span class="hljs-property">textContent</span> = <span class="hljs-string">'Load Image'</span>;
  loadBtn.<span class="hljs-property">style</span>.<span class="hljs-property">cssText</span> = <span class="hljs-string">`
    padding: 0.5rem 1rem;
    background: #4a4a8e;
    border: none;
    border-radius: 4px;
    color: white;
    cursor: pointer;
  `</span>;

  <span class="hljs-comment">// Grid size selector</span>
  <span class="hljs-keyword">const</span> gridLabel = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'label'</span>);
  gridLabel.<span class="hljs-property">textContent</span> = <span class="hljs-string">'Grid: '</span>;
  gridLabel.<span class="hljs-property">style</span>.<span class="hljs-property">color</span> = <span class="hljs-string">'white'</span>;

  <span class="hljs-keyword">const</span> gridSelect = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'select'</span>);
  gridSelect.<span class="hljs-property">style</span>.<span class="hljs-property">cssText</span> = <span class="hljs-string">`
    padding: 0.5rem;
    background: #2a2a4e;
    border: 1px solid #3a3a6e;
    border-radius: 4px;
    color: white;
  `</span>;
  [<span class="hljs-number">40</span>, <span class="hljs-number">60</span>, <span class="hljs-number">80</span>, <span class="hljs-number">100</span>, <span class="hljs-number">120</span>, <span class="hljs-number">150</span>, <span class="hljs-number">200</span>].<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">size</span> =></span> {
    <span class="hljs-keyword">const</span> opt = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'option'</span>);
    opt.<span class="hljs-property">value</span> = <span class="hljs-title class_">String</span>(size);
    opt.<span class="hljs-property">textContent</span> = <span class="hljs-title class_">String</span>(size);
    <span class="hljs-keyword">if</span> (size === initialGridSize) opt.<span class="hljs-property">selected</span> = <span class="hljs-literal">true</span>;
    gridSelect.<span class="hljs-title function_">appendChild</span>(opt);
  });

  <span class="hljs-comment">// Export button</span>
  <span class="hljs-keyword">const</span> exportBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'button'</span>);
  exportBtn.<span class="hljs-property">textContent</span> = <span class="hljs-string">'Export JSON'</span>;
  exportBtn.<span class="hljs-property">style</span>.<span class="hljs-property">cssText</span> = <span class="hljs-string">`
    padding: 0.5rem 1rem;
    background: #2a8a4a;
    border: none;
    border-radius: 4px;
    color: white;
    cursor: pointer;
  `</span>;

  <span class="hljs-comment">// Import button</span>
  <span class="hljs-keyword">const</span> importBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'button'</span>);
  importBtn.<span class="hljs-property">textContent</span> = <span class="hljs-string">'Import JSON'</span>;
  importBtn.<span class="hljs-property">style</span>.<span class="hljs-property">cssText</span> = <span class="hljs-string">`
    padding: 0.5rem 1rem;
    background: #8a4a2a;
    border: none;
    border-radius: 4px;
    color: white;
    cursor: pointer;
  `</span>;

  controls.<span class="hljs-title function_">appendChild</span>(urlInput);
  controls.<span class="hljs-title function_">appendChild</span>(loadBtn);
  controls.<span class="hljs-title function_">appendChild</span>(gridLabel);
  controls.<span class="hljs-title function_">appendChild</span>(gridSelect);
  controls.<span class="hljs-title function_">appendChild</span>(exportBtn);
  controls.<span class="hljs-title function_">appendChild</span>(importBtn);

  <span class="hljs-comment">// Transform controls</span>
  <span class="hljs-keyword">const</span> transformControls = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
  transformControls.<span class="hljs-property">style</span>.<span class="hljs-property">cssText</span> = <span class="hljs-string">`
    display: flex;
    gap: 1rem;
    align-items: center;
    color: white;
    font-size: 0.85rem;
  `</span>;

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">createSlider</span> = (<span class="hljs-params"><span class="hljs-attr">label</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">min</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">max</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">value</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">step</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">onChange</span>: (v: <span class="hljs-built_in">number</span>) => <span class="hljs-built_in">void</span></span>) => {
    <span class="hljs-keyword">const</span> wrapper = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
    wrapper.<span class="hljs-property">style</span>.<span class="hljs-property">cssText</span> = <span class="hljs-string">'display: flex; align-items: center; gap: 0.25rem;'</span>;

    <span class="hljs-keyword">const</span> lbl = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'span'</span>);
    lbl.<span class="hljs-property">textContent</span> = label;

    <span class="hljs-keyword">const</span> slider = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'input'</span>);
    slider.<span class="hljs-property">type</span> = <span class="hljs-string">'range'</span>;
    slider.<span class="hljs-property">min</span> = <span class="hljs-title class_">String</span>(min);
    slider.<span class="hljs-property">max</span> = <span class="hljs-title class_">String</span>(max);
    slider.<span class="hljs-property">value</span> = <span class="hljs-title class_">String</span>(value);
    slider.<span class="hljs-property">step</span> = <span class="hljs-title class_">String</span>(step);
    slider.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = <span class="hljs-string">'80px'</span>;

    <span class="hljs-keyword">const</span> valDisplay = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'span'</span>);
    valDisplay.<span class="hljs-property">textContent</span> = <span class="hljs-title class_">String</span>(value);
    valDisplay.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = <span class="hljs-string">'40px'</span>;

    slider.<span class="hljs-property">oninput</span> = <span class="hljs-function">() =></span> {
      <span class="hljs-keyword">const</span> v = <span class="hljs-built_in">parseFloat</span>(slider.<span class="hljs-property">value</span>);
      valDisplay.<span class="hljs-property">textContent</span> = v.<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">1</span>);
      <span class="hljs-title function_">onChange</span>(v);
    };

    wrapper.<span class="hljs-title function_">appendChild</span>(lbl);
    wrapper.<span class="hljs-title function_">appendChild</span>(slider);
    wrapper.<span class="hljs-title function_">appendChild</span>(valDisplay);
    <span class="hljs-keyword">return</span> { wrapper, slider, valDisplay };
  };

  <span class="hljs-keyword">const</span> xSlider = <span class="hljs-title function_">createSlider</span>(<span class="hljs-string">'X:'</span>, -<span class="hljs-number">50</span>, <span class="hljs-number">50</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-function"><span class="hljs-params">v</span> =></span> { transform.<span class="hljs-property">x</span> = v; <span class="hljs-title function_">updateMesh</span>(); });
  <span class="hljs-keyword">const</span> ySlider = <span class="hljs-title function_">createSlider</span>(<span class="hljs-string">'Y:'</span>, -<span class="hljs-number">50</span>, <span class="hljs-number">50</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-function"><span class="hljs-params">v</span> =></span> { transform.<span class="hljs-property">y</span> = v; <span class="hljs-title function_">updateMesh</span>(); });
  <span class="hljs-keyword">const</span> zSlider = <span class="hljs-title function_">createSlider</span>(<span class="hljs-string">'Z:'</span>, -<span class="hljs-number">20</span>, <span class="hljs-number">20</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-function"><span class="hljs-params">v</span> =></span> { transform.<span class="hljs-property">z</span> = v; <span class="hljs-title function_">updateMesh</span>(); });
  <span class="hljs-keyword">const</span> scaleSlider = <span class="hljs-title function_">createSlider</span>(<span class="hljs-string">'Scale:'</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0.1</span>, <span class="hljs-function"><span class="hljs-params">v</span> =></span> { transform.<span class="hljs-property">scale</span> = v; <span class="hljs-title function_">updateMesh</span>(); });

  transformControls.<span class="hljs-title function_">appendChild</span>(xSlider.<span class="hljs-property">wrapper</span>);
  transformControls.<span class="hljs-title function_">appendChild</span>(ySlider.<span class="hljs-property">wrapper</span>);
  transformControls.<span class="hljs-title function_">appendChild</span>(zSlider.<span class="hljs-property">wrapper</span>);
  transformControls.<span class="hljs-title function_">appendChild</span>(scaleSlider.<span class="hljs-property">wrapper</span>);

  <span class="hljs-comment">// Canvas container</span>
  <span class="hljs-keyword">const</span> canvasContainer = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
  canvasContainer.<span class="hljs-property">style</span>.<span class="hljs-property">cssText</span> = <span class="hljs-string">`
    width: 100%;
    height: <span class="hljs-subst">${height}</span>px;
    border-radius: 4px;
    overflow: hidden;
  `</span>;

  <span class="hljs-comment">// Status bar</span>
  <span class="hljs-keyword">const</span> status = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
  status.<span class="hljs-property">style</span>.<span class="hljs-property">cssText</span> = <span class="hljs-string">`
    color: #888;
    font-size: 0.85rem;
  `</span>;
  status.<span class="hljs-property">textContent</span> = <span class="hljs-string">'Ready. Enter an image URL and click Load.'</span>;

  container.<span class="hljs-title function_">appendChild</span>(controls);
  container.<span class="hljs-title function_">appendChild</span>(transformControls);
  container.<span class="hljs-title function_">appendChild</span>(canvasContainer);
  container.<span class="hljs-title function_">appendChild</span>(status);

  <span class="hljs-comment">// Three.js setup</span>
  <span class="hljs-keyword">const</span> scene = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Scene</span>();
  scene.<span class="hljs-property">background</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Color</span>(backgroundColor);

  <span class="hljs-keyword">const</span> camera = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PerspectiveCamera</span>(<span class="hljs-number">50</span>, width / height, <span class="hljs-number">0.1</span>, <span class="hljs-number">1000</span>);
  camera.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">80</span>);

  <span class="hljs-keyword">const</span> renderer = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">WebGLRenderer</span>({ <span class="hljs-attr">antialias</span>: <span class="hljs-literal">true</span> });
  renderer.<span class="hljs-title function_">setSize</span>(width, height);
  renderer.<span class="hljs-title function_">setPixelRatio</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">devicePixelRatio</span>, <span class="hljs-number">2</span>));
  canvasContainer.<span class="hljs-title function_">appendChild</span>(renderer.<span class="hljs-property">domElement</span>);

  <span class="hljs-keyword">const</span> orbitControls = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrbitControls</span>(camera, renderer.<span class="hljs-property">domElement</span>);
  orbitControls.<span class="hljs-property">enableDamping</span> = <span class="hljs-literal">true</span>;
  orbitControls.<span class="hljs-property">dampingFactor</span> = <span class="hljs-number">0.05</span>;

  <span class="hljs-comment">// Sphere mesh</span>
  <span class="hljs-keyword">const</span> sphereGeometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">SphereGeometry</span>(<span class="hljs-number">0.5</span>, <span class="hljs-number">8</span>, <span class="hljs-number">8</span>);
  <span class="hljs-keyword">const</span> sphereMaterial = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshBasicMaterial</span>({ <span class="hljs-attr">color</span>: sphereColor });
  <span class="hljs-keyword">let</span> <span class="hljs-attr">instancedMesh</span>: <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">InstancedMesh</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">const</span> matrix = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Matrix4</span>();

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">updateMesh</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (currentPoints.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> rendered = <span class="hljs-title function_">renderPoints</span>(currentPoints, transform, gridSize);

    <span class="hljs-comment">// Recreate mesh if point count changed</span>
    <span class="hljs-keyword">if</span> (!instancedMesh || instancedMesh.<span class="hljs-property">count</span> !== rendered.<span class="hljs-property">length</span>) {
      <span class="hljs-keyword">if</span> (instancedMesh) {
        scene.<span class="hljs-title function_">remove</span>(instancedMesh);
        instancedMesh.<span class="hljs-title function_">dispose</span>();
      }
      instancedMesh = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">InstancedMesh</span>(sphereGeometry, sphereMaterial, rendered.<span class="hljs-property">length</span>);
      scene.<span class="hljs-title function_">add</span>(instancedMesh);
    }

    <span class="hljs-comment">// Update positions</span>
    rendered.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">point, i</span>) =></span> {
      matrix.<span class="hljs-title function_">makeScale</span>(point.<span class="hljs-property">scale</span>, point.<span class="hljs-property">scale</span>, point.<span class="hljs-property">scale</span>);
      matrix.<span class="hljs-title function_">setPosition</span>(point.<span class="hljs-property">x</span>, point.<span class="hljs-property">y</span>, point.<span class="hljs-property">z</span>);
      instancedMesh!.<span class="hljs-title function_">setMatrixAt</span>(i, matrix);
    });
    instancedMesh.<span class="hljs-property">instanceMatrix</span>.<span class="hljs-property">needsUpdate</span> = <span class="hljs-literal">true</span>;

    status.<span class="hljs-property">textContent</span> = <span class="hljs-string">`Points: <span class="hljs-subst">${rendered.length}</span> | Grid: <span class="hljs-subst">${gridSize}</span> | Use mouse to orbit camera`</span>;
  }

  <span class="hljs-comment">// Animation loop</span>
  <span class="hljs-keyword">let</span> <span class="hljs-attr">animationId</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">animate</span>(<span class="hljs-params"></span>) {
    animationId = <span class="hljs-title function_">requestAnimationFrame</span>(animate);
    orbitControls.<span class="hljs-title function_">update</span>();
    renderer.<span class="hljs-title function_">render</span>(scene, camera);
  }
  <span class="hljs-title function_">animate</span>();

  <span class="hljs-comment">// Event handlers</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">loadFromUrl</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"><span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span></span>) => {
    status.<span class="hljs-property">textContent</span> = <span class="hljs-string">'Loading image...'</span>;
    <span class="hljs-keyword">try</span> {
      currentPoints = <span class="hljs-keyword">await</span> <span class="hljs-title function_">imageToNormalizedPoints</span>(url, <span class="hljs-number">100</span>);
      currentSource = url;
      currentType = <span class="hljs-string">'image'</span>;
      <span class="hljs-title function_">updateMesh</span>();
      status.<span class="hljs-property">textContent</span> = <span class="hljs-string">`Loaded <span class="hljs-subst">${currentPoints.length}</span> points from image`</span>;
    } <span class="hljs-keyword">catch</span> (e) {
      status.<span class="hljs-property">textContent</span> = <span class="hljs-string">`Error loading image: <span class="hljs-subst">${e}</span>`</span>;
    }
  };

  loadBtn.<span class="hljs-property">onclick</span> = <span class="hljs-function">() =></span> {
    <span class="hljs-keyword">if</span> (urlInput.<span class="hljs-property">value</span>) <span class="hljs-title function_">loadFromUrl</span>(urlInput.<span class="hljs-property">value</span>);
  };

  urlInput.<span class="hljs-property">onkeydown</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =></span> {
    <span class="hljs-keyword">if</span> (e.<span class="hljs-property">key</span> === <span class="hljs-string">'Enter'</span> &#x26;&#x26; urlInput.<span class="hljs-property">value</span>) <span class="hljs-title function_">loadFromUrl</span>(urlInput.<span class="hljs-property">value</span>);
  };

  gridSelect.<span class="hljs-property">onchange</span> = <span class="hljs-function">() =></span> {
    gridSize = <span class="hljs-built_in">parseInt</span>(gridSelect.<span class="hljs-property">value</span>);
    <span class="hljs-title function_">updateMesh</span>();
  };

  <span class="hljs-keyword">const</span> exportIllustration = (<span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>): <span class="hljs-function"><span class="hljs-params">HalftoneIllustration</span> =></span> {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">version</span>: <span class="hljs-number">1</span>,
      name,
      <span class="hljs-attr">type</span>: currentType,
      <span class="hljs-attr">source</span>: currentSource,
      <span class="hljs-attr">points</span>: currentPoints,
      <span class="hljs-attr">transform</span>: { ...transform },
      <span class="hljs-attr">camera</span>: {
        <span class="hljs-attr">position</span>: { <span class="hljs-attr">x</span>: camera.<span class="hljs-property">position</span>.<span class="hljs-property">x</span>, <span class="hljs-attr">y</span>: camera.<span class="hljs-property">position</span>.<span class="hljs-property">y</span>, <span class="hljs-attr">z</span>: camera.<span class="hljs-property">position</span>.<span class="hljs-property">z</span> },
        <span class="hljs-attr">lookAt</span>: { <span class="hljs-attr">x</span>: orbitControls.<span class="hljs-property">target</span>.<span class="hljs-property">x</span>, <span class="hljs-attr">y</span>: orbitControls.<span class="hljs-property">target</span>.<span class="hljs-property">y</span>, <span class="hljs-attr">z</span>: orbitControls.<span class="hljs-property">target</span>.<span class="hljs-property">z</span> },
        <span class="hljs-attr">fov</span>: camera.<span class="hljs-property">fov</span>,
      },
      <span class="hljs-attr">created</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
    };
  };

  exportBtn.<span class="hljs-property">onclick</span> = <span class="hljs-function">() =></span> {
    <span class="hljs-keyword">const</span> name = <span class="hljs-title function_">prompt</span>(<span class="hljs-string">'Illustration name:'</span>, <span class="hljs-string">'my-illustration'</span>) || <span class="hljs-string">'illustration'</span>;
    <span class="hljs-keyword">const</span> illustration = <span class="hljs-title function_">exportIllustration</span>(name);
    <span class="hljs-keyword">const</span> json = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(illustration, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>);

    <span class="hljs-comment">// Copy to clipboard</span>
    navigator.<span class="hljs-property">clipboard</span>.<span class="hljs-title function_">writeText</span>(json).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =></span> {
      status.<span class="hljs-property">textContent</span> = <span class="hljs-string">'JSON copied to clipboard!'</span>;
    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =></span> {
      <span class="hljs-comment">// Fallback: show in prompt</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(json);
      status.<span class="hljs-property">textContent</span> = <span class="hljs-string">'JSON logged to console (clipboard failed)'</span>;
    });
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">loadIllustration</span> = (<span class="hljs-params"><span class="hljs-attr">illustration</span>: <span class="hljs-title class_">HalftoneIllustration</span></span>) => {
    currentPoints = illustration.<span class="hljs-property">points</span>;
    currentSource = illustration.<span class="hljs-property">source</span>;
    currentType = illustration.<span class="hljs-property">type</span>;
    transform = { ...illustration.<span class="hljs-property">transform</span> };

    <span class="hljs-comment">// Update UI</span>
    xSlider.<span class="hljs-property">slider</span>.<span class="hljs-property">value</span> = <span class="hljs-title class_">String</span>(transform.<span class="hljs-property">x</span>);
    xSlider.<span class="hljs-property">valDisplay</span>.<span class="hljs-property">textContent</span> = transform.<span class="hljs-property">x</span>.<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">1</span>);
    ySlider.<span class="hljs-property">slider</span>.<span class="hljs-property">value</span> = <span class="hljs-title class_">String</span>(transform.<span class="hljs-property">y</span>);
    ySlider.<span class="hljs-property">valDisplay</span>.<span class="hljs-property">textContent</span> = transform.<span class="hljs-property">y</span>.<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">1</span>);
    zSlider.<span class="hljs-property">slider</span>.<span class="hljs-property">value</span> = <span class="hljs-title class_">String</span>(transform.<span class="hljs-property">z</span>);
    zSlider.<span class="hljs-property">valDisplay</span>.<span class="hljs-property">textContent</span> = transform.<span class="hljs-property">z</span>.<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">1</span>);
    scaleSlider.<span class="hljs-property">slider</span>.<span class="hljs-property">value</span> = <span class="hljs-title class_">String</span>(transform.<span class="hljs-property">scale</span>);
    scaleSlider.<span class="hljs-property">valDisplay</span>.<span class="hljs-property">textContent</span> = transform.<span class="hljs-property">scale</span>.<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">1</span>);

    <span class="hljs-comment">// Update camera</span>
    <span class="hljs-keyword">if</span> (illustration.<span class="hljs-property">camera</span>) {
      camera.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(
        illustration.<span class="hljs-property">camera</span>.<span class="hljs-property">position</span>.<span class="hljs-property">x</span>,
        illustration.<span class="hljs-property">camera</span>.<span class="hljs-property">position</span>.<span class="hljs-property">y</span>,
        illustration.<span class="hljs-property">camera</span>.<span class="hljs-property">position</span>.<span class="hljs-property">z</span>
      );
      orbitControls.<span class="hljs-property">target</span>.<span class="hljs-title function_">set</span>(
        illustration.<span class="hljs-property">camera</span>.<span class="hljs-property">lookAt</span>.<span class="hljs-property">x</span>,
        illustration.<span class="hljs-property">camera</span>.<span class="hljs-property">lookAt</span>.<span class="hljs-property">y</span>,
        illustration.<span class="hljs-property">camera</span>.<span class="hljs-property">lookAt</span>.<span class="hljs-property">z</span>
      );
      camera.<span class="hljs-property">fov</span> = illustration.<span class="hljs-property">camera</span>.<span class="hljs-property">fov</span>;
      camera.<span class="hljs-title function_">updateProjectionMatrix</span>();
    }

    <span class="hljs-title function_">updateMesh</span>();
    status.<span class="hljs-property">textContent</span> = <span class="hljs-string">`Loaded illustration: <span class="hljs-subst">${illustration.name}</span>`</span>;
  };

  importBtn.<span class="hljs-property">onclick</span> = <span class="hljs-function">() =></span> {
    <span class="hljs-keyword">const</span> json = <span class="hljs-title function_">prompt</span>(<span class="hljs-string">'Paste illustration JSON:'</span>);
    <span class="hljs-keyword">if</span> (json) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> illustration = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(json) <span class="hljs-keyword">as</span> <span class="hljs-title class_">HalftoneIllustration</span>;
        <span class="hljs-title function_">loadIllustration</span>(illustration);
      } <span class="hljs-keyword">catch</span> (e) {
        status.<span class="hljs-property">textContent</span> = <span class="hljs-string">`Error parsing JSON: <span class="hljs-subst">${e}</span>`</span>;
      }
    }
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">setGridSize</span> = (<span class="hljs-params"><span class="hljs-attr">size</span>: <span class="hljs-built_in">number</span></span>) => {
    gridSize = size;
    gridSelect.<span class="hljs-property">value</span> = <span class="hljs-title class_">String</span>(size);
    <span class="hljs-title function_">updateMesh</span>();
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">dispose</span> = (<span class="hljs-params"></span>) => {
    <span class="hljs-title function_">cancelAnimationFrame</span>(animationId);
    orbitControls.<span class="hljs-title function_">dispose</span>();
    renderer.<span class="hljs-title function_">dispose</span>();
    sphereGeometry.<span class="hljs-title function_">dispose</span>();
    sphereMaterial.<span class="hljs-title function_">dispose</span>();
    <span class="hljs-keyword">if</span> (instancedMesh) instancedMesh.<span class="hljs-title function_">dispose</span>();
  };

  <span class="hljs-keyword">return</span> {
    container,
    loadFromUrl,
    loadIllustration,
    exportIllustration,
    setGridSize,
    dispose,
  };
}

<span class="hljs-comment">/**
 * Render a saved illustration at a specific resolution
 * Use this in production to render from cached data
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">renderIllustration</span>(<span class="hljs-params">
  <span class="hljs-attr">illustration</span>: <span class="hljs-title class_">HalftoneIllustration</span>,
  <span class="hljs-attr">gridSize</span>: <span class="hljs-built_in">number</span>,
  <span class="hljs-attr">options</span>: {
    depthScale?: <span class="hljs-built_in">number</span>;
    sphereScale?: <span class="hljs-built_in">number</span>;
  } = {}
</span>): <span class="hljs-title class_">Map</span>&#x3C;<span class="hljs-built_in">string</span>, { <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">z</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">scale</span>: <span class="hljs-built_in">number</span> }> {
  <span class="hljs-keyword">const</span> { depthScale = <span class="hljs-number">10</span>, sphereScale = <span class="hljs-number">1</span> } = options;

  <span class="hljs-keyword">const</span> rendered = <span class="hljs-title function_">renderPoints</span>(illustration.<span class="hljs-property">points</span>, illustration.<span class="hljs-property">transform</span>, gridSize, depthScale);
  <span class="hljs-keyword">const</span> targets = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&#x3C;<span class="hljs-built_in">string</span>, { <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">z</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">scale</span>: <span class="hljs-built_in">number</span> }>();

  <span class="hljs-comment">// Map to grid positions</span>
  rendered.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">point, i</span>) =></span> {
    <span class="hljs-keyword">const</span> gx = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(point.<span class="hljs-property">x</span> + gridSize / <span class="hljs-number">2</span>);
    <span class="hljs-keyword">const</span> gy = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(gridSize / <span class="hljs-number">2</span> - point.<span class="hljs-property">y</span>);
    <span class="hljs-keyword">const</span> key = <span class="hljs-string">`<span class="hljs-subst">${gx}</span>,<span class="hljs-subst">${gy}</span>`</span>;

    <span class="hljs-comment">// If position already has a point, keep the one with larger scale</span>
    <span class="hljs-keyword">const</span> existing = targets.<span class="hljs-title function_">get</span>(key);
    <span class="hljs-keyword">if</span> (!existing || point.<span class="hljs-property">scale</span> > existing.<span class="hljs-property">scale</span>) {
      targets.<span class="hljs-title function_">set</span>(key, {
        <span class="hljs-attr">x</span>: point.<span class="hljs-property">x</span>,
        <span class="hljs-attr">y</span>: point.<span class="hljs-property">y</span>,
        <span class="hljs-attr">z</span>: point.<span class="hljs-property">z</span>,
        <span class="hljs-attr">scale</span>: point.<span class="hljs-property">scale</span> * sphereScale,
      });
    }
  });

  <span class="hljs-comment">// Fill remaining grid positions with invisible spheres</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> gy = <span class="hljs-number">0</span>; gy &#x3C; gridSize; gy++) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> gx = <span class="hljs-number">0</span>; gx &#x3C; gridSize; gx++) {
      <span class="hljs-keyword">const</span> key = <span class="hljs-string">`<span class="hljs-subst">${gx}</span>,<span class="hljs-subst">${gy}</span>`</span>;
      <span class="hljs-keyword">if</span> (!targets.<span class="hljs-title function_">has</span>(key)) {
        targets.<span class="hljs-title function_">set</span>(key, {
          <span class="hljs-attr">x</span>: gx - gridSize / <span class="hljs-number">2</span>,
          <span class="hljs-attr">y</span>: gridSize / <span class="hljs-number">2</span> - gy,
          <span class="hljs-attr">z</span>: <span class="hljs-number">0</span>,
          <span class="hljs-attr">scale</span>: <span class="hljs-number">0</span>,
        });
      }
    }
  }

  <span class="hljs-keyword">return</span> targets;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> createHalftoneEditor;
</code></pre><h3 id="editor-demo">Editor Demo</h3><p>Try the editor below - load an image, adjust position/scale, orbit the camera, then export!
</p><pre class="src-block"><code class="hljs language-typescript"><span class="hljs-keyword">import</span> { createHalftoneEditor } <span class="hljs-keyword">from</span> <span class="hljs-string">'./halftone-spheres.org?name=halftone-editor'</span>;

<span class="hljs-keyword">const</span> editor = <span class="hljs-title function_">createHalftoneEditor</span>({
  <span class="hljs-attr">width</span>: <span class="hljs-number">800</span>,
  <span class="hljs-attr">height</span>: <span class="hljs-number">500</span>,
  <span class="hljs-attr">gridSize</span>: <span class="hljs-number">80</span>,
});

<span class="hljs-comment">// Pre-fill with a sample image</span>
<span class="hljs-keyword">const</span> urlInput = editor.<span class="hljs-property">container</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'input[type="text"]'</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLInputElement</span>;
<span class="hljs-keyword">if</span> (urlInput) {
  urlInput.<span class="hljs-property">value</span> = <span class="hljs-string">'/images/typewriter-machine.png'</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> editor.<span class="hljs-property">container</span>;
</code></pre><h2 id="colored-by-brightness">Colored by brightness</h2><pre class="src-block"><code class="hljs language-typescript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'three'</span>;

<span class="hljs-comment">/**
 * Halftone with color gradient based on brightness
 * (Stub - extend BackgroundHalftone for full implementation)
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createColoredHalftone</span>(<span class="hljs-params"><span class="hljs-attr">options</span>: {
  imageUrl: <span class="hljs-built_in">string</span>;
  gridSize?: <span class="hljs-built_in">number</span>;
  sphereScale?: <span class="hljs-built_in">number</span>;
  colorStart?: THREE.Color;
  colorEnd?: THREE.Color;
}</span>) {
  <span class="hljs-comment">// Use InstancedMesh with per-instance colors</span>
  <span class="hljs-comment">// Each sphere gets a color interpolated between colorStart and colorEnd</span>
  <span class="hljs-comment">// based on its size/brightness</span>
}
</code></pre><h2 id="animated-wave">Animated wave</h2><pre class="src-block"><code class="hljs language-typescript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'three'</span>;

<span class="hljs-comment">/**
 * Halftone with animated wave effect
 * Spheres oscillate in Z based on time and position
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">addWaveAnimation</span>(<span class="hljs-params">
  <span class="hljs-attr">instancedMesh</span>: THREE.<span class="hljs-title class_">InstancedMesh</span>,
  <span class="hljs-attr">spherePositions</span>: THREE.<span class="hljs-title class_">Vector3</span>[],
  amplitude = <span class="hljs-number">2</span>,
  frequency = <span class="hljs-number">0.1</span>
</span>) {
  <span class="hljs-keyword">const</span> matrix = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Matrix4</span>();

  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">time</span>: <span class="hljs-built_in">number</span></span>) =></span> {
    spherePositions.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">pos, i</span>) =></span> {
      <span class="hljs-keyword">const</span> z = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(pos.<span class="hljs-property">x</span> * frequency + time) *
                <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(pos.<span class="hljs-property">y</span> * frequency + time) * amplitude;
      matrix.<span class="hljs-title function_">setPosition</span>(pos.<span class="hljs-property">x</span>, pos.<span class="hljs-property">y</span>, z);
      instancedMesh.<span class="hljs-title function_">setMatrixAt</span>(i, matrix);
    });
    instancedMesh.<span class="hljs-property">instanceMatrix</span>.<span class="hljs-property">needsUpdate</span> = <span class="hljs-literal">true</span>;
  };
}
</code></pre></div></div></article></main><aside class="toc"><div class="toc-content"><h4 class="toc-title">On this page</h4><nav class="toc-nav" aria-label="Table of contents"><ul class="toc-list"><li class="toc-item "><a href="#image-url-helper" class="toc-link">Image URL Helper</a></li><li class="toc-item "><a href="#background-mode-scroll-driven" class="toc-link">Background Mode (Scroll-Driven)</a></li><li class="toc-item "><a href="#illustration-editor" class="toc-link">Illustration Editor</a></li><li class="toc-item toc-item-nested"><a href="#editor-demo" class="toc-link">Editor Demo</a></li><li class="toc-item "><a href="#colored-by-brightness" class="toc-link">Colored by brightness</a></li><li class="toc-item "><a href="#animated-wave" class="toc-link">Animated wave</a></li></ul></nav></div></aside></div><footer class="site-footer"><div class="footer-content"><div class="footer-grid"><div class="footer-column"><h4>Guide</h4><ul><li><a href="/guide/index.html">What is Org-Press?</a></li><li><a href="/guide/getting-started.html">Getting Started</a></li><li><a href="/guide/features.html">Features</a></li><li><a href="/guide/cli.html">CLI Reference</a></li><li><a href="/guide/building.html">Building</a></li></ul></div><div class="footer-column"><h4>Config</h4><ul><li><a href="/config/index.html">Overview</a></li><li><a href="/config/shared-options.html">Shared Options</a></li><li><a href="/config/build-options.html">Build Options</a></li><li><a href="/config/server-options.html">Server Options</a></li></ul></div><div class="footer-column"><h4>Plugins</h4><ul><li><a href="/plugins/index.html">Overview</a></li><li><a href="/plugins/excalidraw.html">Excalidraw</a></li><li><a href="/plugins/jscad.html">JSCAD</a></li><li><a href="/plugins/creating-plugins.html">Creating Plugins</a></li></ul></div><div class="footer-column"><h4>API</h4><ul><li><a href="/api/index.html">Overview</a></li><li><a href="/api/plugin-api.html">Plugin API</a></li><li><a href="/api/javascript-api.html">JavaScript API</a></li></ul></div><div class="footer-column"><h4>Resources</h4><ul><li><a href="/examples/index.html">Examples</a></li><li><a href="https://github.com/org-press/org-press" target="_blank" rel="noopener">GitHub</a></li><li><a href="https://github.com/org-press/org-press/releases" target="_blank" rel="noopener">Releases</a></li></ul></div></div><div class="footer-bottom"><p class="footer-copyright">Released under the GPL-2.0 License.</p><p class="footer-credit">Built with <a href="https://github.com/org-press/org-press">org-press</a></p></div></div></footer></div><script src="https://analytics.ideable.dev/api/script.js" data-site-id="5dc60eeeac5d" defer=""></script></body></html>